document.addEventListener("DOMContentLoaded",()=>{if(function(){const e=document.querySelectorAll(".mapbox-location-input-v2").length>0,o=null!==document.getElementById("nexus-mapbox-direct-container");return e||o}()&&!e()){let o=0;const t=50,n=setInterval(()=>{o++,(e()||o>=t)&&(clearInterval(n),o>=t&&console.warn("Project NEXUS Mapbox: Timed out waiting for Mapbox to load"))},100)}function e(){if("undefined"==typeof mapboxgl||"undefined"==typeof MapboxGeocoder)return!1;const e=window.NEXUS_MAPBOX_TOKEN?window.NEXUS_MAPBOX_TOKEN.trim():"";return console.log("Project NEXUS Mapbox: Initializing..."),e?(console.log("Project NEXUS Mapbox: Token Found. Length: "+e.length),mapboxgl.accessToken=e,function(){const e=document.querySelectorAll(".mapbox-location-input-v2");console.log(`Project NEXUS Mapbox: Found ${e.length} inputs.`),e.forEach(e=>{if(!e.dataset.mapboxInitialized){e.dataset.mapboxInitialized="true";try{const o=document.createElement("div");o.className="mapbox-geocoder-container",e.parentNode.insertBefore(o,e),e.classList.add("hidden"),e.type="hidden";const t=new MapboxGeocoder({accessToken:mapboxgl.accessToken,types:"place,locality,neighborhood",placeholder:e.placeholder||"Search for a location...",mapboxgl:mapboxgl,marker:!1,proximity:"ip",language:"en"});o.appendChild(t.onAdd()),e.value&&t.setInput(e.value),t.on("result",o=>{if(o.result&&o.result.place_name&&(e.value=o.result.place_name,o.result.center)){const t=o.result.center[0],n=o.result.center[1],a=e.closest("form");if(a){const e=a.querySelector('input[name="latitude"]'),o=a.querySelector('input[name="longitude"]');e&&(e.value=n),o&&(o.value=t)}}}),t.on("clear",()=>{e.value="";const o=e.closest("form");if(o){const e=o.querySelector('input[name="latitude"]'),t=o.querySelector('input[name="longitude"]');e&&(e.value=""),t&&(t.value="")}})}catch(o){console.error("Project NEXUS Mapbox Error:",o),e.classList.remove("hidden")}}})}(),function(){const e=document.getElementById("nexus-mapbox-direct-container");if(e&&!e.dataset.mapboxInitialized){e.dataset.mapboxInitialized="true",console.log("Project NEXUS Mapbox: Direct Container Found. Initializing v3 Logic.");try{const o=new MapboxGeocoder({accessToken:mapboxgl.accessToken,types:"place,locality,neighborhood",placeholder:e.dataset.placeholder||"Search for a location...",mapboxgl:mapboxgl,marker:!1,proximity:"ip",language:"en"});e.innerHTML="",e.appendChild(o.onAdd());const t=document.getElementById("location-value"),n=t?t.value:"";if(n&&"Remote"!==n){const o=e.querySelector(".mapboxgl-ctrl-geocoder--input");o&&(o.value=n);const t=e.querySelector("input");t&&(t.value=n)}o.on("result",e=>{if(e.result){const o=document.getElementById("location-value"),t=document.getElementById("latitude"),n=document.getElementById("longitude");o&&(o.value=e.result.place_name),e.result.center&&(t&&(t.value=e.result.center[1]),n&&(n.value=e.result.center[0]))}}),o.on("clear",()=>{const e=document.getElementById("location-value"),o=document.getElementById("latitude"),t=document.getElementById("longitude");e&&(e.value=""),o&&(o.value=""),t&&(t.value="")});const a=e.querySelector(".mapboxgl-ctrl-geocoder");a&&a.classList.add("nexus-mapbox-geocoder-override");const l=e.querySelector("input");l&&l.classList.add("nexus-mapbox-input-override")}catch(o){console.error("Project NEXUS Mapbox v3 Error:",o),e.innerHTML='<input type="text" name="location_fallback" placeholder="Error loading map. Type location manually." style="width:100%; padding:15px; border-radius:12px; border:1px solid #ccc;">'}}}(),!0):(console.error("Project NEXUS: Mapbox Token is MISSING."),!0)}});