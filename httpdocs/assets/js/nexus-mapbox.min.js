document.addEventListener("DOMContentLoaded",()=>{if(function(){const e=document.querySelectorAll(".mapbox-location-input-v2").length>0,t=null!==document.getElementById("nexus-mapbox-direct-container");return e||t}()&&!e()){let t=0;const o=50,n=setInterval(()=>{t++,(e()||t>=o)&&(clearInterval(n),t>=o&&console.warn("Project NEXUS Mapbox: Timed out waiting for Mapbox to load"))},100)}function e(){if("undefined"==typeof mapboxgl||"undefined"==typeof MapboxGeocoder)return!1;const e=window.NEXUS_MAPBOX_TOKEN?window.NEXUS_MAPBOX_TOKEN.trim():"";return console.log("Project NEXUS Mapbox: Initializing..."),e?(console.log("Project NEXUS Mapbox: Token Found. Length: "+e.length),mapboxgl.accessToken=e,function(){const e=document.querySelectorAll(".mapbox-location-input-v2");console.log(`Project NEXUS Mapbox: Found ${e.length} inputs.`),e.forEach(e=>{if(!e.dataset.mapboxInitialized){e.dataset.mapboxInitialized="true";try{const t=document.createElement("div");t.className="mapbox-geocoder-container",e.parentNode.insertBefore(t,e),e.style.display="none",e.type="hidden";const o=new MapboxGeocoder({accessToken:mapboxgl.accessToken,types:"place,locality,neighborhood",placeholder:e.placeholder||"Search for a location...",mapboxgl:mapboxgl,marker:!1,proximity:"ip",language:"en"});t.appendChild(o.onAdd()),e.value&&o.setInput(e.value),o.on("result",t=>{if(t.result&&t.result.place_name&&(e.value=t.result.place_name,t.result.center)){const o=t.result.center[0],n=t.result.center[1],l=e.closest("form");if(l){const e=l.querySelector('input[name="latitude"]'),t=l.querySelector('input[name="longitude"]');e&&(e.value=n),t&&(t.value=o)}}}),o.on("clear",()=>{e.value="";const t=e.closest("form");if(t){const e=t.querySelector('input[name="latitude"]'),o=t.querySelector('input[name="longitude"]');e&&(e.value=""),o&&(o.value="")}})}catch(t){console.error("Project NEXUS Mapbox Error:",t),e.style.display="block",e.style.opacity="1"}}})}(),function(){const e=document.getElementById("nexus-mapbox-direct-container");if(e&&!e.dataset.mapboxInitialized){e.dataset.mapboxInitialized="true",console.log("Project NEXUS Mapbox: Direct Container Found. Initializing v3 Logic.");try{const t=new MapboxGeocoder({accessToken:mapboxgl.accessToken,types:"place,locality,neighborhood",placeholder:e.dataset.placeholder||"Search for a location...",mapboxgl:mapboxgl,marker:!1,proximity:"ip",language:"en"});e.innerHTML="",e.appendChild(t.onAdd());const o=document.getElementById("location-value"),n=o?o.value:"";if(n&&"Remote"!==n){const t=e.querySelector(".mapboxgl-ctrl-geocoder--input");t&&(t.value=n);const o=e.querySelector("input");o&&(o.value=n)}t.on("result",e=>{if(e.result){const t=document.getElementById("location-value"),o=document.getElementById("latitude"),n=document.getElementById("longitude");t&&(t.value=e.result.place_name),e.result.center&&(o&&(o.value=e.result.center[1]),n&&(n.value=e.result.center[0]))}}),t.on("clear",()=>{const e=document.getElementById("location-value"),t=document.getElementById("latitude"),o=document.getElementById("longitude");e&&(e.value=""),t&&(t.value=""),o&&(o.value="")});const l=e.querySelector(".mapboxgl-ctrl-geocoder");l&&(l.style.boxShadow="none",l.style.background="transparent",l.style.width="100%",l.style.maxWidth="100%");const a=e.querySelector("input");a&&(a.style.boxShadow="none",a.style.background="transparent",a.style.width="100%",a.style.height="100%",a.style.padding="15px")}catch(t){console.error("Project NEXUS Mapbox v3 Error:",t),e.innerHTML='<input type="text" name="location_fallback" placeholder="Error loading map. Type location manually." style="width:100%; padding:15px; border-radius:12px; border:1px solid #ccc;">'}}}(),!0):(console.error("Project NEXUS: Mapbox Token is MISSING."),!0)}});