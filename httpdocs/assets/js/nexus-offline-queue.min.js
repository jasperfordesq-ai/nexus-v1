window.NexusOffline=function(){"use strict";function e(){return new Promise((e,n)=>{const t=indexedDB.open("nexus-offline-queue",1);t.onerror=()=>n(t.error),t.onsuccess=()=>e(t.result),t.onupgradeneeded=e=>{const n=e.target.result;if(!n.objectStoreNames.contains("messages")){n.createObjectStore("messages",{keyPath:"id",autoIncrement:!0}).createIndex("timestamp","timestamp")}if(!n.objectStoreNames.contains("transactions")){n.createObjectStore("transactions",{keyPath:"id",autoIncrement:!0}).createIndex("timestamp","timestamp")}if(!n.objectStoreNames.contains("forms")){n.createObjectStore("forms",{keyPath:"id",autoIncrement:!0}).createIndex("timestamp","timestamp")}}})}async function n(n,t){const o=await e();return new Promise((e,i)=>{const a=o.transaction(n,"readwrite").objectStore(n).add({...t,timestamp:Date.now()});a.onsuccess=()=>e(a.result),a.onerror=()=>i(a.error)})}async function t(n){const t=await e();return new Promise((e,o)=>{const i=t.transaction(n,"readonly").objectStore(n).count();i.onsuccess=()=>e(i.result),i.onerror=()=>o(i.error)})}async function o(n){const t=await e();return new Promise((e,o)=>{const i=t.transaction(n,"readonly").objectStore(n).getAll();i.onsuccess=()=>e(i.result),i.onerror=()=>o(i.error)})}async function i(e){if("serviceWorker"in navigator&&"sync"in window.SyncManager){const n=await navigator.serviceWorker.ready;return await n.sync.register(e),console.log("[OfflineQueue] Registered sync:",e),!0}return!1}async function a(e,n){if("serviceWorker"in navigator){const t=await navigator.serviceWorker.ready;if(t.active)return t.active.postMessage({type:e,payload:n}),!0}return!1}async function s(e,t,o=null){const s={recipientId:e,content:t,conversationId:o,queuedAt:(new Date).toISOString()},r=await n("messages",s);return console.log("[OfflineQueue] Queued message:",r),await a("QUEUE_MESSAGE",s),await i("sync-messages"),u("Message queued - will send when online"),r}async function r(e,t,o,s=null){const r={recipientId:e,amount:t,description:o,listingId:s,queuedAt:(new Date).toISOString()},c=await n("transactions",r);return console.log("[OfflineQueue] Queued transaction:",c),await a("QUEUE_TRANSACTION",r),await i("sync-transactions"),u("Transaction queued - will process when online"),c}async function c(e,t,o="POST"){const s={url:e,data:t,method:o,queuedAt:(new Date).toISOString()},r=await n("forms",s);return console.log("[OfflineQueue] Queued form:",r),await a("QUEUE_FORM",s),await i("sync-forms"),u("Form saved - will submit when online"),r}function u(e){if(window.NexusMobile&&window.NexusMobile.showToast)return void window.NexusMobile.showToast(e,"warning");if(window.CivicOneMobile&&window.CivicOneMobile.showToast)return void window.CivicOneMobile.showToast(e,"warning");const n=document.createElement("div");n.className="offline-queue-toast",n.innerHTML=`\n            <i class="fas fa-cloud-upload-alt"></i>\n            <span>${e}</span>\n        `,n.style.cssText="\n            position: fixed;\n            bottom: 80px;\n            left: 50%;\n            transform: translateX(-50%);\n            background: #f59e0b;\n            color: #000;\n            padding: 12px 20px;\n            border-radius: 8px;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n            z-index: 10000;\n            font-size: 14px;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n            animation: slideUp 0.3s ease;\n        ",document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideDown 0.3s ease",setTimeout(()=>n.remove(),300)},3e3)}async function l(){const[e,n,o]=await Promise.all([t("messages"),t("transactions"),t("forms")]);return{messages:e,transactions:n,forms:o,total:e+n+o}}async function d(){const e=await l();if(e.total>0){let n=document.getElementById("offline-queue-badge");n||(n=document.createElement("div"),n.id="offline-queue-badge",n.style.cssText="\n                    position: fixed;\n                    top: 70px;\n                    right: 10px;\n                    background: #f59e0b;\n                    color: #000;\n                    padding: 6px 12px;\n                    border-radius: 20px;\n                    font-size: 12px;\n                    font-weight: 600;\n                    z-index: 9999;\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                    cursor: pointer;\n                ",n.onclick=()=>f(),document.body.appendChild(n)),n.innerHTML=`<i class="fas fa-clock"></i> ${e.total} pending`}else{const e=document.getElementById("offline-queue-badge");e&&e.remove()}}async function f(){await l();const[e,n,t]=await Promise.all([o("messages"),o("transactions"),o("forms")]),i=document.createElement("div");i.className="offline-queue-modal",i.innerHTML=`\n            <div class="offline-queue-modal-content">\n                <h3>Pending Offline Actions</h3>\n                <p>These will be sent when you're back online:</p>\n\n                ${e.length>0?`\n                    <div class="queue-section">\n                        <h4><i class="fas fa-envelope"></i> Messages (${e.length})</h4>\n                        <ul>\n                            ${e.map(e=>`<li>To: User #${e.recipientId}</li>`).join("")}\n                        </ul>\n                    </div>\n                `:""}\n\n                ${n.length>0?`\n                    <div class="queue-section">\n                        <h4><i class="fas fa-coins"></i> Transactions (${n.length})</h4>\n                        <ul>\n                            ${n.map(e=>`<li>${e.amount} credits to User #${e.recipientId}</li>`).join("")}\n                        </ul>\n                    </div>\n                `:""}\n\n                ${t.length>0?`\n                    <div class="queue-section">\n                        <h4><i class="fas fa-file-alt"></i> Forms (${t.length})</h4>\n                        <ul>\n                            ${t.map(e=>`<li>${e.url}</li>`).join("")}\n                        </ul>\n                    </div>\n                `:""}\n\n                <button class="close-modal-btn" onclick="this.closest('.offline-queue-modal').remove()">Close</button>\n            </div>\n        `,i.style.cssText="\n            position: fixed;\n            inset: 0;\n            background: rgba(0,0,0,0.7);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 10001;\n            padding: 20px;\n        ";const a=document.createElement("style");a.textContent="\n            .offline-queue-modal-content {\n                background: #1e293b;\n                border-radius: 12px;\n                padding: 20px;\n                max-width: 400px;\n                width: 100%;\n                color: #f1f5f9;\n            }\n            .offline-queue-modal-content h3 { margin: 0 0 10px 0; color: #f59e0b; }\n            .offline-queue-modal-content p { margin: 0 0 15px 0; color: #94a3b8; }\n            .queue-section { margin-bottom: 15px; }\n            .queue-section h4 { font-size: 14px; margin: 0 0 8px 0; }\n            .queue-section ul { margin: 0; padding-left: 20px; }\n            .queue-section li { font-size: 13px; color: #94a3b8; }\n            .close-modal-btn {\n                width: 100%;\n                padding: 12px;\n                background: #334155;\n                border: none;\n                border-radius: 8px;\n                color: #f1f5f9;\n                cursor: pointer;\n                margin-top: 15px;\n            }\n        ",i.appendChild(a),document.body.appendChild(i)}if("undefined"!=typeof window){const e=document.createElement("style");e.textContent="\n            @keyframes slideUp {\n                from { transform: translate(-50%, 100%); opacity: 0; }\n                to { transform: translate(-50%, 0); opacity: 1; }\n            }\n            @keyframes slideDown {\n                from { transform: translate(-50%, 0); opacity: 1; }\n                to { transform: translate(-50%, 100%); opacity: 0; }\n            }\n        ",document.head.appendChild(e),document.addEventListener("DOMContentLoaded",d),window.addEventListener("online",()=>{console.log("[OfflineQueue] Back online, triggering sync..."),d()}),setInterval(d,3e4)}return{queueMessage:s,queueTransaction:r,queueForm:c,fetchWithOfflineQueue:async function(e,n={},t="forms"){if(navigator.onLine)try{const t=await fetch(e,n);if(t.ok)return t}catch(e){console.log("[OfflineQueue] Fetch failed, queuing...")}if("POST"===n.method||"PUT"===n.method){let o;try{o=n.body?JSON.parse(n.body):{}}catch(e){o={raw:n.body}}return"messages"===t?await s(o.recipient_id,o.content,o.conversation_id):"transactions"===t?await r(o.recipient_id,o.amount,o.description,o.listing_id):await c(e,o,n.method),new Response(JSON.stringify({queued:!0,offline:!0}),{status:202,headers:{"Content-Type":"application/json"}})}throw new Error("Cannot queue GET requests")},getQueueStatus:l,getPendingItems:o,isOffline:function(){return!navigator.onLine},updateQueueBadge:d,showQueueDetails:f}}();