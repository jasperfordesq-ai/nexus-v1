async function checkBiometricSupport(){const e=document.getElementById("biometric-login-container"),t=document.getElementById("biometric-promo");if(window.PublicKeyCredential)try{if(!await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable())return;try{const a=await fetch("/api/webauthn/auth-challenge",{method:"POST",credentials:"include"});if(a.ok){const r=await a.json();r.allowCredentials&&r.allowCredentials.length>0?(e&&(e.style.display="block"),t&&(t.style.display="none")):(e&&(e.style.display="none"),t&&(t.style.display="block"))}else t&&(t.style.display="block")}catch(e){t&&(t.style.display="block")}}catch(e){console.log("[WebAuthn] Biometric check failed:",e)}}async function attemptBiometricLogin(){const e=document.getElementById("biometric-login-btn"),t=e.innerHTML;try{if(e.disabled=!0,e.innerHTML="<span>Authenticating...</span>",window.NexusPWA&&NexusPWA.Biometric){const e=await NexusPWA.Biometric.authenticate();e&&e.redirect?window.location.href=e.redirect:e&&e.success&&window.location.reload()}else{const e=await fetch("/api/webauthn/auth-challenge",{method:"POST",credentials:"include"});if(!e.ok)throw new Error("No biometric credentials found. Please login with password first.");const t=await e.json();t.challenge=base64ToArrayBuffer(t.challenge),t.allowCredentials&&(t.allowCredentials=t.allowCredentials.map(e=>({...e,id:base64ToArrayBuffer(e.id)})));const a=await navigator.credentials.get({publicKey:t}),r=await fetch("/api/webauthn/auth-verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:a.id,rawId:arrayBufferToBase64(a.rawId),type:a.type,response:{clientDataJSON:arrayBufferToBase64(a.response.clientDataJSON),authenticatorData:arrayBufferToBase64(a.response.authenticatorData),signature:arrayBufferToBase64(a.response.signature),userHandle:a.response.userHandle?arrayBufferToBase64(a.response.userHandle):null}}),credentials:"include"});if(!r.ok)throw new Error("Biometric verification failed");{const e=await r.json();window.location.href=e.redirect||"/dashboard"}}}catch(a){console.error("[Biometric]",a),e.innerHTML=t,e.disabled=!1,"NotAllowedError"!==a.name&&alert(a.message||"Biometric login failed. Please use password.")}}function base64ToArrayBuffer(e){const t=window.atob(e.replace(/-/g,"+").replace(/_/g,"/")),a=new Uint8Array(t.length);for(let e=0;e<t.length;e++)a[e]=t.charCodeAt(e);return a.buffer}function arrayBufferToBase64(e){const t=new Uint8Array(e);let a="";for(let e=0;e<t.length;e++)a+=String.fromCharCode(t[e]);return window.btoa(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",checkBiometricSupport):checkBiometricSupport();