(()=>{class e{constructor(){this.currentLayout=document.documentElement.getAttribute("data-layout")||"modern",this.switching=!1,this.endpoint="/api/layout-switch.php",this.init()}init(){document.addEventListener("click",t=>{var e=t.target.closest("[data-layout-switcher]");e&&(t.preventDefault(),t=e.dataset.layoutSwitcher,this.switchLayout(t))}),document.addEventListener("nexus:switchLayout",t=>{this.switchLayout(t.detail.layout)}),this.cleanUrlParams(),this.ensureLayoutAttribute(),this.addTransitionGuard()}async switchLayout(t){if(!this.switching&&t!==this.currentLayout){this.switching=!0,this.showLoadingState();try{var e=await(await fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({layout:t})})).json();e.success?(this.currentLayout=t,sessionStorage.setItem("nexus_layout_switching","true"),document.dispatchEvent(new CustomEvent("nexus:layoutChanged",{detail:{layout:t}})),setTimeout(()=>{window.location.replace(this.cleanUrl(window.location.href))},200)):(console.error("Layout switch failed:",e.message),this.showError(e.message||"Failed to switch layout"))}catch(t){console.error("Layout switch error:",t),this.showError("Failed to switch layout. Please try again.")}finally{this.switching=!1}}}cleanUrl(t){t=new URL(t);return t.searchParams.delete("layout"),t.searchParams.delete("_refresh"),t.toString()}cleanUrlParams(){var t=new URLSearchParams(window.location.search);(t.has("layout")||t.has("_refresh"))&&(t.delete("layout"),t.delete("_refresh"),t=window.location.pathname+(t.toString()?"?"+t.toString():"")+window.location.hash,window.history)&&window.history.replaceState&&window.history.replaceState({},"",t)}showLoadingState(){document.body.classList.add("layout-switching");let t=document.createElement("div");t.className="layout-switch-overlay",t.innerHTML=`
                <div class="layout-switch-spinner">
                    <div class="spinner-ring"></div>
                    <p>Switching layout...</p>
                </div>
            `,document.body.appendChild(t),requestAnimationFrame(()=>{t.classList.add("visible")})}showError(t){document.body.classList.remove("layout-switching");var e=document.querySelector(".layout-switch-overlay");e&&e.remove(),window.toast&&"function"==typeof window.toast.error?window.toast.error(t):alert(t)}ensureLayoutAttribute(){document.documentElement.getAttribute("data-layout")||document.documentElement.setAttribute("data-layout","modern")}addTransitionGuard(){var t;sessionStorage.getItem("nexus_layout_switching")&&(sessionStorage.removeItem("nexus_layout_switching"),document.body.classList.add("layout-transition-guard"),t=()=>{setTimeout(()=>{document.body.classList.add("loaded")},150)},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t())}getCurrentLayout(){return this.currentLayout}}var t=()=>{var t;(t=document.createElement("style")).textContent=`
            .layout-switch-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(8px);
                z-index: 99999;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .layout-switch-overlay.visible {
                opacity: 1;
            }

            .layout-switch-spinner {
                text-align: center;
                color: white;
            }

            .spinner-ring {
                width: 48px;
                height: 48px;
                margin: 0 auto 16px;
                border: 3px solid rgba(255, 255, 255, 0.2);
                border-top-color: white;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            .layout-switch-spinner p {
                font-size: 14px;
                font-weight: 500;
                margin: 0;
            }

            body.layout-switching {
                overflow: hidden;
                pointer-events: none;
            }

            /* Smooth transition guard */
            .layout-transition-guard {
                opacity: 0;
                transition: opacity 0.2s ease-out;
            }

            .layout-transition-guard.loaded {
                opacity: 1;
            }
        `,document.head.appendChild(t),"fetch"in window&&"Promise"in window?window.layoutSwitcher=new e:console.warn("LayoutSwitcher requires modern browser with fetch API")};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t(),"undefined"!=typeof module&&module.exports&&(module.exports=e)})();