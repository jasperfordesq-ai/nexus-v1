!function(){"use strict";window.NexusTurbo={config:{cacheSize:10,transitionDuration:200,prefetchDelay:100,excludeSelectors:['[data-turbo="false"]','[target="_blank"]',"[download]",'a[href^="mailto:"]','a[href^="tel:"]','a[href^="#"]','a[href^="javascript:"]','a[href*="logout"]','form[data-turbo="false"]']},cache:new Map,cacheOrder:[],isNavigating:!1,currentUrl:window.location.href,abortController:null,init:function(){if(document.startViewTransition&&!this.config.forceCustomTransitions)return console.log("[NexusTurbo] Using native View Transitions API"),void this.initNativeTransitions();this.bindEvents(),this.cacheCurrentPage(),this.setupProgressBar(),console.log("[NexusTurbo] Initialized with custom transitions")},initNativeTransitions:function(){document.addEventListener("click",t=>{const e=t.target.closest("a[href]");if(!e||this.shouldExclude(e))return;const n=e.getAttribute("href");if(!this.isInternalLink(n))return;t.preventDefault();const o=document.querySelector("main#main-content");o&&(o.style.viewTransitionName="none"),document.startViewTransition(async()=>{await this.fetchAndReplace(n),window.history.pushState({},"",n);const t=document.querySelector("main#main-content");t&&(t.style.viewTransitionName="")})}),window.addEventListener("popstate",()=>{const t=document.querySelector("main#main-content");t&&(t.style.viewTransitionName="none"),document.startViewTransition(()=>{this.fetchAndReplace(window.location.href);const t=document.querySelector("main#main-content");t&&(t.style.viewTransitionName="")})})},bindEvents:function(){document.addEventListener("click",t=>this.handleClick(t)),document.addEventListener("submit",t=>this.handleSubmit(t)),document.addEventListener("mouseover",t=>this.handleHover(t)),document.addEventListener("touchstart",t=>this.handleHover(t),{passive:!0}),window.addEventListener("popstate",t=>this.handlePopState(t))},handleClick:function(t){const e=t.target.closest("a[href]");if(!e)return;if(this.shouldExclude(e))return;const n=e.getAttribute("href");this.isInternalLink(n)&&(t.preventDefault(),this.navigate(n,{pushState:!0}))},handleSubmit:function(t){const e=t.target;if(this.shouldExclude(e))return;if(!e.method||"get"!==e.method.toLowerCase())return;t.preventDefault();const n=new FormData(e),o=new URLSearchParams(n),i=e.action+"?"+o.toString();this.navigate(i,{pushState:!0})},handleHover:function(t){const e=t.target.closest("a[href]");if(!e||this.shouldExclude(e))return;const n=e.getAttribute("href");this.isInternalLink(n)&&(clearTimeout(e._prefetchTimeout),e._prefetchTimeout=setTimeout(()=>{this.prefetch(n)},this.config.prefetchDelay))},handlePopState:function(t){this.navigate(window.location.href,{pushState:!1})},async navigate(t,e={}){this.isNavigating&&this.abortController&&this.abortController.abort(),this.isNavigating=!0,this.showProgress(),window.NexusMobile&&NexusMobile.haptic("light");try{const n=this.cache.get(t),o=t.includes("/members");if(n&&!o&&Date.now()-n.timestamp<3e4)return void await this.transitionTo(n.html,t,e);const i=await this.fetchPage(t);i&&(this.cachePage(t,i),await this.transitionTo(i,t,e))}catch(e){"AbortError"!==e.name&&(console.error("[NexusTurbo] Navigation failed:",e),window.location.href=t)}finally{this.isNavigating=!1,this.hideProgress()}},async fetchPage(t){this.abortController=new AbortController;const e=await fetch(t,{signal:this.abortController.signal,headers:{"X-Requested-With":"NexusTurbo",Accept:"text/html"}});if(!e.ok)throw new Error(`HTTP ${e.status}`);return await e.text()},async fetchAndReplace(t){const e=await this.fetchPage(t);await this.replaceContent(e),this.currentUrl=t},async transitionTo(t,e,n){const o=this.getContentElement();o&&(o.style.opacity="0",o.style.transform="translateX(-20px)",await this.sleep(this.config.transitionDuration/2)),this.replaceContent(t),n.pushState&&window.history.pushState({turbo:!0},"",e),this.currentUrl=e;const i=this.getContentElement();i&&(i.style.opacity="0",i.style.transform="translateX(20px)",i.style.transition=`all ${this.config.transitionDuration}ms ease-out`,requestAnimationFrame(()=>{i.style.opacity="1",i.style.transform="translateX(0)"})),window.scrollTo({top:0,behavior:"instant"}),document.dispatchEvent(new CustomEvent("turbo:load",{detail:{url:e}}))},replaceContent:async function(t){const e=(new DOMParser).parseFromString(t,"text/html"),n=e.querySelector("title");n&&(document.title=n.textContent),this.updateMetaTags(e);const o=e.body,i=document.body,r=i.querySelector(".nexus-bottom-nav"),s=i.querySelector(".nexus-toast-container"),a=i.querySelector(".nexus-loading-overlay");i.innerHTML=o.innerHTML,r&&i.appendChild(r),s&&i.appendChild(s),a&&i.appendChild(a);["messages-page","messages-fullscreen","no-ptr","chat-page"].forEach(t=>{document.documentElement.classList.remove(t),i.classList.remove(t)}),document.documentElement.style.overflow="",i.style.overflow="",Array.from(o.attributes).forEach(t=>{i.setAttribute(t.name,t.value)});const c=e.documentElement;if(c.className){const t=["dark","light","content-loaded","loading"],e=Array.from(document.documentElement.classList).filter(e=>t.includes(e));document.documentElement.className=c.className,e.forEach(t=>document.documentElement.classList.add(t))}await this.executeScripts(i),this.reinitializeComponents()},executeScripts:async function(t){const e=t.querySelectorAll("script:not([data-turbo-permanent])"),n=[],o=[];e.forEach(t=>{t.src?n.push(t):t.textContent&&t.textContent.trim()&&o.push(t)});for(const t of n)try{const e=new URL(t.src,window.location.origin).pathname.split("?")[0];if(Array.from(document.querySelectorAll("script[src]")).find(t=>{try{return new URL(t.src,window.location.origin).pathname.split("?")[0]===e}catch{return!1}}))continue;await this.loadExternalScript(t)}catch(e){console.warn("[NexusTurbo] External script load failed:",t.src,e.message)}for(const t of o){const e=t.textContent||"";if(!["NexusNotifications","NexusMobile","NexusNative","NexusTurbo","NexusMapbox","SkeletonLoader","OptimisticUI","EnhancedTransitions","IS_LOGGED_IN","NEXUS_MAPBOX_TOKEN","NEXUS_VAPID_PUBLIC_KEY"].some(t=>[`const ${t}`,`let ${t}`,`var ${t}`,`class ${t}`,`window.${t}`].some(t=>e.includes(t))))try{const n=document.createElement("script");Array.from(t.attributes).forEach(t=>{n.setAttribute(t.name,t.value)});let o=e;o=e.includes("const ")||e.includes("let ")?`(function() {\n                            try { ${e} }\n                            catch(e) { console.warn('[Script Error]', e.message); }\n                        })();`:`try { ${e} } catch(e) { console.warn('[Script Error]', e.message); }`,n.textContent=o,t.parentNode.replaceChild(n,t)}catch(t){console.warn("[NexusTurbo] Script execution skipped:",t.message)}}},loadExternalScript:function(t){return new Promise((e,n)=>{const o=document.createElement("script");Array.from(t.attributes).forEach(t=>{o.setAttribute(t.name,t.value)}),o.onload=()=>e(),o.onerror=n=>{console.warn("[NexusTurbo] Script load error (continuing):",t.src),e()};const i=setTimeout(()=>{console.warn("[NexusTurbo] Script load timeout (continuing):",t.src),e()},5e3);o.onload=()=>{clearTimeout(i),e()},document.head.appendChild(o)})},reinitializeComponents:function(){window.NexusMobile&&NexusMobile.initBottomNav(),window.nexusNotifications},updateMetaTags:function(t){const e=t.querySelector('meta[name="theme-color"]'),n=document.querySelector('meta[name="theme-color"]');e&&n&&(n.content=e.content)},prefetch:function(t){this.cache.has(t)||fetch(t,{headers:{"X-Requested-With":"NexusTurbo"}}).then(t=>t.text()).then(e=>this.cachePage(t,e)).catch(()=>{})},cachePage:function(t,e){if(this.cacheOrder.length>=this.config.cacheSize){const t=this.cacheOrder.shift();this.cache.delete(t)}this.cache.set(t,{html:e,timestamp:Date.now()}),this.cacheOrder.push(t)},cacheCurrentPage:function(){this.cachePage(window.location.href,document.documentElement.outerHTML)},setupProgressBar:function(){const t=document.createElement("div");t.id="nexus-turbo-progress",t.innerHTML="\n                <style>\n                    #nexus-turbo-progress {\n                        position: fixed;\n                        top: 0;\n                        left: 0;\n                        width: 0;\n                        height: 3px;\n                        background: linear-gradient(90deg, #6366f1, #8b5cf6, #ec4899);\n                        z-index: 99999;\n                        transition: width 0.2s ease-out;\n                        box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);\n                    }\n                    #nexus-turbo-progress.active {\n                        animation: turboProgress 2s ease-in-out infinite;\n                    }\n                    @keyframes turboProgress {\n                        0% { width: 0; }\n                        50% { width: 70%; }\n                        100% { width: 90%; }\n                    }\n                </style>\n            ",document.body.appendChild(t)},showProgress:function(){const t=document.getElementById("nexus-turbo-progress");t&&t.classList.add("active")},hideProgress:function(){const t=document.getElementById("nexus-turbo-progress");t&&(t.style.width="100%",setTimeout(()=>{t.classList.remove("active"),t.style.width="0"},200))},getContentElement:function(){return document.querySelector("main")||document.querySelector(".htb-container")||document.querySelector(".htb-container-full")||document.body},shouldExclude:function(t){return this.config.excludeSelectors.some(e=>t.matches(e))},isInternalLink:function(t){if(!t)return!1;if(t.startsWith("#"))return!1;if(t.startsWith("javascript:"))return!1;try{return new URL(t,window.location.origin).origin===window.location.origin}catch{return!1}},sleep:function(t){return new Promise(e=>setTimeout(e,t))}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>NexusTurbo.init()):NexusTurbo.init()}();