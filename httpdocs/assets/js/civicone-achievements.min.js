function openBadgeModal(e){const t=document.getElementById("badgeModal");if(!t)return;document.getElementById("badgeModalHeader");const n=document.getElementById("badgeModalIcon"),a=document.getElementById("badgeModalName"),o=document.getElementById("badgeModalDesc"),s=document.getElementById("badgeModalDate"),c=document.getElementById("badgeModalRarity"),d=document.getElementById("badgeModalRarityText"),i=document.getElementById("badgeModalRarityBar"),l=e.dataset.badgeName||"Badge",r=e.dataset.badgeIcon||"üèÜ",m=e.dataset.badgeDesc||"earning this achievement",u=e.dataset.badgeDate||"Unknown",y=e.dataset.badgeRarity||"Common",f=parseFloat(e.dataset.badgePercent)||100;if(n&&(n.textContent=r),a&&(a.textContent=l),o&&(o.textContent=m.charAt(0).toUpperCase()+m.slice(1)),s&&(s.textContent=u),c){const e=y.toLowerCase();c.className="badge-rarity-tag "+e,c.innerHTML=getRarityIcon(e)+" "+y}if(d&&(d.textContent=f<=1?`Only ${f.toFixed(1)}% of members have this badge`:f<=5?`Top ${f.toFixed(1)}% of members`:f<=15?`${f.toFixed(1)}% of members have earned this`:f<=40?`Earned by ${f.toFixed(0)}% of active members`:`A common achievement (${f.toFixed(0)}% have it)`),i){const e=y.toLowerCase();i.className="badge-rarity-fill "+e,i.style.width="0%"}t.classList.add("visible"),document.body.style.overflow="hidden";const g=document.querySelector(".nexus-navbar");g&&(g.style.display="none");const h=document.querySelector(".mobile-tab-bar");h&&(h.style.display="none"),i&&setTimeout(()=>{const e=Math.max(5,100-f);i.style.width=e+"%"},100),navigator.vibrate&&navigator.vibrate(10)}function getRarityIcon(e){switch(e){case"legendary":return'<i class="fa-solid fa-crown"></i>';case"epic":return'<i class="fa-solid fa-gem"></i>';case"rare":return'<i class="fa-solid fa-star"></i>';case"uncommon":return'<i class="fa-solid fa-circle-up"></i>';default:return'<i class="fa-solid fa-circle"></i>'}}function closeBadgeModal(){const e=document.getElementById("badgeModal");if(!e)return;const t=e.querySelector(".badge-modal-content"),n=document.querySelector(".nexus-navbar");n&&(n.style.display="");const a=document.querySelector(".mobile-tab-bar");a&&(a.style.display=""),window.innerWidth<=640&&t?(t.classList.add("closing"),setTimeout(()=>{e.classList.remove("visible"),t.classList.remove("closing"),document.body.style.overflow=""},200)):(e.classList.remove("visible"),document.body.style.overflow="")}function closeBadgeModalOnBackdrop(e){e.target===e.currentTarget&&closeBadgeModal()}function toggleShowcase(e,t,n,a){const o=document.getElementById("showcase-form");if(!o)return;const s=o.querySelectorAll(".showcase-badge-slot"),c=document.getElementById("save-showcase"),d=o.querySelector(`input[value="${t}"]`);if(d){const t=d.closest(".showcase-badge-slot");t.classList.remove("filled"),t.classList.add("empty"),t.innerHTML='<i class="fa-solid fa-plus"></i><span>Empty Slot</span>',t.removeAttribute("data-key"),e.classList.remove("pinned"),e.innerHTML='<i class="fa-regular fa-star"></i> Pin'}else{let o=null;if(s.forEach(e=>{e.classList.contains("filled")||o||(o=e)}),!o)return void alert("All 3 showcase slots are full. Remove one first.");o.classList.remove("empty"),o.classList.add("filled"),o.setAttribute("data-key",t),o.innerHTML=`\n            <input type="hidden" name="badge_keys[]" value="${t}">\n            <span class="badge-icon">${a}</span>\n            <span class="badge-name">${n}</span>\n        `,e.classList.add("pinned"),e.innerHTML='<i class="fa-solid fa-star"></i> Pinned'}c&&(c.style.display="inline-flex")}function createConfetti(){const e=document.getElementById("confetti-container");if(!e)return;const t=["#a855f7","#6366f1","#f59e0b","#10b981","#ef4444","#3b82f6"];for(let n=0;n<100;n++)setTimeout(()=>{const n=document.createElement("div");n.className="confetti",n.style.left=100*Math.random()+"vw",n.style.backgroundColor=t[Math.floor(Math.random()*t.length)],n.style.animationDelay=.5*Math.random()+"s",n.style.borderRadius=Math.random()>.5?"50%":"0",e.appendChild(n),setTimeout(()=>n.remove(),3500)},20*n)}let currentItemId=null;function confirmPurchase(e,t,n,a){currentItemId=e;const o=document.getElementById("modalIcon"),s=document.getElementById("modalItemName"),c=document.getElementById("modalItemCost"),d=document.getElementById("purchaseModal");o&&(o.innerHTML=a||'<i class="fa-solid fa-gift"></i>'),s&&(s.textContent=t),c&&(c.textContent=n.toLocaleString()),d&&d.classList.add("active")}function closeModal(){const e=document.getElementById("purchaseModal");e&&e.classList.remove("active"),currentItemId=null}function closeSuccessModal(){const e=document.getElementById("successModal");e&&e.classList.remove("active"),location.reload()}function initShopPurchase(e){const t=document.getElementById("confirmBtn");t&&t.addEventListener("click",async function(){if(currentItemId){this.disabled=!0,this.textContent="Processing...";try{const t=new FormData;t.append("item_id",currentItemId);const n=await fetch(e+"/api/shop/purchase",{method:"POST",body:t}),a=await n.json();closeModal();const o=document.getElementById("successIcon"),s=document.getElementById("successTitle"),c=document.getElementById("successMessage"),d=document.getElementById("successModal");a.success?(o&&(o.innerHTML='<i class="fa-solid fa-check-circle" style="color: #10b981;"></i>'),s&&(s.textContent="Purchase Complete!"),c&&(c.textContent=a.message||"Your item has been added to your account."),d&&d.classList.add("active"),"function"==typeof showConfetti&&showConfetti()):(o&&(o.innerHTML='<i class="fa-solid fa-times-circle" style="color: #ef4444;"></i>'),s&&(s.textContent="Purchase Failed"),c&&(c.textContent=a.error||"Something went wrong. Please try again."),d&&d.classList.add("active"))}catch(e){closeModal();const t=document.getElementById("successIcon"),n=document.getElementById("successTitle"),a=document.getElementById("successMessage"),o=document.getElementById("successModal");t&&(t.innerHTML='<i class="fa-solid fa-times-circle" style="color: #ef4444;"></i>'),n&&(n.textContent="Error"),a&&(a.textContent="Failed to process purchase. Please try again."),o&&o.classList.add("active")}this.disabled=!1,this.textContent="Confirm"}})}function initShopCategories(){document.querySelectorAll(".category-btn").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".category-btn").forEach(e=>e.classList.remove("active")),this.classList.add("active");const e=this.dataset.category;document.querySelectorAll(".shop-item").forEach(t=>{"all"===e||t.dataset.category===e?t.style.display="block":t.style.display="none"})})})}document.addEventListener("DOMContentLoaded",function(){if(document.addEventListener("keydown",function(e){if("Escape"===e.key){const e=document.getElementById("badgeModal");e&&e.classList.contains("visible")&&closeBadgeModal()}}),document.querySelectorAll(".badge-earned").forEach(e=>{e.addEventListener("keydown",function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),openBadgeModal(this))})}),document.querySelectorAll(".purchase-modal").forEach(e=>{e.addEventListener("click",function(e){e.target===this&&this.classList.remove("active")})}),document.querySelector(".shop-categories")&&initShopCategories(),document.getElementById("purchaseModal")&&document.getElementById("confirmBtn")){const e=document.querySelector('a[href*="/achievements"]');if(e){const t=e.getAttribute("href");initShopPurchase(t.substring(0,t.indexOf("/achievements")))}}document.getElementById("confetti-container")&&createConfetti()});