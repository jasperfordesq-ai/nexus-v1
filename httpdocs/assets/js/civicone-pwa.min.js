!function(){"use strict";window.CivicOnePWA={deferredPrompt:null,isInstalled:!1,pushSubscription:null,init:function(){this.checkInstallState(),this.initInstallPrompt(),this.initPushNotifications(),this.initAppLifecycle(),console.warn("[CivicOne PWA] Initialized")},checkInstallState:function(){(window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone)&&(this.isInstalled=!0,document.body.classList.add("pwa-installed")),window.matchMedia("(display-mode: standalone)").addEventListener("change",e=>{this.isInstalled=e.matches,document.body.classList.toggle("pwa-installed",e.matches)})},initInstallPrompt:function(){window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),this.deferredPrompt=e,setTimeout(()=>{this.showInstallBanner()},3e4),console.warn("[CivicOne PWA] Install prompt captured")}),window.addEventListener("appinstalled",()=>{this.isInstalled=!0,this.deferredPrompt=null,this.hideInstallBanner(),document.body.classList.add("pwa-installed"),window.CivicOneMobile&&CivicOneMobile.showToast("App installed successfully!","success"),console.warn("[CivicOne PWA] App installed")}),document.addEventListener("click",e=>{e.target.closest("[data-pwa-install]")&&(e.preventDefault(),this.promptInstall()),e.target.closest("[data-pwa-dismiss]")&&(e.preventDefault(),this.hideInstallBanner(),localStorage.setItem("pwa-banner-dismissed",Date.now()))})},showInstallBanner:function(){if(this.isInstalled)return;const e=localStorage.getItem("pwa-banner-dismissed");if(e&&Date.now()-parseInt(e)<6048e5)return;if(document.getElementById("civic-pwa-banner"))return;const i=document.createElement("div");i.id="civic-pwa-banner",i.className="civic-pwa-banner",i.setAttribute("role","alertdialog"),i.setAttribute("aria-labelledby","pwa-banner-title"),i.setAttribute("aria-describedby","pwa-banner-desc"),i.innerHTML='\n                <div class="civic-pwa-banner-content">\n                    <div class="civic-pwa-banner-icon">\n                        <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">\n                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>\n                        </svg>\n                    </div>\n                    <div class="civic-pwa-banner-text">\n                        <strong id="pwa-banner-title">Install App</strong>\n                        <p id="pwa-banner-desc">Add to your home screen for the best experience</p>\n                    </div>\n                    <div class="civic-pwa-banner-actions">\n                        <button type="button" class="civic-pwa-btn-install" data-pwa-install aria-label="Install app">\n                            Install\n                        </button>\n                        <button type="button" class="civic-pwa-btn-dismiss" data-pwa-dismiss aria-label="Dismiss install prompt">\n                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">\n                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n                            </svg>\n                        </button>\n                    </div>\n                </div>\n            ',document.body.appendChild(i),requestAnimationFrame(()=>{i.classList.add("visible")}),setTimeout(()=>{const e=i.querySelector("[data-pwa-install]");e&&e.focus()},300)},hideInstallBanner:function(){const e=document.getElementById("civic-pwa-banner");e&&(e.classList.remove("visible"),setTimeout(()=>e.remove(),300))},async promptInstall(){if(!this.deferredPrompt)return void console.warn("[CivicOne PWA] No install prompt available");this.deferredPrompt.prompt();const{outcome:e}=await this.deferredPrompt.userChoice;console.warn("[CivicOne PWA] User choice:",e),this.deferredPrompt=null,this.hideInstallBanner()},initPushNotifications:function(){"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window?(document.addEventListener("click",e=>{e.target.closest("[data-push-enable]")&&(e.preventDefault(),this.requestPushPermission())}),this.checkPushSubscription()):console.warn("[CivicOne PWA] Push notifications not supported")},async checkPushSubscription(){try{const e=await navigator.serviceWorker.ready,i=await e.pushManager.getSubscription();i&&(this.pushSubscription=i,document.body.classList.add("push-enabled"),console.warn("[CivicOne PWA] Existing push subscription found"))}catch(e){console.error("[CivicOne PWA] Error checking push subscription:",e)}},async requestPushPermission(){try{if("granted"!==await Notification.requestPermission())return console.warn("[CivicOne PWA] Push permission denied"),void(window.CivicOneMobile&&CivicOneMobile.showToast("Notification permission denied","warning"));await this.subscribeToPush()}catch(e){console.error("[CivicOne PWA] Error requesting push permission:",e)}},async subscribeToPush(){try{const e=await navigator.serviceWorker.ready,i=await fetch("/api/push/vapid-public-key"),{publicKey:t}=await i.json(),n=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(t)});await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)});try{await fetch("/api/notifications/settings",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({push_enabled:1})})}catch(e){console.warn("[CivicOne PWA] Could not update notification preferences:",e)}this.pushSubscription=n,document.body.classList.add("push-enabled"),window.CivicOneMobile&&CivicOneMobile.showToast("Notifications enabled!","success"),console.warn("[CivicOne PWA] Push subscription successful")}catch(e){console.error("[CivicOne PWA] Error subscribing to push:",e),window.CivicOneMobile&&CivicOneMobile.showToast("Failed to enable notifications","error")}},urlBase64ToUint8Array(e){const i=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),t=window.atob(i),n=new Uint8Array(t.length);for(let e=0;e<t.length;++e)n[e]=t.charCodeAt(e);return n},initAppLifecycle:function(){document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState?this.onAppResume():this.onAppPause()}),window.addEventListener("pageshow",e=>{e.persisted&&this.onAppResume()}),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(e=>{setInterval(()=>{e.update()},36e5)})},onAppResume:function(){console.warn("[CivicOne PWA] App resumed"),window.updateBottomNavBadges&&updateBottomNavBadges(),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(e=>{e.update()})},onAppPause:function(){console.warn("[CivicOne PWA] App paused")},showUpdatePrompt:function(){const e=document.createElement("div");e.id="civic-update-banner",e.className="civic-update-banner",e.setAttribute("role","alertdialog"),e.setAttribute("aria-label","App update available"),e.innerHTML='\n                <div class="civic-update-banner-content">\n                    <span>A new version is available</span>\n                    <button type="button" class="civic-update-btn" onclick="window.location.reload()">\n                        Update Now\n                    </button>\n                </div>\n            ',document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("visible")})}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>CivicOnePWA.init()):CivicOnePWA.init(),document.addEventListener("turbo:load",()=>{CivicOnePWA.checkInstallState()})}();