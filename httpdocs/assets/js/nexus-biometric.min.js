!function(){"use strict";if(!("undefined"!=typeof Capacitor&&Capacitor.isNativePlatform&&Capacitor.isNativePlatform()))return void console.log("[Biometric] Not in native app, skipping biometric setup");const e=Capacitor.Plugins.NativeBiometric;if(!e)return void console.log("[Biometric] NativeBiometric plugin not available");const t={isAvailable:!1,biometryType:null,credentialsKey:"nexus_biometric_credentials",promptDismissedKey:"nexus_biometric_prompt_dismissed",promptRemindLaterKey:"nexus_biometric_remind_later",async init(){try{const t=await e.isAvailable();this.isAvailable=t.isAvailable,this.biometryType=t.biometryType,console.log("[Biometric] Available:",this.isAvailable,"Type:",this.biometryType),this.isAvailable&&(this.setupLoginPage(),this.setupSettingsToggle(),this.checkAutoPrompt())}catch(e){console.error("[Biometric] Init error:",e)}},async checkAutoPrompt(){console.log("[Biometric] Checking auto-prompt conditions...");if(!(window.NEXUS?.userId||document.querySelector(".user-menu, .profile-menu, [data-user-id]")))return void console.log("[Biometric] Not logged in, skipping prompt");if(window.location.pathname.includes("/login"))return void console.log("[Biometric] On login page, skipping prompt");if(await this.hasStoredCredentials())return void console.log("[Biometric] Already has credentials, skipping prompt");if("true"===localStorage.getItem(this.promptDismissedKey))return void console.log("[Biometric] User dismissed permanently, skipping prompt");const e=localStorage.getItem(this.promptRemindLaterKey);if(e){const t=parseInt(e,10),n=2592e5;if(Date.now()-t<n)return void console.log("[Biometric] Remind later active, skipping prompt")}const t=sessionStorage.getItem("nexus_just_logged_in")||window.NEXUS?.justLoggedIn,n=sessionStorage.getItem("nexus_biometric_prompt_shown");console.log("[Biometric] justLoggedIn:",t,"promptShownThisSession:",n),t&&!n?(sessionStorage.removeItem("nexus_just_logged_in"),sessionStorage.setItem("nexus_biometric_prompt_shown","true"),console.log("[Biometric] Showing setup prompt in 1.5 seconds..."),setTimeout(()=>this.showSetupPrompt(),1500)):console.log("[Biometric] Conditions not met for prompt")},showSetupPrompt(){const e=document.getElementById("biometric-setup-modal");if(e)return void this.showExistingModal(e);const t="FACE"===this.biometryType?"Face ID":this.biometryType?"Fingerprint":"Biometric",n="FACE"===this.biometryType?"face-viewfinder":"fingerprint",i=t?t.toLowerCase():"biometric",o=document.createElement("div");o.className="biometric-prompt-modal",o.innerHTML=`\n                <div class="biometric-prompt-content">\n                    <div class="biometric-prompt-icon">\n                        <i class="fa-solid fa-${n}"></i>\n                    </div>\n                    <h3>Enable ${t} Login?</h3>\n                    <p>Sign in faster and more securely using your ${i}. Your credentials are stored safely on this device.</p>\n                    <div class="biometric-prompt-buttons">\n                        <button type="button" class="btn-enable">\n                            <i class="fa-solid fa-${n}"></i>\n                            Enable ${t}\n                        </button>\n                        <button type="button" class="btn-later">Remind Me Later</button>\n                        <button type="button" class="btn-dismiss">Don't Ask Again</button>\n                    </div>\n                </div>\n            `,document.body.appendChild(o),this.addPromptStyles(),requestAnimationFrame(()=>o.classList.add("visible")),o.querySelector(".btn-enable").addEventListener("click",async()=>{o.classList.remove("visible"),setTimeout(()=>o.remove(),300),await this.setupBiometricFromPrompt()}),o.querySelector(".btn-later").addEventListener("click",()=>{localStorage.setItem(this.promptRemindLaterKey,Date.now().toString()),o.classList.remove("visible"),setTimeout(()=>o.remove(),300)}),o.querySelector(".btn-dismiss").addEventListener("click",()=>{localStorage.setItem(this.promptDismissedKey,"true"),o.classList.remove("visible"),setTimeout(()=>o.remove(),300)})},showExistingModal(e){console.log("[Biometric] Showing existing modal from footer"),e.style.display="flex";const t=document.getElementById("btn-setup-biometric-now"),n=document.getElementById("btn-skip-biometric");if(console.log("[Biometric] Setup button found:",!!t),console.log("[Biometric] Skip button found:",!!n),t){const n=t.cloneNode(!0);t.parentNode.replaceChild(n,t),n.addEventListener("click",async t=>{t.preventDefault(),t.stopPropagation(),console.log("[Biometric] Setup button clicked!"),e.style.display="none",await this.setupBiometricFromPrompt()})}if(n){const t=n.cloneNode(!0);n.parentNode.replaceChild(t,n),t.addEventListener("click",t=>{t.preventDefault(),console.log("[Biometric] Skip button clicked"),localStorage.setItem(this.promptRemindLaterKey,Date.now().toString()),e.style.display="none"})}e.addEventListener("click",t=>{t.target===e&&(console.log("[Biometric] Backdrop clicked"),localStorage.setItem(this.promptRemindLaterKey,Date.now().toString()),e.style.display="none")})},async setupBiometricFromPrompt(){try{console.log("[Biometric] Starting setup from prompt..."),this.addStyles(),console.log("[Biometric] Styles added");const t=window.NEXUS?.userEmail;if(console.log("[Biometric] User email:",t),!t)return console.log("[Biometric] No user email found!"),void this.showToast("Could not get user info. Please try in Settings.","error");console.log("[Biometric] About to show password prompt...");const n=await this.promptForPassword();if(console.log("[Biometric] Password entered:",n?"yes":"no"),!n)return void console.log("[Biometric] Password prompt cancelled");console.log("[Biometric] Requesting biometric verification..."),await e.verifyIdentity({reason:"Confirm your identity to enable biometric login",title:"Enable Biometric Login",subtitle:"Use your fingerprint or face",description:"This will allow you to sign in without entering your password"}),console.log("[Biometric] Biometric verified successfully"),console.log("[Biometric] Storing credentials..."),await e.setCredentials({username:t,password:n,server:"hour-timebank.ie"}),console.log("[Biometric] Setup complete from prompt"),this.showToast("Biometric login enabled!","success")}catch(e){console.error("[Biometric] Setup from prompt error:",e);const t=e?.message||e?.code||String(e);"User cancelled"===t||"BIOMETRIC_DISMISSED"===e?.code||t.includes("cancel")||this.showToast("Failed to set up biometric login: "+t,"error")}},addPromptStyles(){if(document.getElementById("biometric-prompt-styles"))return;const e=document.createElement("style");e.id="biometric-prompt-styles",e.textContent='\n                .biometric-prompt-modal {\n                    position: fixed;\n                    inset: 0;\n                    background: rgba(0, 0, 0, 0.6);\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    z-index: 100010;\n                    padding: 20px;\n                    opacity: 0;\n                    transition: opacity 0.3s;\n                }\n\n                .biometric-prompt-modal.visible {\n                    opacity: 1;\n                }\n\n                .biometric-prompt-content {\n                    background: var(--htb-card-bg, white);\n                    border-radius: 24px;\n                    padding: 32px;\n                    max-width: 380px;\n                    width: 100%;\n                    text-align: center;\n                    transform: scale(0.9) translateY(20px);\n                    transition: transform 0.3s;\n                }\n\n                .biometric-prompt-modal.visible .biometric-prompt-content {\n                    transform: scale(1) translateY(0);\n                }\n\n                .biometric-prompt-icon {\n                    width: 80px;\n                    height: 80px;\n                    margin: 0 auto 20px;\n                    background: linear-gradient(135deg, #6366f1, #8b5cf6);\n                    border-radius: 50%;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    box-shadow: 0 8px 32px rgba(99, 102, 241, 0.35);\n                }\n\n                .biometric-prompt-icon i {\n                    font-size: 36px;\n                    color: white;\n                }\n\n                .biometric-prompt-content h3 {\n                    margin: 0 0 12px 0;\n                    font-size: 1.4rem;\n                    font-weight: 700;\n                    color: var(--htb-text-main, #1f2937);\n                }\n\n                .biometric-prompt-content p {\n                    margin: 0 0 24px 0;\n                    font-size: 0.95rem;\n                    color: var(--htb-text-muted, #6b7280);\n                    line-height: 1.5;\n                }\n\n                .biometric-prompt-buttons {\n                    display: flex;\n                    flex-direction: column;\n                    gap: 10px;\n                }\n\n                .biometric-prompt-buttons button {\n                    width: 100%;\n                    padding: 14px 20px;\n                    border-radius: 12px;\n                    font-size: 1rem;\n                    font-weight: 600;\n                    cursor: pointer;\n                    border: none;\n                    transition: transform 0.2s, box-shadow 0.2s;\n                }\n\n                .biometric-prompt-buttons .btn-enable {\n                    background: linear-gradient(135deg, #6366f1, #8b5cf6);\n                    color: white;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    gap: 10px;\n                    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);\n                }\n\n                .biometric-prompt-buttons .btn-enable:hover {\n                    transform: translateY(-2px);\n                    box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);\n                }\n\n                .biometric-prompt-buttons .btn-later {\n                    background: var(--htb-bg-secondary, #f3f4f6);\n                    color: var(--htb-text-main, #374151);\n                }\n\n                .biometric-prompt-buttons .btn-dismiss {\n                    background: transparent;\n                    color: var(--htb-text-muted, #9ca3af);\n                    font-size: 0.9rem;\n                    padding: 10px;\n                }\n\n                .biometric-prompt-buttons .btn-dismiss:hover {\n                    color: var(--htb-text-main, #6b7280);\n                }\n\n                /* Dark mode */\n                [data-theme="dark"] .biometric-prompt-content {\n                    background: var(--htb-card-bg, #1e293b);\n                }\n\n                [data-theme="dark"] .biometric-prompt-buttons .btn-later {\n                    background: #334155;\n                    color: #e2e8f0;\n                }\n            ',document.head.appendChild(e)},setupLoginPage(){const e=document.querySelector('form[action*="login"], #loginForm, .login-form');e&&this.hasStoredCredentials().then(t=>{if(!t)return void console.log("[Biometric] No stored credentials");const n=document.createElement("button");n.type="button",n.className="btn btn-biometric",n.innerHTML=`\n                    <i class="fa-solid fa-${"FACE"===this.biometryType?"face-viewfinder":"fingerprint"}"></i>\n                    <span>Login with ${"FACE"===this.biometryType?"Face ID":"Fingerprint"}</span>\n                `,n.addEventListener("click",()=>this.loginWithBiometric());const i=document.createElement("div");i.className="biometric-login-container",i.innerHTML='<div class="biometric-divider"><span>or</span></div>',i.appendChild(n),e.parentNode.insertBefore(i,e.nextSibling),this.addStyles()})},setupSettingsToggle(){const e=document.querySelector('.security-settings, #security-settings, [data-section="security"]');e&&this.addBiometricToggle(e);const t=document.querySelector(".settings-page, .account-settings");t&&!e&&this.addBiometricToggle(t)},addBiometricToggle(e){this.hasStoredCredentials().then(t=>{const n=`\n                    <div class="biometric-setting">\n                        <div class="setting-info">\n                            <i class="fa-solid fa-${"FACE"===this.biometryType?"face-viewfinder":"fingerprint"}"></i>\n                            <div>\n                                <strong>${"FACE"===this.biometryType?"Face ID":"Fingerprint"} Login</strong>\n                                <span>Use biometric authentication to sign in quickly</span>\n                            </div>\n                        </div>\n                        <label class="toggle-switch">\n                            <input type="checkbox" id="biometricToggle" ${t?"checked":""}>\n                            <span class="toggle-slider"></span>\n                        </label>\n                    </div>\n                `,i=document.createElement("div");i.innerHTML=n,e.appendChild(i.firstElementChild),document.getElementById("biometricToggle").addEventListener("change",e=>{e.target.checked?this.enableBiometric():this.disableBiometric()})})},async hasStoredCredentials(){try{const t=await e.getCredentials({server:"hour-timebank.ie"});return!!t&&!!t.username}catch(e){return!1}},async enableBiometric(){try{if(!await e.verifyIdentity({reason:"Enable biometric login",title:"Biometric Setup",subtitle:"Confirm your identity",description:"Use your fingerprint or face to enable quick login"}))return console.log("[Biometric] Verification cancelled"),void(document.getElementById("biometricToggle").checked=!1);const t=window.NEXUS?.userId,n=window.NEXUS?.userEmail;if(!t||!n)return this.showToast("Please log in first to enable biometric login","error"),void(document.getElementById("biometricToggle").checked=!1);const i=await this.promptForPassword();if(!i)return void(document.getElementById("biometricToggle").checked=!1);await e.setCredentials({username:n,password:i,server:"hour-timebank.ie"}),this.showToast("Biometric login enabled!","success"),console.log("[Biometric] Credentials stored")}catch(e){console.error("[Biometric] Enable error:",e),this.showToast("Failed to enable biometric login","error"),document.getElementById("biometricToggle").checked=!1}},async disableBiometric(){try{await e.deleteCredentials({server:"hour-timebank.ie"}),this.showToast("Biometric login disabled","info"),console.log("[Biometric] Credentials deleted")}catch(e){console.error("[Biometric] Disable error:",e)}},async loginWithBiometric(){console.log("[Biometric] Starting biometric login...");try{console.log("[Biometric] Requesting biometric verification for login..."),await e.verifyIdentity({reason:"Log in to Hour Timebank",title:"Biometric Login",subtitle:"Verify your identity",description:"Use your fingerprint or face to sign in",useFallback:!0,fallbackTitle:"Use Password",maxAttempts:3}),console.log("[Biometric] Biometric verified for login"),console.log("[Biometric] Getting stored credentials...");const t=await e.getCredentials({server:"hour-timebank.ie"});if(console.log("[Biometric] Credentials retrieved:",t?"yes":"no"),!t||!t.username||!t.password)return console.log("[Biometric] No valid credentials found"),void this.showToast("No saved credentials found","error");console.log("[Biometric] Performing login with stored credentials..."),this.performLogin(t.username,t.password)}catch(e){console.error("[Biometric] Login error:",e);const t=e?.message||e?.code||String(e);t.includes("cancel")||"BIOMETRIC_DISMISSED"===e?.code||this.showToast("Biometric login failed: "+t,"error")}},performLogin(e,t){const n=document.querySelector('input[type="email"], input[name="email"], input[name="username"]'),i=document.querySelector('input[type="password"], input[name="password"]'),o=document.querySelector('form[action*="login"], #loginForm, .login-form');if(n&&i&&o)n.value=e,i.value=t,o.submit();else{const n=document.createElement("form");n.method="POST",n.action="/login",n.innerHTML=`\n                    <input type="hidden" name="email" value="${this.escapeHtml(e)}">\n                    <input type="hidden" name="password" value="${this.escapeHtml(t)}">\n                `,document.body.appendChild(n),n.submit()}},promptForPassword:()=>new Promise(e=>{const t=document.createElement("div");t.className="biometric-modal",t.innerHTML='\n                    <div class="biometric-modal-content">\n                        <h3>Enter Your Password</h3>\n                        <p>Your password will be stored securely and protected by your biometric.</p>\n                        <input type="password" id="biometricPassword" placeholder="Enter your password" autofocus>\n                        <div class="biometric-modal-buttons">\n                            <button type="button" class="btn-cancel">Cancel</button>\n                            <button type="button" class="btn-confirm">Confirm</button>\n                        </div>\n                    </div>\n                ',document.body.appendChild(t);const n=t.querySelector("#biometricPassword"),i=t.querySelector(".btn-cancel"),o=t.querySelector(".btn-confirm");i.addEventListener("click",()=>{t.remove(),e(null)}),o.addEventListener("click",()=>{const i=n.value;t.remove(),e(i||null)}),n.addEventListener("keypress",i=>{if("Enter"===i.key){const i=n.value;t.remove(),e(i||null)}}),setTimeout(()=>n.focus(),100)}),showToast(e,t="info"){const n=document.createElement("div");n.className=`biometric-toast ${t}`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>n.classList.add("visible"),10),setTimeout(()=>{n.classList.remove("visible"),setTimeout(()=>n.remove(),300)},3e3)},escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},addStyles(){if(document.getElementById("biometric-styles"))return;const e=document.createElement("style");e.id="biometric-styles",e.textContent="\n                .biometric-login-container {\n                    margin: 20px 0;\n                    text-align: center;\n                }\n\n                .biometric-divider {\n                    display: flex;\n                    align-items: center;\n                    margin: 16px 0;\n                    color: var(--htb-text-muted, #6b7280);\n                }\n\n                .biometric-divider::before,\n                .biometric-divider::after {\n                    content: '';\n                    flex: 1;\n                    height: 1px;\n                    background: var(--htb-border, #e5e7eb);\n                }\n\n                .biometric-divider span {\n                    padding: 0 12px;\n                    font-size: 0.85rem;\n                }\n\n                .btn-biometric {\n                    display: inline-flex;\n                    align-items: center;\n                    gap: 10px;\n                    padding: 14px 24px;\n                    background: linear-gradient(135deg, #6366f1, #8b5cf6);\n                    color: white;\n                    border: none;\n                    border-radius: 12px;\n                    font-size: 1rem;\n                    font-weight: 600;\n                    cursor: pointer;\n                    transition: transform 0.2s, box-shadow 0.2s;\n                }\n\n                .btn-biometric:hover {\n                    transform: translateY(-2px);\n                    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);\n                }\n\n                .btn-biometric i {\n                    font-size: 1.25rem;\n                }\n\n                .biometric-setting {\n                    display: flex;\n                    align-items: center;\n                    justify-content: space-between;\n                    padding: 16px;\n                    background: var(--htb-card-bg, white);\n                    border-radius: 12px;\n                    border: 1px solid var(--htb-border, #e5e7eb);\n                    margin-bottom: 12px;\n                }\n\n                .biometric-setting .setting-info {\n                    display: flex;\n                    align-items: center;\n                    gap: 12px;\n                }\n\n                .biometric-setting .setting-info i {\n                    font-size: 1.5rem;\n                    color: #6366f1;\n                }\n\n                .biometric-setting .setting-info strong {\n                    display: block;\n                    color: var(--htb-text-main, #1f2937);\n                }\n\n                .biometric-setting .setting-info span {\n                    font-size: 0.85rem;\n                    color: var(--htb-text-muted, #6b7280);\n                }\n\n                .toggle-switch {\n                    position: relative;\n                    width: 50px;\n                    height: 28px;\n                }\n\n                .toggle-switch input {\n                    opacity: 0;\n                    width: 0;\n                    height: 0;\n                }\n\n                .toggle-slider {\n                    position: absolute;\n                    cursor: pointer;\n                    inset: 0;\n                    background: #e5e7eb;\n                    border-radius: 28px;\n                    transition: 0.3s;\n                }\n\n                .toggle-slider::before {\n                    content: '';\n                    position: absolute;\n                    width: 22px;\n                    height: 22px;\n                    left: 3px;\n                    bottom: 3px;\n                    background: white;\n                    border-radius: 50%;\n                    transition: 0.3s;\n                }\n\n                .toggle-switch input:checked + .toggle-slider {\n                    background: #6366f1;\n                }\n\n                .toggle-switch input:checked + .toggle-slider::before {\n                    transform: translateX(22px);\n                }\n\n                .biometric-modal {\n                    position: fixed;\n                    inset: 0;\n                    background: rgba(0, 0, 0, 0.5);\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    z-index: 100002;\n                    padding: 20px;\n                }\n\n                .biometric-modal-content {\n                    background: var(--htb-card-bg, white);\n                    border-radius: 16px;\n                    padding: 24px;\n                    max-width: 400px;\n                    width: 100%;\n                }\n\n                .biometric-modal-content h3 {\n                    margin: 0 0 8px 0;\n                    font-size: 1.25rem;\n                    color: var(--htb-text-main, #1f2937);\n                }\n\n                .biometric-modal-content p {\n                    margin: 0 0 16px 0;\n                    font-size: 0.9rem;\n                    color: var(--htb-text-muted, #6b7280);\n                }\n\n                .biometric-modal-content input {\n                    width: 100%;\n                    padding: 12px 16px;\n                    border: 1px solid var(--htb-border, #d1d5db);\n                    border-radius: 8px;\n                    font-size: 1rem;\n                    margin-bottom: 16px;\n                    box-sizing: border-box;\n                    background: var(--htb-bg-secondary, #f9fafb);\n                    color: var(--htb-text-main, #1f2937);\n                }\n\n                .biometric-modal-buttons {\n                    display: flex;\n                    gap: 12px;\n                    justify-content: flex-end;\n                }\n\n                .biometric-modal-buttons button {\n                    padding: 10px 20px;\n                    border-radius: 8px;\n                    font-weight: 600;\n                    cursor: pointer;\n                    border: none;\n                }\n\n                .biometric-modal-buttons .btn-cancel {\n                    background: var(--htb-bg-secondary, #f3f4f6);\n                    color: var(--htb-text-main, #374151);\n                }\n\n                .biometric-modal-buttons .btn-confirm {\n                    background: #6366f1;\n                    color: white;\n                }\n\n                .biometric-toast {\n                    position: fixed;\n                    bottom: 20px;\n                    left: 50%;\n                    transform: translateX(-50%) translateY(100px);\n                    padding: 12px 24px;\n                    background: #1f2937;\n                    color: white;\n                    border-radius: 8px;\n                    font-size: 0.9rem;\n                    z-index: 100003;\n                    transition: transform 0.3s;\n                }\n\n                .biometric-toast.visible {\n                    transform: translateX(-50%) translateY(0);\n                }\n\n                .biometric-toast.success {\n                    background: #059669;\n                }\n\n                .biometric-toast.error {\n                    background: #dc2626;\n                }\n\n                /* Dark mode */\n                [data-theme=\"dark\"] .biometric-modal-content {\n                    background: var(--htb-card-bg, #1e293b);\n                }\n\n                [data-theme=\"dark\"] .toggle-slider {\n                    background: #374151;\n                }\n            ",document.head.appendChild(e)}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>t.init()):t.init(),window.NexusBiometric=t,window.location.search.includes("biometric_test=1")&&setTimeout(()=>{console.log("[Biometric] Test mode - forcing prompt display"),t.showSetupPrompt()},1e3)}();