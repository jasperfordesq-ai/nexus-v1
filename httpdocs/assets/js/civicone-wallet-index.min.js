!function(){"use strict";let e=null,t=-1;const n=document.getElementById("civiconeUserSearch"),s=document.getElementById("civiconeUserResults"),c=document.getElementById("civiconeSelectedUser"),i=document.getElementById("civiconeSearchWrapper"),r=document.getElementById("civiconeRecipientUsername"),a=document.getElementById("civiconeRecipientId");if(!n)return;function o(e){e.forEach((e,n)=>{e.classList.toggle("selected",n===t)}),e[t]&&e[t].scrollIntoView({block:"nearest"})}function l(e,t,n,o){r.value=e,a.value=o||"";const l=(t||"?")[0].toUpperCase();document.getElementById("civiconeSelectedAvatar").innerHTML=n?`<img src="${d(n)}" alt="">`:l,document.getElementById("civiconeSelectedName").textContent=t,document.getElementById("civiconeSelectedUsername").textContent=e?"@"+e:"No username",c.classList.add("show"),i.classList.add("hidden"),s.classList.remove("show")}function d(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}n.addEventListener("input",function(){const n=this.value.trim();if(clearTimeout(e),t=-1,n.length<1)return s.classList.remove("show"),void(s.innerHTML="");e=setTimeout(()=>function(e){const n=document.querySelector('meta[name="base-path"]')?.content||"";fetch(n+"/api/wallet/user-search",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e})}).then(e=>e.json()).then(e=>{t=-1,"success"===e.status&&e.users&&e.users.length>0?(s.innerHTML=e.users.map(e=>{const t=(e.display_name||"?")[0].toUpperCase(),n=e.avatar_url?`<img src="${d(e.avatar_url)}" alt="">`:t;return`\n                        <div class="civicone-user-result"\n                             onclick="window.civiconeWallet.selectUser('${d(e.username||"")}', '${d(e.display_name)}', '${d(e.avatar_url||"")}', '${e.id}')"\n                             tabindex="0"\n                             role="option"\n                             aria-selected="false">\n                            <div class="civicone-user-avatar">${n}</div>\n                            <div class="civicone-user-info">\n                                <div class="civicone-user-name">${d(e.display_name)}</div>\n                                <div class="civicone-user-username">${e.username?"@"+d(e.username):"<em>No username set</em>"}</div>\n                            </div>\n                        </div>\n                    `}).join(""),s.classList.add("show"),s.setAttribute("role","listbox")):(s.innerHTML='<div class="civicone-user-no-results">No users found</div>',s.classList.add("show"))}).catch(e=>{console.error("User search error:",e),s.innerHTML='<div class="civicone-user-no-results">Search error</div>',s.classList.add("show")})}(n),200)}),n.addEventListener("keydown",function(e){const n=s.querySelectorAll(".civicone-user-result");n.length&&("ArrowDown"===e.key?(e.preventDefault(),t=Math.min(t+1,n.length-1),o(n)):"ArrowUp"===e.key?(e.preventDefault(),t=Math.max(t-1,0),o(n)):"Enter"===e.key?(e.preventDefault(),t>=0&&n[t]&&n[t].click()):"Escape"===e.key&&s.classList.remove("show"))}),document.addEventListener("click",function(e){e.target.closest(".civicone-user-search-wrapper")||s.classList.remove("show")}),window.civiconeWallet={selectUser:l,clearSelection:function(){r.value="",a.value="",c.classList.remove("show"),i.classList.remove("hidden"),n.value="",n.focus()},validateForm:function(e){const t=r.value.trim(),s=a.value.trim();if(!t&&!s)return alert("Please select a recipient from the search results."),n.focus(),!1;const c=document.getElementById("civiconeSubmitBtn");return c&&(c.disabled=!0,c.textContent="Sending..."),!0}};const u=document.getElementById("civicone-prefill-data");if(u)try{const e=JSON.parse(u.textContent);e.username&&e.display_name&&e.id&&l(e.username,e.display_name,e.avatar_url||"",e.id)}catch(e){console.error("Failed to parse prefill data:",e)}}();