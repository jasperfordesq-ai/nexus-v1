class NexusNotifications{constructor(){this.basePath=this.getBasePath().replace(/\/+$/,""),this.csrfToken=this.getCsrfToken(),this.elements={bellIcon:document.querySelector(".nexus-utility-bar .fa-bell"),dropdown:document.querySelector(".htb-dropdown-content")},this.isProcessing=!1,this.pollInterval=6e4,this.pollingActive=!1,this.pusherConnected=!1,this.init()}getBasePath(){return"undefined"!=typeof NEXUS_BASE?NEXUS_BASE:""}getCsrfToken(){const e=document.querySelector('meta[name="csrf-token"]');return e?e.getAttribute("content"):""}init(){console.log("NexusNotifications v3.0: Initializing (Pusher + Polling Fallback)..."),document.body.addEventListener("mousedown",e=>this.handleInteraction(e)),this.initPusher()}initPusher(){if(void 0!==window.nexusPusher)this.bindPusherEvents();else{const e=setInterval(()=>{void 0!==window.nexusPusher&&(clearInterval(e),this.bindPusherEvents())},100);setTimeout(()=>{this.pusherConnected||this.pollingActive||(console.log("NexusNotifications: Pusher not available, starting polling"),this.startPolling())},3e3)}}bindPusherEvents(){const e=window.nexusPusher;e.on("connection",e=>{"connected"===e.status?(console.log("NexusNotifications: Connected to Pusher"),this.pusherConnected=!0,this.stopPolling()):"fallback"!==e.status&&"error"!==e.status||(console.log("NexusNotifications: Pusher unavailable, using polling"),this.pusherConnected=!1,this.startPolling())}),e.on("notification",e=>{console.log("NexusNotifications: Real-time notification received",e),this.handleRealtimeNotification(e)}),e.on("unread-count",e=>{console.log("NexusNotifications: Unread count update",e),this.updateBadge(e.notifications||0)}),e.on("new-message",e=>{console.log("NexusNotifications: New message received",e),this.handleNewMessage(e)}),e.isConnected()?this.pusherConnected=!0:this.startPolling()}handleRealtimeNotification(e){this.incrementBadge(),this.showBrowserNotification(e),this.addNotificationToDropdown(e)}handleNewMessage(e){const t=document.querySelector(".message-badge, [data-message-count]");if(t){const e=parseInt(t.textContent)||0;t.textContent=e+1,t.style.display="flex"}}showBrowserNotification(e){if(!("Notification"in window))return;if("granted"!==Notification.permission)return;if(document.hasFocus())return;const t=new Notification(e.type||"Notification",{body:e.message,icon:"/assets/images/pwa/icon-192x192.png",tag:"nexus-notification-"+(e.id||Date.now())});t.onclick=()=>{window.focus(),e.link&&(window.location.href=e.link),t.close()},setTimeout(()=>t.close(),5e3)}addNotificationToDropdown(e){const t=document.getElementById("nexus-notif-list");if(!t)return;const n=t.querySelector(".notif-dropdown-empty, .empty-message, [data-empty]");n&&n.remove();const i=document.createElement("a");i.href=e.link||"#",i.className="notif-dropdown-item",i.setAttribute("data-notif-id",e.id),i.innerHTML=`\n            <div class="notif-message">${this.escapeHtml(e.message)}</div>\n            <div class="notif-time"><i class="fa-regular fa-clock"></i> Just now</div>\n        `,t.insertBefore(i,t.firstChild)}incrementBadge(){const e=document.querySelector(".nexus-utility-bar .fa-bell");if(!e)return;const t=e.parentNode;let n=t.querySelector("span");if(n){const e=(parseInt(n.textContent)||0)+1;n.textContent=e>9?"9+":e,n.style.display="flex"}else{const e=document.createElement("span");e.style.cssText="position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; border-radius: 50%; min-width: 16px; height: 16px; padding: 0 4px; font-size: 0.65rem; display: flex; align-items: center; justify-content: center; font-weight: 700; border: 2px solid rgba(0,0,0,0.1);",e.textContent="1",t.appendChild(e)}}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null),this.pollingActive=!1,console.log("NexusNotifications: Polling stopped (using Pusher)")}handleInteraction(e){const t=e.target.closest("[data-notif-id]");if(t){const e=t.getAttribute("data-notif-id");this.markOneRead(e)}}async markAllRead(e=null){if(this.isProcessing)return;this.isProcessing=!0;const t=document.getElementById("nexus-notif-list"),n=document.getElementById("nexus-bell-badge"),i=document.querySelector(".mobile-notification-list"),o=t?t.innerHTML:"",s=n?n.style.display:"",a=i?i.innerHTML:"",r='<div style="padding:20px;text-align:center;color:#65676b;">Marking all read...</div>';t&&(t.innerHTML=r),i&&(i.innerHTML=r),n&&(n.style.display="none"),document.querySelectorAll(".mobile-tab-badge, .nexus-notif-badge").forEach(e=>{e.style.display="none"});let l="";e&&(l=e.textContent,e.textContent="Processing...",e.style.opacity="0.6");try{console.log("NexusNotifications: Send POST to /api/notifications/read [ALL]");const n={"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"};this.csrfToken&&(n["X-CSRF-Token"]=this.csrfToken);const o=new URLSearchParams;o.append("all","true");const s=await fetch(`${this.basePath}/api/notifications/read`,{method:"POST",headers:n,body:o}),a=await s.text();let r;try{r=JSON.parse(a)}catch(e){throw console.error("Server returned non-JSON:",a),new Error("Server error (Invalid JSON response)")}if(!s.ok||!r.success)throw new Error(r.error||`Server responded with ${s.status}`);{console.log("NexusNotifications: Success. Reloading.");const n='<div style="padding: 30px; text-align: center; color: #94a3b8;"><div style="font-size: 1.5rem; margin-bottom: 5px; opacity: 0.5;"><i class="fa-regular fa-bell-slash"></i></div><div style="font-size: 0.9rem;">No notifications</div></div>';t&&(t.innerHTML=n),i&&(i.innerHTML='<div class="mobile-notification-empty"><i class="fa-regular fa-bell-slash"></i><p>No notifications yet</p></div>'),e&&(e.textContent="Done!"),window.location.reload()}}catch(r){console.error("NexusNotifications Error:",r),alert("Unable to mark notifications as read. "+r.message),t&&(t.innerHTML=o),i&&(i.innerHTML=a),n&&(n.style.display=s),e&&(e.textContent=l,e.style.opacity="1.0"),this.isProcessing=!1}}markOneRead(e){if(!e)return;const t={"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"};this.csrfToken&&(t["X-CSRF-Token"]=this.csrfToken);const n=new URLSearchParams;n.append("id",e),fetch(`${this.basePath}/api/notifications/read`,{method:"POST",keepalive:!0,headers:t,body:n}).catch(e=>console.warn("Failed to mark notification read:",e))}startPolling(){this.pollingActive||this.pusherConnected||(this.pollingActive=!0,console.log("NexusNotifications: Starting polling (interval: "+this.pollInterval+"ms)"),this.pollTimer=setInterval(()=>{this.pusherConnected?this.stopPolling():document.hidden||fetch(`${this.basePath}/api/notifications/poll`).then(e=>e.json()).then(e=>{e.success&&this.updateBadge(e.count)}).catch(e=>console.warn("NexusNotifications Poll Error:",e))},this.pollInterval))}updateBadge(e){const t=document.querySelector(".nexus-utility-bar .fa-bell");if(!t)return;const n=t.parentNode;let i=n.querySelector("span");if(e>0){const t=e>9?"9+":e;if(i)i.textContent=t,i.style.display="flex";else{const e=document.createElement("span");e.style.cssText="position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; border-radius: 50%; min-width: 16px; height: 16px; padding: 0 4px; font-size: 0.65rem; display: flex; align-items: center; justify-content: center; font-weight: 700; border: 2px solid rgba(0,0,0,0.1);",e.textContent=t,n.appendChild(e)}}else i&&(i.style.display="none")}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.nexusNotifications=new NexusNotifications}):window.nexusNotifications=new NexusNotifications;