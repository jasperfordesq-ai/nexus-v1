!function(){"use strict";window.NexusAuth={config:{heartbeatInterval:12e4,tokenRefreshInterval:12e4,tokenRefreshThreshold:600,heartbeatEndpoint:"/api/auth/heartbeat",checkSessionEndpoint:"/api/auth/check-session",refreshTokenEndpoint:"/api/auth/refresh-token",tokenStorageKey:"nexus_auth_token",tokenExpiryKey:"nexus_token_expiry",userStorageKey:"nexus_user_data",refreshTokenStorageKey:"nexus_refresh_token",platformStorageKey:"nexus_platform"},heartbeatTimer:null,tokenRefreshTimer:null,isRefreshing:!1,refreshPromise:null,lastActivity:Date.now(),storageReady:!1,useCapacitorStorage:!1,capacitorPreferences:null,isRecovering:!1,networkConnected:!0,init:async function(){if(await this.initStorage(),this.detectAndConfigurePlatform(),await this.recoverAuthState(),!this.isLoggedIn())return void console.log("[NexusAuth] Not logged in, skipping initialization");this.setupActivityTracking(),this.startHeartbeat(),this.startTokenRefreshTimer(),this.setupVisibilityHandler(),this.setupFetchInterceptor(),this.setupNetworkHandler();const e=this.isMobileDevice()?"mobile":"desktop";console.log("[NexusAuth] Auth handler initialized for "+e+" platform")},detectAndConfigurePlatform:function(){const e=this.isMobileDevice();e?(this.config.heartbeatInterval=6e5,this.config.tokenRefreshInterval=6e5,this.config.tokenRefreshThreshold=86400,console.log("[NexusAuth] Mobile platform detected - using persistent login settings")):(this.config.heartbeatInterval=12e4,this.config.tokenRefreshInterval=12e4,this.config.tokenRefreshThreshold=600,console.log("[NexusAuth] Desktop platform detected - using standard settings"));try{localStorage.setItem(this.config.platformStorageKey,e?"mobile":"web")}catch(e){}},isMobileDevice:function(){if(this.isNativeApp())return!0;const e=navigator.userAgent||"";return/Mobile|Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(e)},initStorage:async function(){if(!this.storageReady){try{this.isNativeApp()&&"undefined"!=typeof Capacitor&&Capacitor.Plugins.Preferences?(this.capacitorPreferences=Capacitor.Plugins.Preferences,this.useCapacitorStorage=!0,console.log("[NexusAuth] Using Capacitor Preferences for persistent storage")):(this.useCapacitorStorage=!1,console.log("[NexusAuth] Using localStorage (web mode)"))}catch(e){this.useCapacitorStorage=!1,console.log("[NexusAuth] Capacitor Preferences not available, using localStorage")}this.storageReady=!0}},recoverAuthState:async function(){if(this.useCapacitorStorage&&!this.isRecovering){this.isRecovering=!0;try{const e=localStorage.getItem(this.config.tokenStorageKey),t=localStorage.getItem(this.config.tokenExpiryKey),{value:o}=await this.capacitorPreferences.get({key:this.config.tokenStorageKey}),{value:s}=await this.capacitorPreferences.get({key:this.config.refreshTokenStorageKey}),{value:r}=await this.capacitorPreferences.get({key:this.config.tokenExpiryKey});let n=!1,i="";if(!e&&o)n=!0,i="localStorage empty";else if(e&&o&&r&&t){const e=parseInt(t,10);parseInt(r,10)>e&&(n=!0,i="Capacitor has fresher token")}else e&&o&&!t&&r&&(n=!0,i="localStorage missing expiry");if(n&&o){console.log("[NexusAuth] Recovering tokens from Capacitor Preferences ("+i+")..."),localStorage.setItem(this.config.tokenStorageKey,o),s&&localStorage.setItem(this.config.tokenStorageKey+"_refresh",s);const{value:e}=await this.capacitorPreferences.get({key:this.config.userStorageKey});r&&localStorage.setItem(this.config.tokenExpiryKey,r),e&&localStorage.setItem(this.config.userStorageKey,e),console.log("[NexusAuth] Auth state recovered from persistent storage")}if(this.getToken()){if(this.getTokenTimeRemaining()<=0){console.log("[NexusAuth] Token expired, attempting refresh...");await this.refreshAccessToken()||(console.log("[NexusAuth] Token refresh failed, clearing tokens only"),await this.clearTokens())}else this.tokenNeedsRefresh()&&(console.log("[NexusAuth] Token needs refresh, refreshing..."),await this.refreshAccessToken())}}catch(e){console.error("[NexusAuth] Error recovering auth state:",e)}finally{this.isRecovering=!1}}},setupNetworkHandler:function(){const e=this;if(this.isNativeApp()&&"undefined"!=typeof Capacitor&&Capacitor.Plugins.Network)try{const t=Capacitor.Plugins.Network;t.getStatus().then(t=>{e.networkConnected=t.connected,console.log("[NexusAuth] Initial network status:",t.connected?"online":"offline")}),t.addListener("networkStatusChange",t=>{const o=!e.networkConnected;e.networkConnected=t.connected,console.log("[NexusAuth] Network status changed:",t.connected?"online":"offline"),o&&t.connected&&(console.log("[NexusAuth] Back online, waiting for stable connection..."),setTimeout(()=>{e.networkConnected&&(console.log("[NexusAuth] Connection stable, refreshing auth..."),e.checkAndRefreshToken(),e.sendHeartbeat())},1e3))})}catch(e){console.log("[NexusAuth] Network plugin not available")}window.addEventListener("online",()=>{const t=!e.networkConnected;e.networkConnected=!0,console.log("[NexusAuth] Browser online event"),t&&setTimeout(()=>{e.networkConnected&&(console.log("[NexusAuth] Network stable, refreshing auth..."),e.checkAndRefreshToken(),e.sendHeartbeat())},1e3)}),window.addEventListener("offline",()=>{e.networkConnected=!1,console.log("[NexusAuth] Browser offline")})},isNetworkAvailable:async function(){if(!this.networkConnected)return!1;if(this.isNativeApp()&&"undefined"!=typeof Capacitor&&Capacitor.Plugins.Network)try{const e=Capacitor.Plugins.Network,t=await e.getStatus();return this.networkConnected=t.connected,t.connected}catch(e){}return navigator.onLine},startHeartbeat:function(){const e=this;this.stopHeartbeat(),this.isLoggedIn()?(this.heartbeatTimer=setInterval(()=>{e.sendHeartbeat()},this.config.heartbeatInterval),this.sendHeartbeat(),console.log("[NexusAuth] Heartbeat started")):console.log("[NexusAuth] Not logged in, skipping heartbeat")},stopHeartbeat:function(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null,console.log("[NexusAuth] Heartbeat stopped"))},sendHeartbeat:async function(){if(this._heartbeatInProgress)return void console.log("[NexusAuth] Heartbeat already in progress, skipping");this._heartbeatInProgress=!0;if(!await this.isNetworkAvailable())return console.log("[NexusAuth] Skipping heartbeat - offline"),void(this._heartbeatInProgress=!1);try{const e={"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"};this.isNativeApp()&&(e["X-Capacitor-App"]="true");const t=this.getToken();t&&(e.Authorization="Bearer "+t);const o=await fetch(this.config.heartbeatEndpoint,{method:"POST",credentials:"include",headers:e});if(o.ok){const e=await o.json();console.log("[NexusAuth] Heartbeat OK, session valid"),this.heartbeatFailCount=0,this.networkFailCount=0,e.expires_at&&(this.sessionExpiresAt=new Date(e.expires_at)),e.token&&(e.token.needs_refresh?(console.log("[NexusAuth] Heartbeat indicates token needs refresh"),this.refreshAccessToken()):e.token.time_remaining&&this.setTokenExpiry(e.token.time_remaining))}else if(401===o.status){console.log("[NexusAuth] Heartbeat 401 - session may have expired"),console.log("[NexusAuth] Has token:",!!this.getToken(),"Has refresh:",!!this.getRefreshToken());this.getRefreshToken()&&(console.log("[NexusAuth] Attempting silent token refresh..."),await this.refreshAccessToken())}else console.log("[NexusAuth] Heartbeat server error: "+o.status)}catch(e){console.log("[NexusAuth] Heartbeat network error:",e.message||e)}finally{this._heartbeatInProgress=!1}},setupActivityTracking:function(){const e=this;["mousedown","mousemove","keydown","scroll","touchstart"].forEach(t=>{document.addEventListener(t,()=>{e.lastActivity=Date.now()},{passive:!0,once:!1})})},setupVisibilityHandler:function(){const e=this;if(document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&(console.log("[NexusAuth] App visible, checking auth status..."),e.sendHeartbeat(),e.checkAndRefreshToken())}),this.isNativeApp()&&"undefined"!=typeof Capacitor)try{const t=Capacitor.Plugins.App;t&&t.addListener("appStateChange",t=>{t.isActive&&(console.log("[NexusAuth] Native app active, checking auth status..."),e.sendHeartbeat(),e.checkAndRefreshToken())})}catch(e){console.log("[NexusAuth] Could not setup Capacitor app state listener")}},isLoggedIn:function(){const e=this.getToken(),t=this.getRefreshToken();if(e&&t){if(this.getTokenTimeRemaining()>0||t)return!0}if(!document.body)return!1;if(document.body.classList.contains("logged-in"))return!0;if(document.body.dataset&&"true"===document.body.dataset.sessionActive)return!0;const o=document.querySelector("[data-user-id]");return!!(o&&o.dataset&&o.dataset.userId&&""!==o.dataset.userId)},isAuthRequiredPage:function(){const e=window.location.pathname,t=["login","register","forgot-password","reset-password","listings","groups","events","leaderboard","leaderboards","directory","about","contact","terms","privacy","faq","help","search","blog","news","feed","home"];if(document.body&&document.body.hasAttribute("data-public-page"))return!1;if("/"===e||e.match(/^\/[a-z-]+\/?$/i)&&e.split("/").filter(Boolean).length<=1){if(0===e.split("/").filter(Boolean).length)return!1}if(!e||"string"!=typeof e)return console.warn("[NexusAuth] Path is undefined or invalid:",e),!1;const o=e.toLowerCase().split("/").filter(Boolean);for(const e of o)if(t.includes(e))return!1;if(o.includes("profile")&&o.length>=2){const e=o.indexOf("profile"),t=o[e+1];if(t&&"edit"!==t&&"settings"!==t)return!1}return!o.includes("page")},isNativeApp:function(){return"undefined"!=typeof Capacitor&&Capacitor.isNativePlatform&&Capacitor.isNativePlatform()},setToken:function(e){try{localStorage.setItem(this.config.tokenStorageKey,e),this.useCapacitorStorage&&this.capacitorPreferences&&this.capacitorPreferences.set({key:this.config.tokenStorageKey,value:e}).catch(e=>console.error("[NexusAuth] Capacitor storage error:",e))}catch(e){console.error("[NexusAuth] Could not store token:",e)}},getToken:function(){try{return localStorage.getItem(this.config.tokenStorageKey)}catch(e){return null}},setRefreshToken:function(e){try{localStorage.setItem(this.config.tokenStorageKey+"_refresh",e),this.useCapacitorStorage&&this.capacitorPreferences&&this.capacitorPreferences.set({key:this.config.refreshTokenStorageKey,value:e}).catch(e=>console.error("[NexusAuth] Capacitor storage error:",e))}catch(e){console.error("[NexusAuth] Could not store refresh token:",e)}},getRefreshToken:function(){try{return localStorage.getItem(this.config.tokenStorageKey+"_refresh")}catch(e){return null}},setUser:function(e){try{const t=JSON.stringify(e);localStorage.setItem(this.config.userStorageKey,t),this.useCapacitorStorage&&this.capacitorPreferences&&this.capacitorPreferences.set({key:this.config.userStorageKey,value:t}).catch(e=>console.error("[NexusAuth] Capacitor storage error:",e))}catch(e){console.error("[NexusAuth] Could not store user data:",e)}},getUser:function(){try{const e=localStorage.getItem(this.config.userStorageKey);return e?JSON.parse(e):null}catch(e){return null}},clearAuth:function(){try{localStorage.removeItem(this.config.tokenStorageKey),localStorage.removeItem(this.config.tokenStorageKey+"_refresh"),localStorage.removeItem(this.config.tokenExpiryKey),localStorage.removeItem(this.config.userStorageKey),this.useCapacitorStorage&&this.capacitorPreferences&&(this.capacitorPreferences.remove({key:this.config.tokenStorageKey}).catch(()=>{}),this.capacitorPreferences.remove({key:this.config.refreshTokenStorageKey}).catch(()=>{}),this.capacitorPreferences.remove({key:this.config.tokenExpiryKey}).catch(()=>{}),this.capacitorPreferences.remove({key:this.config.userStorageKey}).catch(()=>{}))}catch(e){console.error("[NexusAuth] Could not clear auth data:",e)}},clearTokens:async function(){try{localStorage.removeItem(this.config.tokenStorageKey),localStorage.removeItem(this.config.tokenStorageKey+"_refresh"),localStorage.removeItem(this.config.tokenExpiryKey),this.useCapacitorStorage&&this.capacitorPreferences&&(await this.capacitorPreferences.remove({key:this.config.tokenStorageKey}).catch(()=>{}),await this.capacitorPreferences.remove({key:this.config.refreshTokenStorageKey}).catch(()=>{}),await this.capacitorPreferences.remove({key:this.config.tokenExpiryKey}).catch(()=>{})),console.log("[NexusAuth] Tokens cleared (user data preserved)")}catch(e){console.error("[NexusAuth] Could not clear tokens:",e)}},logout:async function(){this.stopHeartbeat(),this.stopTokenRefreshTimer(),this.clearAuth();try{await fetch("/api/auth/logout",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}}),console.log("[NexusAuth] Server logout successful")}catch(e){console.log("[NexusAuth] Server logout failed (may already be logged out)")}},setTokenExpiry:function(e){try{const t=(Date.now()+1e3*e).toString();localStorage.setItem(this.config.tokenExpiryKey,t),this.useCapacitorStorage&&this.capacitorPreferences&&this.capacitorPreferences.set({key:this.config.tokenExpiryKey,value:t}).catch(e=>console.error("[NexusAuth] Capacitor storage error:",e))}catch(e){console.error("[NexusAuth] Could not store token expiry:",e)}},getTokenExpiry:function(){try{const e=localStorage.getItem(this.config.tokenExpiryKey);return e?parseInt(e,10):null}catch(e){return null}},getTokenTimeRemaining:function(){const e=this.getTokenExpiry();return e?Math.floor((e-Date.now())/1e3):-1},tokenNeedsRefresh:function(){return this.getTokenTimeRemaining()<this.config.tokenRefreshThreshold},startTokenRefreshTimer:function(){const e=this;this.stopTokenRefreshTimer(),this.tokenRefreshTimer=setInterval(()=>{e.checkAndRefreshToken()},this.config.tokenRefreshInterval),this.checkAndRefreshToken(),console.log("[NexusAuth] Token refresh timer started")},stopTokenRefreshTimer:function(){this.tokenRefreshTimer&&(clearInterval(this.tokenRefreshTimer),this.tokenRefreshTimer=null)},checkAndRefreshToken:async function(){const e=this.getToken(),t=this.getRefreshToken();e&&t&&this.tokenNeedsRefresh()&&(console.log("[NexusAuth] Token needs refresh, refreshing..."),await this.refreshAccessToken())},refreshAccessToken:async function(){if(this.isRefreshing)return console.log("[NexusAuth] Refresh already in progress, waiting..."),this.refreshPromise;const e=this.getRefreshToken();return e?(this.isRefreshing=!0,this.refreshPromise=(async()=>{try{const t=await fetch(this.config.refreshTokenEndpoint,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({refresh_token:e})});if(t.ok){const e=await t.json();return e.access_token&&(this.setToken(e.access_token),this.setTokenExpiry(e.expires_in||3600),console.log("[NexusAuth] Access token refreshed successfully")),e.refresh_token&&(this.setRefreshToken(e.refresh_token),console.log("[NexusAuth] Refresh token updated")),!0}return 401===t.status?(console.log("[NexusAuth] Refresh token expired/invalid"),await this.clearTokens(),!1):(console.log("[NexusAuth] Token refresh failed:",t.status),!1)}catch(e){return console.error("[NexusAuth] Token refresh error:",e),!1}finally{this.isRefreshing=!1,this.refreshPromise=null}})(),this.refreshPromise):(console.log("[NexusAuth] No refresh token available"),!1)},setupFetchInterceptor:function(){const e=this,t=window.fetch;window.fetch=async function(o,s={}){const r="string"==typeof o?o:o.url,n=r.startsWith("/api/")||r.startsWith(window.location.origin+"/api/"),i=r.includes("/api/auth/refresh-token")||r.includes("/api/auth/login")||r.includes("/api/auth/heartbeat");if(n&&!i){if(e.tokenNeedsRefresh()&&e.getRefreshToken()){console.log("[NexusAuth] Pre-flight token refresh...");await e.refreshAccessToken()||console.log("[NexusAuth] Pre-flight refresh failed, proceeding without token")}s.headers=s.headers||{},e.isNativeApp()&&(s.headers instanceof Headers?s.headers.set("X-Capacitor-App","true"):s.headers["X-Capacitor-App"]="true");const t=e.getToken();t&&(s.headers instanceof Headers?s.headers.set("Authorization","Bearer "+t):s.headers.Authorization="Bearer "+t)}let a=await t.call(window,o,s);if(401===a.status&&n&&!i){console.log("[NexusAuth] Got 401, attempting token refresh...");if(await e.refreshAccessToken()){const r=e.getToken();r&&(s.headers=s.headers||{},s.headers instanceof Headers?s.headers.set("Authorization","Bearer "+r):s.headers.Authorization="Bearer "+r),console.log("[NexusAuth] Retrying request with new token..."),a=await t.call(window,o,s)}}return a},console.log("[NexusAuth] Fetch interceptor installed")},onLoginSuccess:async function(e){if(await this.initStorage(),this.detectAndConfigurePlatform(),e.access_token?this.setToken(e.access_token):e.token&&this.setToken(e.token),e.refresh_token&&this.setRefreshToken(e.refresh_token),e.expires_in)this.setTokenExpiry(e.expires_in);else{const e=this.isMobileDevice()?604800:7200;this.setTokenExpiry(e)}e.user&&this.setUser(e.user),this.setupFetchInterceptor(),this.setupNetworkHandler(),this.startHeartbeat(),this.startTokenRefreshTimer();const t=this.isMobileDevice()?"mobile":"desktop";console.log("[NexusAuth] Login successful on "+t+", auth handler activated")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>NexusAuth.init()):NexusAuth.init()}();