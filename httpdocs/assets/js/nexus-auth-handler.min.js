!function(){"use strict";window.NexusAuth={config:{heartbeatInterval:12e4,tokenRefreshInterval:12e4,tokenRefreshThreshold:600,heartbeatEndpoint:"/api/auth/heartbeat",checkSessionEndpoint:"/api/auth/check-session",refreshTokenEndpoint:"/api/auth/refresh-token",tokenStorageKey:"nexus_auth_token",tokenExpiryKey:"nexus_token_expiry",userStorageKey:"nexus_user_data",refreshTokenStorageKey:"nexus_refresh_token",platformStorageKey:"nexus_platform"},heartbeatTimer:null,tokenRefreshTimer:null,isRefreshing:!1,refreshPromise:null,lastActivity:Date.now(),storageReady:!1,useCapacitorStorage:!1,capacitorPreferences:null,isRecovering:!1,networkConnected:!0,init:async function(){if(await this.initStorage(),this.detectAndConfigurePlatform(),await this.recoverAuthState(),!this.isLoggedIn())return void console.warn("[NexusAuth] Not logged in, skipping initialization");this.isMobileDevice()&&await this.ensureSessionSync(),this.setupActivityTracking(),this.startHeartbeat(),this.startTokenRefreshTimer(),this.setupVisibilityHandler(),this.setupFetchInterceptor(),this.setupNetworkHandler();const e=this.isMobileDevice()?"mobile":"desktop";console.warn("[NexusAuth] Auth handler initialized for "+e+" platform")},ensureSessionSync:async function(){const e=this.getToken();if(!e)return void console.warn("[NexusAuth] No token for session sync");const t=sessionStorage.getItem("nexus_session_synced"),s=t?parseInt(t,10):0,o=Date.now()-3e5,n=!document.body.classList.contains("logged-in")&&!document.querySelector("[data-user-id]")&&(document.querySelector('a[href*="/login"]')||document.querySelector(".login-btn"));if(!n&&s>o)console.warn("[NexusAuth] Session sync not needed (recently synced or page shows logged in)");else try{console.warn("[NexusAuth] Syncing PHP session with token...");const t={"Content-Type":"application/json",Authorization:"Bearer "+e,"X-Requested-With":"XMLHttpRequest"};this.isNativeApp()&&(t["X-Capacitor-App"]="true"),this.isMobileDevice()&&(t["X-Nexus-Mobile"]="true");const s=await fetch("/api/auth/restore-session",{method:"POST",credentials:"include",headers:t});if(s.ok){const e=await s.json();console.warn("[NexusAuth] Session synced successfully:",e),sessionStorage.setItem("nexus_session_synced",Date.now().toString()),n&&(console.warn("[NexusAuth] Page showed logged out, reloading to refresh..."),window.location.reload())}else if(console.warn("[NexusAuth] Session sync failed:",s.status),401===s.status){await this.refreshAccessToken()&&(sessionStorage.setItem("nexus_session_synced",Date.now().toString()),await this.ensureSessionSync())}}catch(e){console.error("[NexusAuth] Session sync error:",e)}},detectAndConfigurePlatform:function(){const e=this.isMobileDevice();e?(this.config.heartbeatInterval=6e5,this.config.tokenRefreshInterval=6e5,this.config.tokenRefreshThreshold=86400,console.warn("[NexusAuth] Mobile platform detected - using persistent login settings")):(this.config.heartbeatInterval=12e4,this.config.tokenRefreshInterval=12e4,this.config.tokenRefreshThreshold=600,console.warn("[NexusAuth] Desktop platform detected - using standard settings"));try{localStorage.setItem(this.config.platformStorageKey,e?"mobile":"web")}catch(e){}},isMobileDevice:function(){if(this.isNativeApp())return!0;const e=navigator.userAgent||"";return/Mobile|Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(e)},initStorage:async function(){if(!this.storageReady){try{this.isNativeApp()&&"undefined"!=typeof Capacitor&&Capacitor.Plugins.Preferences?(this.capacitorPreferences=Capacitor.Plugins.Preferences,this.useCapacitorStorage=!0,console.warn("[NexusAuth] Using Capacitor Preferences for persistent storage")):(this.useCapacitorStorage=!1,console.warn("[NexusAuth] Using localStorage (web mode)"))}catch(e){this.useCapacitorStorage=!1,console.warn("[NexusAuth] Capacitor Preferences not available, using localStorage")}this.storageReady=!0}},recoverAuthState:async function(){if(this.useCapacitorStorage&&!this.isRecovering){this.isRecovering=!0;try{const e=localStorage.getItem(this.config.tokenStorageKey),t=localStorage.getItem(this.config.tokenExpiryKey),{value:s}=await this.capacitorPreferences.get({key:this.config.tokenStorageKey}),{value:o}=await this.capacitorPreferences.get({key:this.config.refreshTokenStorageKey}),{value:n}=await this.capacitorPreferences.get({key:this.config.tokenExpiryKey});let r=!1,i="";if(!e&&s)r=!0,i="localStorage empty";else if(e&&s&&n&&t){const e=parseInt(t,10);parseInt(n,10)>e&&(r=!0,i="Capacitor has fresher token")}else e&&s&&!t&&n&&(r=!0,i="localStorage missing expiry");if(r&&s){console.warn("[NexusAuth] Recovering tokens from Capacitor Preferences ("+i+")..."),localStorage.setItem(this.config.tokenStorageKey,s),o&&localStorage.setItem(this.config.tokenStorageKey+"_refresh",o);const{value:e}=await this.capacitorPreferences.get({key:this.config.userStorageKey});n&&localStorage.setItem(this.config.tokenExpiryKey,n),e&&localStorage.setItem(this.config.userStorageKey,e),console.warn("[NexusAuth] Auth state recovered from persistent storage")}const a=this.getToken(),c=this.getRefreshToken(),h=this.getTokenTimeRemaining();if(console.warn("[NexusAuth] Post-recovery token state:",{hasToken:!!a,hasRefresh:!!c,remaining:h,needsRefresh:this.tokenNeedsRefresh()}),a)if(h<=0){console.warn("[NexusAuth] Token expired, attempting refresh...");await this.refreshAccessToken()||(this.getRefreshToken()?console.warn("[NexusAuth] Token refresh failed but keeping refresh token for later retry"):(console.warn("[NexusAuth] Token refresh failed and no refresh token, clearing tokens"),await this.clearTokens()))}else this.tokenNeedsRefresh()&&(console.warn("[NexusAuth] Token needs refresh, refreshing..."),await this.refreshAccessToken());else c&&(console.warn("[NexusAuth] No access token but have refresh token, attempting refresh..."),await this.refreshAccessToken())}catch(e){console.error("[NexusAuth] Error recovering auth state:",e)}finally{this.isRecovering=!1}}},setupNetworkHandler:function(){const e=this;if(this.isNativeApp()&&"undefined"!=typeof Capacitor&&Capacitor.Plugins.Network)try{const t=Capacitor.Plugins.Network;t.getStatus().then(t=>{e.networkConnected=t.connected,console.warn("[NexusAuth] Initial network status:",t.connected?"online":"offline")}),t.addListener("networkStatusChange",t=>{const s=!e.networkConnected;e.networkConnected=t.connected,console.warn("[NexusAuth] Network status changed:",t.connected?"online":"offline"),s&&t.connected&&(console.warn("[NexusAuth] Back online, waiting for stable connection..."),setTimeout(()=>{e.networkConnected&&(console.warn("[NexusAuth] Connection stable, refreshing auth..."),e.checkAndRefreshToken(),e.sendHeartbeat())},1e3))})}catch(e){console.warn("[NexusAuth] Network plugin not available")}window.addEventListener("online",()=>{const t=!e.networkConnected;e.networkConnected=!0,console.warn("[NexusAuth] Browser online event"),t&&setTimeout(()=>{e.networkConnected&&(console.warn("[NexusAuth] Network stable, refreshing auth..."),e.checkAndRefreshToken(),e.sendHeartbeat())},1e3)}),window.addEventListener("offline",()=>{e.networkConnected=!1,console.warn("[NexusAuth] Browser offline")})},isNetworkAvailable:async function(){if(!this.networkConnected)return!1;if(this.isNativeApp()&&"undefined"!=typeof Capacitor&&Capacitor.Plugins.Network)try{const e=Capacitor.Plugins.Network,t=await e.getStatus();return this.networkConnected=t.connected,t.connected}catch(e){}return navigator.onLine},startHeartbeat:function(){const e=this;this.stopHeartbeat(),this.isLoggedIn()?(this.heartbeatTimer=setInterval(()=>{e.sendHeartbeat()},this.config.heartbeatInterval),this.sendHeartbeat(),console.warn("[NexusAuth] Heartbeat started")):console.warn("[NexusAuth] Not logged in, skipping heartbeat")},stopHeartbeat:function(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null,console.warn("[NexusAuth] Heartbeat stopped"))},sendHeartbeat:async function(){if(this._heartbeatInProgress)return void console.warn("[NexusAuth] Heartbeat already in progress, skipping");this._heartbeatInProgress=!0;if(!await this.isNetworkAvailable())return console.warn("[NexusAuth] Skipping heartbeat - offline"),void(this._heartbeatInProgress=!1);try{const e={"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"};this.isNativeApp()&&(e["X-Capacitor-App"]="true"),this.isMobileDevice()&&(e["X-Nexus-Mobile"]="true");const t=this.getToken();t&&(e.Authorization="Bearer "+t);const s=await fetch(this.config.heartbeatEndpoint,{method:"POST",credentials:"include",headers:e});if(s.ok){const e=await s.json();console.warn("[NexusAuth] Heartbeat OK, session valid"),this.heartbeatFailCount=0,this.networkFailCount=0,e.expires_at&&(this.sessionExpiresAt=new Date(e.expires_at)),e.token&&(e.token.needs_refresh?(console.warn("[NexusAuth] Heartbeat indicates token needs refresh"),this.refreshAccessToken()):e.token.time_remaining&&this.setTokenExpiry(e.token.time_remaining))}else if(401===s.status){console.warn("[NexusAuth] Heartbeat 401 - session may have expired"),console.warn("[NexusAuth] Has token:",!!this.getToken(),"Has refresh:",!!this.getRefreshToken());this.getRefreshToken()&&(console.warn("[NexusAuth] Attempting silent token refresh..."),await this.refreshAccessToken())}else console.warn("[NexusAuth] Heartbeat server error: "+s.status)}catch(e){console.warn("[NexusAuth] Heartbeat network error:",e.message||e)}finally{this._heartbeatInProgress=!1}},setupActivityTracking:function(){const e=this;["mousedown","mousemove","keydown","scroll","touchstart"].forEach(t=>{document.addEventListener(t,()=>{e.lastActivity=Date.now()},{passive:!0,once:!1})})},setupVisibilityHandler:function(){const e=this;if(document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&(console.warn("[NexusAuth] App visible, checking auth status..."),e.sendHeartbeat(),e.checkAndRefreshToken())}),this.isNativeApp()&&"undefined"!=typeof Capacitor)try{const t=Capacitor.Plugins.App;t&&t.addListener("appStateChange",t=>{t.isActive&&(console.warn("[NexusAuth] Native app active, checking auth status..."),e.sendHeartbeat(),e.checkAndRefreshToken())})}catch(e){console.warn("[NexusAuth] Could not setup Capacitor app state listener")}},isLoggedIn:function(){const e=this.getToken(),t=this.getRefreshToken(),s=this.getTokenTimeRemaining();if(console.warn("[NexusAuth] isLoggedIn check:",{hasToken:!!e,hasRefreshToken:!!t,tokenTimeRemaining:s}),t)return!0;if(e&&s>0)return!0;if(!document.body)return!1;if(document.body.classList.contains("logged-in"))return!0;if(document.body.dataset&&"true"===document.body.dataset.sessionActive)return!0;const o=document.querySelector("[data-user-id]");return!!(o&&o.dataset&&o.dataset.userId&&""!==o.dataset.userId)},isAuthRequiredPage:function(){const e=window.location.pathname,t=["login","register","forgot-password","reset-password","listings","groups","events","leaderboard","leaderboards","directory","about","contact","terms","privacy","faq","help","search","blog","news","feed","home"];if(document.body&&document.body.hasAttribute("data-public-page"))return!1;if("/"===e||e.match(/^\/[a-z-]+\/?$/i)&&e.split("/").filter(Boolean).length<=1){if(0===e.split("/").filter(Boolean).length)return!1}if(!e||"string"!=typeof e)return console.warn("[NexusAuth] Path is undefined or invalid:",e),!1;const s=e.toLowerCase().split("/").filter(Boolean);for(const e of s)if(t.includes(e))return!1;if(s.includes("profile")&&s.length>=2){const e=s.indexOf("profile"),t=s[e+1];if(t&&"edit"!==t&&"settings"!==t)return!1}return!s.includes("page")},isNativeApp:function(){return"undefined"!=typeof Capacitor&&Capacitor.isNativePlatform&&Capacitor.isNativePlatform()},setToken:function(e){try{localStorage.setItem(this.config.tokenStorageKey,e),this.useCapacitorStorage&&this.capacitorPreferences&&this.capacitorPreferences.set({key:this.config.tokenStorageKey,value:e}).catch(e=>console.error("[NexusAuth] Capacitor storage error:",e))}catch(e){console.error("[NexusAuth] Could not store token:",e)}},getToken:function(){try{return localStorage.getItem(this.config.tokenStorageKey)}catch(e){return null}},setRefreshToken:function(e){try{localStorage.setItem(this.config.tokenStorageKey+"_refresh",e),this.useCapacitorStorage&&this.capacitorPreferences&&this.capacitorPreferences.set({key:this.config.refreshTokenStorageKey,value:e}).catch(e=>console.error("[NexusAuth] Capacitor storage error:",e))}catch(e){console.error("[NexusAuth] Could not store refresh token:",e)}},getRefreshToken:function(){try{return localStorage.getItem(this.config.tokenStorageKey+"_refresh")}catch(e){return null}},setUser:function(e){try{const t=JSON.stringify(e);localStorage.setItem(this.config.userStorageKey,t),this.useCapacitorStorage&&this.capacitorPreferences&&this.capacitorPreferences.set({key:this.config.userStorageKey,value:t}).catch(e=>console.error("[NexusAuth] Capacitor storage error:",e))}catch(e){console.error("[NexusAuth] Could not store user data:",e)}},getUser:function(){try{const e=localStorage.getItem(this.config.userStorageKey);return e?JSON.parse(e):null}catch(e){return null}},clearAuth:function(){try{localStorage.removeItem(this.config.tokenStorageKey),localStorage.removeItem(this.config.tokenStorageKey+"_refresh"),localStorage.removeItem(this.config.tokenExpiryKey),localStorage.removeItem(this.config.userStorageKey),this.useCapacitorStorage&&this.capacitorPreferences&&(this.capacitorPreferences.remove({key:this.config.tokenStorageKey}).catch(()=>{}),this.capacitorPreferences.remove({key:this.config.refreshTokenStorageKey}).catch(()=>{}),this.capacitorPreferences.remove({key:this.config.tokenExpiryKey}).catch(()=>{}),this.capacitorPreferences.remove({key:this.config.userStorageKey}).catch(()=>{}))}catch(e){console.error("[NexusAuth] Could not clear auth data:",e)}},clearTokens:async function(){try{localStorage.removeItem(this.config.tokenStorageKey),localStorage.removeItem(this.config.tokenStorageKey+"_refresh"),localStorage.removeItem(this.config.tokenExpiryKey),this.useCapacitorStorage&&this.capacitorPreferences&&(await this.capacitorPreferences.remove({key:this.config.tokenStorageKey}).catch(()=>{}),await this.capacitorPreferences.remove({key:this.config.refreshTokenStorageKey}).catch(()=>{}),await this.capacitorPreferences.remove({key:this.config.tokenExpiryKey}).catch(()=>{})),console.warn("[NexusAuth] Tokens cleared (user data preserved)")}catch(e){console.error("[NexusAuth] Could not clear tokens:",e)}},logout:async function(){this.stopHeartbeat(),this.stopTokenRefreshTimer(),this.clearAuth();try{await fetch("/api/auth/logout",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}}),console.warn("[NexusAuth] Server logout successful")}catch(e){console.warn("[NexusAuth] Server logout failed (may already be logged out)")}},setTokenExpiry:function(e){try{const t=(Date.now()+1e3*e).toString();localStorage.setItem(this.config.tokenExpiryKey,t),this.useCapacitorStorage&&this.capacitorPreferences&&this.capacitorPreferences.set({key:this.config.tokenExpiryKey,value:t}).catch(e=>console.error("[NexusAuth] Capacitor storage error:",e))}catch(e){console.error("[NexusAuth] Could not store token expiry:",e)}},getTokenExpiry:function(){try{const e=localStorage.getItem(this.config.tokenExpiryKey);return e?parseInt(e,10):null}catch(e){return null}},getTokenTimeRemaining:function(){const e=this.getTokenExpiry();return e?Math.floor((e-Date.now())/1e3):-1},tokenNeedsRefresh:function(){return this.getTokenTimeRemaining()<this.config.tokenRefreshThreshold},startTokenRefreshTimer:function(){const e=this;this.stopTokenRefreshTimer(),this.tokenRefreshTimer=setInterval(()=>{e.checkAndRefreshToken()},this.config.tokenRefreshInterval),this.checkAndRefreshToken(),console.warn("[NexusAuth] Token refresh timer started")},stopTokenRefreshTimer:function(){this.tokenRefreshTimer&&(clearInterval(this.tokenRefreshTimer),this.tokenRefreshTimer=null)},checkAndRefreshToken:async function(){const e=this.getToken(),t=this.getRefreshToken();e&&t&&this.tokenNeedsRefresh()&&(console.warn("[NexusAuth] Token needs refresh, refreshing..."),await this.refreshAccessToken())},refreshAccessToken:async function(){if(this.isRefreshing)return console.warn("[NexusAuth] Refresh already in progress, waiting..."),this.refreshPromise;const e=this.getRefreshToken();return e?(this.isRefreshing=!0,this.refreshPromise=(async()=>{try{const t={"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"};this.isNativeApp()&&(t["X-Capacitor-App"]="true"),this.isMobileDevice()&&(t["X-Nexus-Mobile"]="true");const s=await fetch(this.config.refreshTokenEndpoint,{method:"POST",credentials:"include",headers:t,body:JSON.stringify({refresh_token:e})});if(s.ok){const e=await s.json();if(e.access_token){this.setToken(e.access_token);const t=this.isMobileDevice()?31536e3:7200;this.setTokenExpiry(e.expires_in||t),console.warn("[NexusAuth] Access token refreshed, expires_in:",e.expires_in||t)}return e.refresh_token&&(this.setRefreshToken(e.refresh_token),console.warn("[NexusAuth] Refresh token updated")),!0}if(401===s.status){console.warn("[NexusAuth] Refresh token rejected (401)");try{const e=await s.json();console.warn("[NexusAuth] Refresh error details:",e)}catch(e){}return console.warn("[NexusAuth] NOT clearing tokens - user may need to re-login manually"),!1}return console.warn("[NexusAuth] Token refresh failed:",s.status),!1}catch(e){return console.error("[NexusAuth] Token refresh error:",e),!1}finally{this.isRefreshing=!1,this.refreshPromise=null}})(),this.refreshPromise):(console.warn("[NexusAuth] No refresh token available"),!1)},setupFetchInterceptor:function(){const e=this,t=window.fetch;window.fetch=async function(s,o={}){const n="string"==typeof s?s:s.url,r=n.startsWith("/api/")||n.startsWith(window.location.origin+"/api/"),i=n.includes("/api/auth/refresh-token")||n.includes("/api/auth/login")||n.includes("/api/auth/heartbeat");if(r&&!i){if(e.tokenNeedsRefresh()&&e.getRefreshToken()){console.warn("[NexusAuth] Pre-flight token refresh...");await e.refreshAccessToken()||console.warn("[NexusAuth] Pre-flight refresh failed, proceeding without token")}o.headers=o.headers||{},e.isNativeApp()&&(o.headers instanceof Headers?o.headers.set("X-Capacitor-App","true"):o.headers["X-Capacitor-App"]="true");const t=e.getToken();t&&(o.headers instanceof Headers?o.headers.set("Authorization","Bearer "+t):o.headers.Authorization="Bearer "+t)}let a=await t.call(window,s,o);if(401===a.status&&r&&!i){console.warn("[NexusAuth] Got 401, attempting token refresh...");if(await e.refreshAccessToken()){const n=e.getToken();n&&(o.headers=o.headers||{},o.headers instanceof Headers?o.headers.set("Authorization","Bearer "+n):o.headers.Authorization="Bearer "+n),console.warn("[NexusAuth] Retrying request with new token..."),a=await t.call(window,s,o)}}return a},console.warn("[NexusAuth] Fetch interceptor installed")},onLoginSuccess:async function(e){if(await this.initStorage(),this.detectAndConfigurePlatform(),e.access_token?this.setToken(e.access_token):e.token&&this.setToken(e.token),e.refresh_token&&this.setRefreshToken(e.refresh_token),e.expires_in)this.setTokenExpiry(e.expires_in),console.warn("[NexusAuth] Token expiry set from server:",e.expires_in,"seconds (~"+Math.round(e.expires_in/86400)+" days)");else{const e=this.isMobileDevice()?31536e3:7200;this.setTokenExpiry(e),console.warn("[NexusAuth] Token expiry set to default:",e,"seconds")}e.user&&this.setUser(e.user),this.setupFetchInterceptor(),this.setupNetworkHandler(),this.startHeartbeat(),this.startTokenRefreshTimer();const t=this.isMobileDevice()?"mobile":"desktop";console.warn("[NexusAuth] Login successful on "+t+", auth handler activated")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>NexusAuth.init()):NexusAuth.init()}();