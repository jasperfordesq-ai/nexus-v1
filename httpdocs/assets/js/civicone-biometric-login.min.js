!function(){"use strict";async function e(){const e=document.getElementById("civicone-biometric-container"),t=document.getElementById("civicone-biometric-promo");if(window.PublicKeyCredential)try{if(!await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable())return;try{const i=await fetch("/api/webauthn/auth-challenge",{method:"POST",credentials:"include"});if(i.ok){const n=await i.json();n.allowCredentials&&n.allowCredentials.length>0?(e&&e.classList.add("show"),t&&t.classList.remove("show")):(e&&e.classList.remove("show"),t&&t.classList.add("show"))}else t&&t.classList.add("show")}catch(e){t&&t.classList.add("show")}}catch(e){console.log("[WebAuthn] Biometric check failed:",e)}}function t(e){const t=window.atob(e.replace(/-/g,"+").replace(/_/g,"/")),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i.buffer}function i(e){const t=new Uint8Array(e);let i="";for(let e=0;e<t.length;e++)i+=String.fromCharCode(t[e]);return window.btoa(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}window.civiconeBiometric={check:e,login:async function(){const e=document.getElementById("civicone-biometric-btn"),n=e.innerHTML;try{if(e.disabled=!0,e.innerHTML="<span>Authenticating...</span>",window.NexusPWA&&NexusPWA.Biometric){const e=await NexusPWA.Biometric.authenticate();e&&e.redirect?window.location.href=e.redirect:e&&e.success&&window.location.reload()}else{const e=await fetch("/api/webauthn/auth-challenge",{method:"POST",credentials:"include"});if(!e.ok)throw new Error("No biometric credentials found. Please login with password first.");const n=await e.json();n.challenge=t(n.challenge),n.allowCredentials&&(n.allowCredentials=n.allowCredentials.map(e=>({...e,id:t(e.id)})));const a=await navigator.credentials.get({publicKey:n}),o=await fetch("/api/webauthn/auth-verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:a.id,rawId:i(a.rawId),type:a.type,response:{clientDataJSON:i(a.response.clientDataJSON),authenticatorData:i(a.response.authenticatorData),signature:i(a.response.signature),userHandle:a.response.userHandle?i(a.response.userHandle):null}}),credentials:"include"});if(!o.ok)throw new Error("Biometric verification failed");{const e=await o.json();window.location.href=e.redirect||"/dashboard"}}}catch(t){console.error("[Biometric]",t),e.innerHTML=n,e.disabled=!1,"NotAllowedError"!==t.name&&alert(t.message||"Biometric login failed. Please use password.")}}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}();