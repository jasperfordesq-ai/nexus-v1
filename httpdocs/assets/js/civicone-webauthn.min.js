!function(){"use strict";window.CivicOneWebAuthn={isSupported:!1,isRegistered:!1,credential:null,init:function(){this.checkSupport(),this.isSupported?(this.checkRegistration(),this.initEventListeners(),console.log("[CivicOne WebAuthn] Initialized")):console.log("[CivicOne WebAuthn] Not supported in this browser")},checkSupport:function(){this.isSupported=!(!window.PublicKeyCredential||"function"!=typeof window.PublicKeyCredential),this.isSupported&&document.body.classList.add("webauthn-supported"),this.isSupported&&PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable&&PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable().then(e=>{e&&document.body.classList.add("biometrics-available")})},async checkRegistration(){try{const e=await fetch("/api/webauthn/status",{credentials:"include"});if(!e.ok)return;const t=await e.json();this.isRegistered=t.registered||!1,this.isRegistered&&document.body.classList.add("webauthn-registered")}catch(e){console.error("[CivicOne WebAuthn] Error checking registration:",e)}},initEventListeners:function(){document.addEventListener("click",e=>{e.target.closest("[data-webauthn-login]")&&(e.preventDefault(),this.authenticate()),e.target.closest("[data-webauthn-register]")&&(e.preventDefault(),this.register()),e.target.closest("[data-webauthn-remove]")&&(e.preventDefault(),this.removeCredential())})},async register(){if(this.isSupported)try{this.setButtonLoading("[data-webauthn-register]",!0);const e=await fetch("/api/webauthn/register/options",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error("Failed to get registration options");const t=await e.json();t.challenge=this.base64UrlDecode(t.challenge),t.user.id=this.base64UrlDecode(t.user.id),t.excludeCredentials&&(t.excludeCredentials=t.excludeCredentials.map(e=>({...e,id:this.base64UrlDecode(e.id)})));const i=await navigator.credentials.create({publicKey:t}),n={id:i.id,rawId:this.base64UrlEncode(i.rawId),type:i.type,response:{clientDataJSON:this.base64UrlEncode(i.response.clientDataJSON),attestationObject:this.base64UrlEncode(i.response.attestationObject)}},a=await fetch("/api/webauthn/register/verify",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!a.ok)throw new Error("Failed to verify registration");const s=await a.json();if(!s.success)throw new Error(s.error||"Registration failed");this.isRegistered=!0,document.body.classList.add("webauthn-registered"),this.showMessage("Biometric login enabled successfully!","success"),this.updateSecuritySettings()}catch(e){console.error("[CivicOne WebAuthn] Registration error:",e),"NotAllowedError"===e.name?this.showMessage("Biometric registration was cancelled.","warning"):"InvalidStateError"===e.name?this.showMessage("A biometric credential already exists for this account.","warning"):this.showMessage("Failed to enable biometric login. Please try again.","error")}finally{this.setButtonLoading("[data-webauthn-register]",!1)}else this.showMessage("Biometric authentication is not supported on this device.","error")},async authenticate(){if(this.isSupported)try{this.setButtonLoading("[data-webauthn-login]",!0);const e=await fetch("/api/webauthn/login/options",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error("Failed to get authentication options");const t=await e.json();t.challenge=this.base64UrlDecode(t.challenge),t.allowCredentials&&(t.allowCredentials=t.allowCredentials.map(e=>({...e,id:this.base64UrlDecode(e.id)})));const i=await navigator.credentials.get({publicKey:t}),n={id:i.id,rawId:this.base64UrlEncode(i.rawId),type:i.type,response:{clientDataJSON:this.base64UrlEncode(i.response.clientDataJSON),authenticatorData:this.base64UrlEncode(i.response.authenticatorData),signature:this.base64UrlEncode(i.response.signature),userHandle:i.response.userHandle?this.base64UrlEncode(i.response.userHandle):null}},a=await fetch("/api/webauthn/login/verify",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!a.ok)throw new Error("Authentication failed");const s=await a.json();if(!s.success)throw new Error(s.error||"Authentication failed");{this.showMessage("Login successful!","success");const e=s.redirect||"/dashboard";window.location.href=e}}catch(e){console.error("[CivicOne WebAuthn] Authentication error:",e),"NotAllowedError"===e.name?this.showMessage("Biometric login was cancelled.","warning"):"SecurityError"===e.name?this.showMessage("Please use HTTPS for biometric authentication.","error"):this.showMessage("Biometric login failed. Please try password login.","error")}finally{this.setButtonLoading("[data-webauthn-login]",!1)}else this.showMessage("Biometric authentication is not supported on this device.","error")},async removeCredential(){if(confirm("Remove biometric login from this account?"))try{this.setButtonLoading("[data-webauthn-remove]",!0);const e=await fetch("/api/webauthn/remove",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error("Failed to remove credential");const t=await e.json();if(!t.success)throw new Error(t.error||"Removal failed");this.isRegistered=!1,document.body.classList.remove("webauthn-registered"),this.showMessage("Biometric login has been removed.","success"),this.updateSecuritySettings()}catch(e){console.error("[CivicOne WebAuthn] Remove error:",e),this.showMessage("Failed to remove biometric login.","error")}finally{this.setButtonLoading("[data-webauthn-remove]",!1)}},base64UrlDecode:function(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),i=window.atob(t),n=new Uint8Array(i.length);for(let e=0;e<i.length;++e)n[e]=i.charCodeAt(e);return n.buffer},base64UrlEncode:function(e){const t=new Uint8Array(e);let i="";for(let e=0;e<t.byteLength;e++)i+=String.fromCharCode(t[e]);return window.btoa(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")},setButtonLoading:function(e,t){const i=document.querySelector(e);i&&(t?(i.disabled=!0,i.dataset.originalText=i.textContent,i.innerHTML='<span class="civic-spinner"></span> Please wait...',i.setAttribute("aria-busy","true")):(i.disabled=!1,i.textContent=i.dataset.originalText||i.textContent,i.removeAttribute("aria-busy")))},showMessage:function(e,t){if(window.CivicOneMobile&&CivicOneMobile.showToast)return void CivicOneMobile.showToast(e,t);const i=document.createElement("div");i.className=`civic-webauthn-alert civic-webauthn-alert--${t}`,i.setAttribute("role","alert"),i.setAttribute("aria-live","assertive"),i.textContent=e,document.body.appendChild(i),requestAnimationFrame(()=>{i.classList.add("visible")}),setTimeout(()=>{i.classList.remove("visible"),setTimeout(()=>i.remove(),300)},4e3)},updateSecuritySettings:function(){const e=document.querySelector("[data-webauthn-register]"),t=document.querySelector("[data-webauthn-remove]"),i=document.querySelector("[data-webauthn-status]");this.isRegistered?(e&&(e.style.display="none"),t&&(t.style.display=""),i&&(i.textContent="Enabled",i.className="civic-badge civic-badge--success")):(e&&(e.style.display=""),t&&(t.style.display="none"),i&&(i.textContent="Disabled",i.className="civic-badge civic-badge--neutral"))},autoPromptOnLogin:async function(){if(!this.isSupported)return;if(!document.querySelector("[data-login-form]"))return;if(!("true"===localStorage.getItem("webauthn-enabled")))return;const e=localStorage.getItem("webauthn-prompt-dismissed");e&&Date.now()-parseInt(e)<864e5||this.showBiometricLoginPrompt()},showBiometricLoginPrompt:function(){const e=document.createElement("div");e.id="civic-webauthn-modal",e.className="civic-webauthn-modal",e.setAttribute("role","dialog"),e.setAttribute("aria-labelledby","webauthn-modal-title"),e.setAttribute("aria-modal","true"),e.innerHTML='\n                <div class="civic-webauthn-modal-backdrop" data-webauthn-dismiss></div>\n                <div class="civic-webauthn-modal-content">\n                    <div class="civic-webauthn-modal-icon">\n                        <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">\n                            <path d="M12 1c-1.1 0-2 .9-2 2v2C6.69 5 4 7.69 4 11v5l-2 2v1h20v-1l-2-2v-5c0-3.31-2.69-6-6-6V3c0-1.1-.9-2-2-2zm0 5c2.76 0 5 2.24 5 5v6H7v-6c0-2.76 2.24-5 5-5zm0 8c-.83 0-1.5.67-1.5 1.5S11.17 17 12 17s1.5-.67 1.5-1.5S12.83 14 12 14z"/>\n                        </svg>\n                    </div>\n                    <h2 id="webauthn-modal-title">Use Biometric Login?</h2>\n                    <p>Sign in quickly using your fingerprint or face recognition.</p>\n                    <div class="civic-webauthn-modal-actions">\n                        <button type="button" class="civic-btn civic-btn--primary" data-webauthn-login>\n                            Use Biometrics\n                        </button>\n                        <button type="button" class="civic-btn civic-btn--secondary" data-webauthn-dismiss>\n                            Use Password\n                        </button>\n                    </div>\n                </div>\n            ',document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("visible")}),e.querySelectorAll("[data-webauthn-dismiss]").forEach(t=>{t.addEventListener("click",()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300),localStorage.setItem("webauthn-prompt-dismissed",Date.now())})}),setTimeout(()=>{e.querySelector("[data-webauthn-login]").focus()},100),this.trapFocus(e)},trapFocus:function(e){const t=e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),i=t[0],n=t[t.length-1];e.addEventListener("keydown",t=>{if("Tab"===t.key&&(t.shiftKey&&document.activeElement===i?(t.preventDefault(),n.focus()):t.shiftKey||document.activeElement!==n||(t.preventDefault(),i.focus())),"Escape"===t.key){const t=e.querySelector("[data-webauthn-dismiss]");t&&t.click()}})}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{CivicOneWebAuthn.init(),CivicOneWebAuthn.autoPromptOnLogin()}):(CivicOneWebAuthn.init(),CivicOneWebAuthn.autoPromptOnLogin())}();