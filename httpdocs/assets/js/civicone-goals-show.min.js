!function(){"use strict";!function(){const t=document.getElementById("offlineBanner");function e(){t.classList.add("visible"),navigator.vibrate&&navigator.vibrate(100)}t&&(window.addEventListener("online",function(){t.classList.remove("visible")}),window.addEventListener("offline",e),navigator.onLine||e())}(),document.querySelectorAll("form").forEach(t=>{t.addEventListener("submit",function(t){if(!navigator.onLine)return t.preventDefault(),void alert("You are offline. Please connect to the internet to submit.")})}),document.querySelectorAll(".glass-pill-btn, button").forEach(t=>{t.addEventListener("pointerdown",function(){this.classList.add("btn-pressed")}),t.addEventListener("pointerup",function(){this.classList.remove("btn-pressed")}),t.addEventListener("pointerleave",function(){this.classList.remove("btn-pressed")})}),function(){if(!document.querySelector('meta[name="theme-color"]')){const t=document.createElement("meta");t.name="theme-color",t.content="#db2777",document.head.appendChild(t)}function t(){const t="dark"===document.documentElement.getAttribute("data-theme"),e=document.querySelector('meta[name="theme-color"]');e&&e.setAttribute("content",t?"#0f172a":"#db2777")}new MutationObserver(t).observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme"]}),t()}()}(),window.initGoalSocial=function(t){const{goalId:e,isLoggedIn:n,isLiked:o,apiBase:i,basePath:r}=t;let a=o,s=!1,d=[];const l=i;async function c(){const t=document.getElementById("comments-list");t.innerHTML='<p style="text-align: center; color: var(--text-muted);">Loading comments...</p>';try{const n=await fetch(l+"/comments",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"fetch",target_type:"goal",target_id:e})});if(!n.ok)return void(t.innerHTML='<p style="text-align: center; color: var(--text-muted);">Failed to load comments.</p>');const o=await n.json();if(o.error)return void(t.innerHTML='<p style="text-align: center; color: var(--text-muted);">Failed to load comments.</p>');if(s=!0,d=o.available_reactions||[],!o.comments||0===o.comments.length)return void(t.innerHTML='<p style="text-align: center; color: var(--text-muted); padding: 20px;">No comments yet. Be the first to comment!</p>');t.innerHTML=o.comments.map(t=>m(t,0)).join("")}catch(e){console.error("Load comments error:",e),t.innerHTML='<p style="text-align: center; color: var(--text-muted);">Failed to load comments.</p>'}}function m(t,e){const n=20*e,o=t.is_edited?'<span style="font-size: 0.7rem; color: var(--text-muted);"> (edited)</span>':"",i=t.is_owner?`\n            <span onclick="goalEditComment(${t.id}, '${p(t.content).replace(/'/g,"\\'")}')" style="cursor: pointer; margin-left: 10px;" title="Edit">‚úèÔ∏è</span>\n            <span onclick="goalDeleteComment(${t.id})" style="cursor: pointer; margin-left: 5px;" title="Delete">üóëÔ∏è</span>\n        `:"",r=Object.entries(t.reactions||{}).map(([e,n])=>{const o=(t.user_reactions||[]).includes(e);return`<span onclick="goalToggleReaction(${t.id}, '${e}')" style="cursor: pointer; padding: 2px 6px; border-radius: 12px; font-size: 0.8rem; background: ${o?"rgba(219, 39, 119, 0.2)":"var(--pill-bg)"}; border: 1px solid ${o?"rgba(219, 39, 119, 0.4)":"var(--glass-border)"};">${e} ${n}</span>`}).join(" "),a=(t.replies||[]).map(t=>m(t,e+1)).join("");return`\n            <div style="margin-left: ${n}px; padding: 15px; margin-bottom: 10px; background: var(--pill-bg); border-radius: 12px; border: 1px solid var(--glass-border);">\n                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">\n                    <img src="${t.avatar||"/assets/img/defaults/default_avatar.webp"}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" loading="lazy">\n                    <div>\n                        <strong style="color: var(--text-color);">${p(t.author_name)}</strong>${o}\n                        <div style="font-size: 0.75rem; color: var(--text-muted);">${t.time_ago}</div>\n                    </div>\n                    ${i}\n                </div>\n                <div id="content-${t.id}" style="color: var(--text-color); margin-bottom: 10px;">${p(t.content)}</div>\n                <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">\n                    ${r}\n                    <span onclick="goalShowReplyForm(${t.id})" style="cursor: pointer; color: var(--accent-color); font-size: 0.85rem;">‚Ü©Ô∏è Reply</span>\n                </div>\n                <div id="reply-form-${t.id}" style="display: none; margin-top: 10px;">\n                    <input type="text" id="reply-input-${t.id}" placeholder="Write a reply..." style="width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--pill-bg); color: var(--text-color);">\n                    <button onclick="goalSubmitReply(${t.id})" class="glass-pill-btn btn-primary" style="margin-top: 8px; padding: 6px 12px; font-size: 0.85rem;">Reply</button>\n                </div>\n                ${a}\n            </div>\n        `}function p(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}window.goalToggleLike=async function(){if(!n)return void(window.location.href=r+"/login");const t=document.getElementById("like-btn"),o=document.getElementById("like-icon"),i=document.getElementById("like-count");t.disabled=!0;try{const n=await fetch(l+"/like",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({target_type:"goal",target_id:e})});if(!n.ok)return void alert("Like failed. Please try again.");const r=await n.json();if(r.error)return void(r.redirect?window.location.href=r.redirect:alert("Like failed: "+r.error));a="liked"===r.status,i.textContent=r.likes_count,a?(t.classList.remove("btn-secondary"),t.classList.add("btn-primary"),o.classList.remove("fa-regular"),o.classList.add("fa-solid")):(t.classList.remove("btn-primary"),t.classList.add("btn-secondary"),o.classList.remove("fa-solid"),o.classList.add("fa-regular"))}catch(t){console.error("Like error:",t)}finally{t.disabled=!1}},window.goalToggleComments=function(){if((window.innerWidth<=768||"ontouchstart"in window)&&"function"==typeof openMobileCommentSheet)return void openMobileCommentSheet("goal",e,"");const t=document.getElementById("comments-section"),n=t.classList.contains("hidden")||"none"===window.getComputedStyle(t).display;t.classList.toggle("hidden"),n&&!s&&c()},window.goalSubmitComment=async function(t){t.preventDefault();const n=document.getElementById("comment-input"),o=n.value.trim();if(!o)return;const i=t.target.querySelector('button[type="submit"]');i.disabled=!0,i.textContent="Posting...";try{const t=await fetch(l+"/comments",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({action:"submit",target_type:"goal",target_id:e,content:o})}),i=await t.json();if(i.error)return void alert(i.error);n.value="";const r=document.getElementById("comment-count");r.textContent=parseInt(r.textContent)+1,c()}catch(t){console.error("Submit comment error:",t),alert("Failed to post comment")}finally{i.disabled=!1,i.textContent="Post Comment"}},window.goalShowReplyForm=function(t){const e=document.getElementById(`reply-form-${t}`);e.classList.toggle("hidden"),e.classList.contains("hidden")||document.getElementById(`reply-input-${t}`).focus()},window.goalSubmitReply=async function(t){const n=document.getElementById(`reply-input-${t}`),o=n.value.trim();if(o)try{const i=await fetch(l+"/reply",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({target_type:"goal",target_id:e,parent_id:t,content:o})}),r=await i.json();if(r.error)return void alert(r.error);n.value="",document.getElementById(`reply-form-${t}`).classList.add("hidden");const a=document.getElementById("comment-count");a.textContent=parseInt(a.textContent)+1,c()}catch(t){console.error("Reply error:",t)}},window.goalToggleReaction=async function(t,e){if(n)try{const n=await fetch(l+"/reaction",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({comment_id:t,emoji:e})}),o=await n.json();if(o.error)return void alert(o.error);c()}catch(t){console.error("Reaction error:",t)}else alert("Please log in to react")},window.goalDeleteComment=async function(t){if(confirm("Delete this comment?"))try{const e=await fetch(l+"/delete-comment",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({comment_id:t})}),n=await e.json();if(n.error)return void alert(n.error);const o=document.getElementById("comment-count");o.textContent=Math.max(0,parseInt(o.textContent)-1),c()}catch(t){console.error("Delete error:",t)}},window.goalEditComment=function(t,e){const n=document.getElementById(`content-${t}`),o=n.innerHTML;n.innerHTML=`\n            <div style="display: flex; gap: 8px; flex-wrap: wrap;">\n                <input type="text" id="edit-input-${t}" value="${p(e)}" style="flex: 1; min-width: 200px; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--pill-bg); color: var(--text-color);">\n                <button onclick="goalSaveEdit(${t})" class="glass-pill-btn btn-primary" style="padding: 6px 12px;">Save</button>\n                <button onclick="goalCancelEdit(${t}, '${p(o).replace(/'/g,"\\'")}')" class="glass-pill-btn btn-secondary" style="padding: 6px 12px;">Cancel</button>\n            </div>\n        `,document.getElementById(`edit-input-${t}`).focus()},window.goalCancelEdit=function(t,e){document.getElementById(`content-${t}`).innerHTML=e},window.goalSaveEdit=async function(t){const e=document.getElementById(`edit-input-${t}`).value.trim();if(e)try{const n=await fetch(l+"/edit-comment",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({comment_id:t,content:e})}),o=await n.json();if(o.error)return void alert(o.error);c()}catch(t){console.error("Edit error:",t)}},window.shareToFeed=async function(){if(confirm("Share this goal to your feed?"))try{const t=await fetch(l+"/share",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({parent_type:"goal",parent_id:e})}),n=await t.json();if(n.error)return void alert(n.error);"success"===n.status&&alert("Goal shared to your feed!")}catch(t){console.error("Share error:",t),alert("Failed to share")}}};