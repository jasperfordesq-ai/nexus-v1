!function(){"use strict";window.NexusNative={canShare:function(){return void 0!==navigator.share},async share(e){const t={title:e.title||document.title,text:e.text||"",url:e.url||window.location.href};if(this.haptic("medium"),!this.canShare())return this.showFallbackShare(t);try{return await navigator.share(t),{success:!0}}catch(e){return"AbortError"===e.name?{success:!1,reason:"cancelled"}:this.showFallbackShare(t)}},showFallbackShare:function(e){return new Promise(t=>{const s=document.createElement("div");s.className="nexus-share-sheet",s.innerHTML=`\n                    <div class="nexus-share-sheet-backdrop"></div>\n                    <div class="nexus-share-sheet-content">\n                        <div class="nexus-share-sheet-header">\n                            <h3>Share</h3>\n                            <button class="nexus-share-close">&times;</button>\n                        </div>\n                        <div class="nexus-share-sheet-body">\n                            <div class="nexus-share-options">\n                                <button class="nexus-share-option" data-action="copy">\n                                    <i class="fa-solid fa-link"></i>\n                                    <span>Copy Link</span>\n                                </button>\n                                <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(e.url)}" target="_blank" class="nexus-share-option">\n                                    <i class="fa-brands fa-facebook"></i>\n                                    <span>Facebook</span>\n                                </a>\n                                <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(e.text)}&url=${encodeURIComponent(e.url)}" target="_blank" class="nexus-share-option">\n                                    <i class="fa-brands fa-x-twitter"></i>\n                                    <span>X / Twitter</span>\n                                </a>\n                                <a href="https://api.whatsapp.com/send?text=${encodeURIComponent(e.text+" "+e.url)}" target="_blank" class="nexus-share-option">\n                                    <i class="fa-brands fa-whatsapp"></i>\n                                    <span>WhatsApp</span>\n                                </a>\n                                <a href="mailto:?subject=${encodeURIComponent(e.title)}&body=${encodeURIComponent(e.text+"\n\n"+e.url)}" class="nexus-share-option">\n                                    <i class="fa-solid fa-envelope"></i>\n                                    <span>Email</span>\n                                </a>\n                            </div>\n                        </div>\n                    </div>\n                `,document.body.appendChild(s),requestAnimationFrame(()=>s.classList.add("active")),s.querySelector('[data-action="copy"]').addEventListener("click",()=>{navigator.clipboard.writeText(e.url),window.NexusMobile&&NexusMobile.showToast("Link copied!","success"),a()});const a=()=>{s.classList.remove("active"),setTimeout(()=>s.remove(),300),t({success:!0})};s.querySelector(".nexus-share-close").addEventListener("click",a),s.querySelector(".nexus-share-sheet-backdrop").addEventListener("click",a),s.querySelectorAll("a.nexus-share-option").forEach(e=>{e.addEventListener("click",()=>{setTimeout(a,500)})})})},canCapture:function(){return"mediaDevices"in navigator&&"getUserMedia"in navigator.mediaDevices},async capturePhoto(e={}){const t={facingMode:e.facingMode||"user",width:e.width||1280,height:e.height||720,quality:e.quality||.85};return this.haptic("medium"),new Promise((e,s)=>{const a=document.createElement("div");a.className="nexus-camera-ui",a.innerHTML='\n                    <div class="nexus-camera-container">\n                        <video class="nexus-camera-video" autoplay playsinline></video>\n                        <canvas class="nexus-camera-canvas" style="display:none;"></canvas>\n                        <div class="nexus-camera-controls">\n                            <button class="nexus-camera-btn nexus-camera-close">\n                                <i class="fa-solid fa-times"></i>\n                            </button>\n                            <button class="nexus-camera-btn nexus-camera-capture">\n                                <i class="fa-solid fa-camera"></i>\n                            </button>\n                            <button class="nexus-camera-btn nexus-camera-flip">\n                                <i class="fa-solid fa-sync-alt"></i>\n                            </button>\n                        </div>\n                        <div class="nexus-camera-preview" style="display:none;">\n                            <img class="nexus-camera-preview-img">\n                            <div class="nexus-camera-preview-actions">\n                                <button class="nexus-camera-btn nexus-camera-retake">\n                                    <i class="fa-solid fa-redo"></i> Retake\n                                </button>\n                                <button class="nexus-camera-btn nexus-camera-use primary">\n                                    <i class="fa-solid fa-check"></i> Use Photo\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                ',document.body.appendChild(a),requestAnimationFrame(()=>a.classList.add("active"));const n=a.querySelector(".nexus-camera-video"),i=a.querySelector(".nexus-camera-canvas"),r=a.querySelector(".nexus-camera-preview"),o=a.querySelector(".nexus-camera-preview-img");let c=null,u=t.facingMode,l=null;const d=async e=>{c&&c.getTracks().forEach(e=>e.stop());try{c=await navigator.mediaDevices.getUserMedia({video:{facingMode:e,width:{ideal:t.width},height:{ideal:t.height}},audio:!1}),n.srcObject=c}catch(e){h(),s(new Error("Camera access denied"))}},h=()=>{c&&c.getTracks().forEach(e=>e.stop()),a.classList.remove("active"),setTimeout(()=>a.remove(),300)};d(u),a.querySelector(".nexus-camera-capture").addEventListener("click",()=>{this.haptic("heavy"),i.width=n.videoWidth,i.height=n.videoHeight,i.getContext("2d").drawImage(n,0,0),i.toBlob(e=>{l=e,o.src=URL.createObjectURL(e),r.classList.remove("hidden"),n.classList.add("hidden")},"image/jpeg",t.quality)}),a.querySelector(".nexus-camera-flip").addEventListener("click",()=>{u="user"===u?"environment":"user",d(u),this.haptic("light")}),a.querySelector(".nexus-camera-retake").addEventListener("click",()=>{r.classList.add("hidden"),n.classList.remove("hidden"),l=null,this.haptic("light")}),a.querySelector(".nexus-camera-use").addEventListener("click",()=>{this.haptic("success"),h(),e({success:!0,blob:l,dataUrl:o.src})}),a.querySelector(".nexus-camera-close").addEventListener("click",()=>{h(),e({success:!1,reason:"cancelled"})})})},selectPhoto:function(e){e&&(e.setAttribute("accept","image/*"),e.setAttribute("capture","environment"),e.click())},async getLocation(e={}){const t={enableHighAccuracy:!1!==e.highAccuracy,timeout:e.timeout||1e4,maximumAge:e.maxAge||6e4};return navigator.geolocation?new Promise(e=>{navigator.geolocation.getCurrentPosition(t=>{e({success:!0,coords:{latitude:t.coords.latitude,longitude:t.coords.longitude,accuracy:t.coords.accuracy}})},t=>{e({success:!1,error:t.message})},t)}):{success:!1,error:"Geolocation not supported"}},haptic:function(e="light"){if(!navigator.vibrate)return;const t={light:[10],medium:[20],heavy:[40],success:[10,30,10,30,20],error:[50,30,50,30,50],warning:[30,20,30],tap:[8],doubleTap:[8,50,8],longPress:[5,5,5,5,5,5,30],selection:[5],impact:[15,10,25],notification:[20,100,20,100,40],reminder:[30,50,30]},s=t[e]||t.light;navigator.vibrate(s)},formQueue:[],queueForm:function(e,t,s){const a={id:Date.now(),action:t,method:s,data:Object.fromEntries(e),timestamp:(new Date).toISOString()};return this.formQueue.push(a),localStorage.setItem("nexus_form_queue",JSON.stringify(this.formQueue)),"serviceWorker"in navigator&&"sync"in window.ServiceWorkerRegistration.prototype&&navigator.serviceWorker.ready.then(e=>{e.sync.register("sync-forms")}),a.id},async processQueue(){const e=JSON.parse(localStorage.getItem("nexus_form_queue")||"[]"),t=[];for(const s of e)try{const e=new FormData;Object.entries(s.data).forEach(([t,s])=>e.append(t,s));(await fetch(s.action,{method:s.method,body:e})).ok?window.NexusMobile&&NexusMobile.showToast("Queued form submitted","success"):t.push(s)}catch(e){t.push(s)}localStorage.setItem("nexus_form_queue",JSON.stringify(t)),this.formQueue=t},getQueuedForms:function(){return JSON.parse(localStorage.getItem("nexus_form_queue")||"[]")},swipeBackEnabled:!0,swipeStartX:0,swipeStartY:0,swipeThreshold:80,edgeWidth:30,initSwipeBack:function(){if(!this.swipeBackEnabled)return;const e=document.createElement("div");e.className="nexus-swipe-back-indicator",e.innerHTML='<i class="fa-solid fa-chevron-left"></i>',document.body.appendChild(e);let t=0,s=0,a=0,n=!1;document.addEventListener("touchstart",e=>{const a=e.touches[0];t=a.clientX,s=a.clientY,t<this.edgeWidth&&window.history.length>1&&(n=!0)},{passive:!0}),document.addEventListener("touchmove",i=>{if(!n)return;const r=i.touches[0];a=r.clientX;const o=a-t;if(Math.abs(r.clientY-s)>50)return n=!1,void e.classList.remove("visible");if(o>20){e.classList.add("visible");const t=Math.min(o/this.swipeThreshold,1);e.style.opacity=t,e.querySelector("i").style.transform=`rotate(${-180*(1-t)}deg)`}},{passive:!0}),document.addEventListener("touchend",()=>{if(!n)return;const s=a-t;e.classList.remove("visible"),s>=this.swipeThreshold&&(this.haptic("impact"),window.history.back()),n=!1,a=0},{passive:!0}),document.addEventListener("touchcancel",()=>{n=!1,e.classList.remove("visible")},{passive:!0})},ptrEnabled:!1,ptrThreshold:80,ptrRefreshing:!1,initPullToRefresh:function(){console.log("[NexusNative] Pull-to-refresh has been permanently removed")},initHapticElements:function(){document.addEventListener("touchstart",e=>{e.target.closest(".nexus-haptic")&&this.haptic("light")},{passive:!0}),document.addEventListener("submit",e=>{this.haptic("medium")},{passive:!0})},pushSupported:!1,pushSubscription:null,async initPushNotifications(){if("serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window){this.pushSupported=!0;try{const e=await navigator.serviceWorker.ready;this.pushSubscription=await e.pushManager.getSubscription(),this.pushSubscription&&console.log("[NexusNative] Already subscribed to push")}catch(e){console.warn("[NexusNative] Push init error:",e)}}else console.log("[NexusNative] Push notifications not supported")},async subscribeToPush(){if(!this.pushSupported)return{success:!1,error:"Push not supported"};try{const e=await navigator.serviceWorker.ready;if("granted"!==await Notification.requestPermission())return{success:!1,error:"Permission denied"};const t=await fetch("/api/push/vapid-key"),{publicKey:s}=await t.json();return this.pushSubscription=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(s)}),await fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.pushSubscription)}),this.haptic("success"),{success:!0,subscription:this.pushSubscription}}catch(e){return console.error("[NexusNative] Push subscribe error:",e),{success:!1,error:e.message}}},async unsubscribeFromPush(){if(!this.pushSubscription)return{success:!1,error:"Not subscribed"};try{return await this.pushSubscription.unsubscribe(),await fetch("/api/push/unsubscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({endpoint:this.pushSubscription.endpoint})}),this.pushSubscription=null,{success:!0}}catch(e){return{success:!1,error:e.message}}},urlBase64ToUint8Array(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),s=window.atob(t),a=new Uint8Array(s.length);for(let e=0;e<s.length;++e)a[e]=s.charCodeAt(e);return a},isPushSubscribed(){return!!this.pushSubscription},deferredInstallPrompt:null,isInstalled:!1,initInstallPrompt(){(window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone)&&(this.isInstalled=!0,console.log("[NexusNative] App is installed")),console.log("[NexusNative] Install prompt disabled - handled by nexus-pwa.js")},showInstallBanner(){console.log("[NexusNative] showInstallBanner disabled - use NexusPWA.Install instead")},async triggerInstall(){if(window.NexusPWA&&window.NexusPWA.Install)return window.NexusPWA.Install.install();console.log("[NexusNative] triggerInstall - NexusPWA not available")},dismissInstall(){localStorage.setItem("nexus-install-dismissed",Date.now().toString())},canInstall:()=>!(!window.NexusPWA||!window.NexusPWA.Install)&&window.NexusPWA.Install.canInstall(),webAuthnSupported:!1,async initWebAuthn(){if(this.webAuthnSupported=void 0!==window.PublicKeyCredential&&"function"==typeof window.PublicKeyCredential,this.webAuthnSupported)try{const e=await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();this.webAuthnSupported=e,console.log("[NexusNative] WebAuthn platform authenticator:",e?"available":"not available")}catch(e){this.webAuthnSupported=!1}},async registerBiometric(e,t){if(!this.webAuthnSupported)return{success:!1,error:"WebAuthn not supported"};try{const s=await fetch("/api/webauthn/register-challenge",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e,userName:t})}),a=await s.json();a.challenge=this.base64ToArrayBuffer(a.challenge),a.user.id=this.base64ToArrayBuffer(a.user.id);const n=await navigator.credentials.create({publicKey:a}),i=await fetch("/api/webauthn/register-verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:n.id,rawId:this.arrayBufferToBase64(n.rawId),type:n.type,response:{clientDataJSON:this.arrayBufferToBase64(n.response.clientDataJSON),attestationObject:this.arrayBufferToBase64(n.response.attestationObject)}})}),r=await i.json();return r.success&&(this.haptic("success"),localStorage.setItem("nexus_biometric_enabled","true")),r}catch(e){return console.error("[NexusNative] Biometric registration error:",e),{success:!1,error:e.message}}},async authenticateWithBiometric(){if(!this.webAuthnSupported)return{success:!1,error:"WebAuthn not supported"};try{const e=await fetch("/api/webauthn/auth-challenge",{method:"POST",headers:{"Content-Type":"application/json"}}),t=await e.json();t.challenge=this.base64ToArrayBuffer(t.challenge),t.allowCredentials&&(t.allowCredentials=t.allowCredentials.map(e=>({...e,id:this.base64ToArrayBuffer(e.id)}))),this.haptic("medium");const s=await navigator.credentials.get({publicKey:t}),a=await fetch("/api/webauthn/auth-verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s.id,rawId:this.arrayBufferToBase64(s.rawId),type:s.type,response:{clientDataJSON:this.arrayBufferToBase64(s.response.clientDataJSON),authenticatorData:this.arrayBufferToBase64(s.response.authenticatorData),signature:this.arrayBufferToBase64(s.response.signature),userHandle:s.response.userHandle?this.arrayBufferToBase64(s.response.userHandle):null}})}),n=await a.json();return n.success&&this.haptic("success"),n}catch(e){return"NotAllowedError"===e.name?{success:!1,error:"Authentication cancelled"}:(console.error("[NexusNative] Biometric auth error:",e),{success:!1,error:e.message})}},isBiometricEnabled:()=>"true"===localStorage.getItem("nexus_biometric_enabled"),disableBiometric(){localStorage.removeItem("nexus_biometric_enabled"),fetch("/api/webauthn/remove",{method:"POST"})},base64ToArrayBuffer(e){const t=window.atob(e.replace(/-/g,"+").replace(/_/g,"/")),s=new Uint8Array(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);return s.buffer},arrayBufferToBase64(e){const t=new Uint8Array(e);let s="";for(let e=0;e<t.byteLength;e++)s+=String.fromCharCode(t[e]);return window.btoa(s).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")},init:function(){this.formQueue=this.getQueuedForms(),window.addEventListener("online",()=>{this.formQueue.length>0&&this.processQueue()}),document.addEventListener("click",e=>{const t=e.target.closest("[data-share]");t&&(e.preventDefault(),this.share({title:t.dataset.shareTitle||document.title,text:t.dataset.shareText||"",url:t.dataset.shareUrl||window.location.href}))}),document.addEventListener("click",e=>{const t=e.target.closest("[data-camera]");if(t){e.preventDefault();const s=document.querySelector(t.dataset.camera);s&&this.capturePhoto().then(e=>{if(e.success){const a=new File([e.blob],"photo.jpg",{type:"image/jpeg"}),n=new DataTransfer;n.items.add(a),s.files=n.files,s.dispatchEvent(new Event("change",{bubbles:!0}));const i=t.dataset.cameraPreview;i&&(document.querySelector(i).src=e.dataUrl)}})}}),("ontouchstart"in window||navigator.maxTouchPoints>0)&&this.initHapticElements(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(e=>{console.log("[NexusNative] SW registered"),this.initPushNotifications()}).catch(e=>console.warn("[NexusNative] SW registration failed:",e)),this.initInstallPrompt(),this.initWebAuthn(),console.log("[NexusNative] Initialized with native features")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>NexusNative.init()):NexusNative.init()}();