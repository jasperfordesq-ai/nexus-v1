!function(){"use strict";const e={vapidPublicKey:window.NEXUS_VAPID_PUBLIC_KEY||null,pushApiEndpoint:"/api/push/subscribe",pushUnsubscribeEndpoint:"/api/push/unsubscribe",installPromptDelay:3e4,installPromptMinVisits:0},n={registration:null,async register(){if(!("serviceWorker"in navigator))return console.log("[PWA] Service workers not supported"),null;try{return this.registration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("[PWA] Service worker registered:",this.registration.scope),this.registration.addEventListener("updatefound",()=>{const e=this.registration.installing;e.addEventListener("statechange",()=>{"installed"===e.state&&navigator.serviceWorker.controller&&this.showUpdatePrompt()})}),console.log("[PWA] Service worker controller change listener disabled - using update banner instead"),this.registration}catch(e){return console.error("[PWA] Service worker registration failed:",e),null}},showUpdatePrompt(){const e=document.createElement("div");e.className="nexus-pwa-update-banner",e.innerHTML='\n                <div class="nexus-pwa-update-content">\n                    <i class="fa-solid fa-arrow-rotate-right"></i>\n                    <span>A new version is available</span>\n                    <button class="nexus-pwa-update-btn">Update Now</button>\n                </div>\n            ',document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("visible")}),e.querySelector(".nexus-pwa-update-btn").addEventListener("click",()=>{this.registration.waiting&&this.registration.waiting.postMessage({type:"SKIP_WAITING"}),e.remove(),setTimeout(()=>{window.location.reload()},500)})},async getRegistration(){return this.registration?this.registration:navigator.serviceWorker.ready}},t={isSupported:async()=>"PushManager"in window&&"Notification"in window,async getPermission(){return await this.isSupported()?Notification.permission:"unsupported"},async requestPermission(){if(!await this.isSupported())return"unsupported";const e=await Notification.requestPermission();return"granted"===e&&await this.subscribe(),e},async subscribe(){if(!e.vapidPublicKey)return console.warn("[PWA] VAPID public key not configured"),null;try{const t=await n.getRegistration();let s=await t.pushManager.getSubscription(),i=!1;s?console.log("[PWA] Found existing push subscription, re-sending to server"):(s=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(e.vapidPublicKey)}),i=!0,console.log("[PWA] Push subscription created"));return await this.sendSubscriptionToServer(s)&&console.log("[PWA] Subscription "+(i?"created and ":"")+"sent to server successfully"),s}catch(e){return console.error("[PWA] Push subscription failed:",e),null}},async unsubscribe(){try{const t=await n.getRegistration(),s=await t.pushManager.getSubscription();if(s){const n=document.querySelector('meta[name="csrf-token"]'),t=n?n.getAttribute("content"):"",i={"Content-Type":"application/json"};t&&(i["X-CSRF-Token"]=t),await fetch(e.pushUnsubscribeEndpoint,{method:"POST",headers:i,body:JSON.stringify({endpoint:s.endpoint}),credentials:"include"}),await s.unsubscribe(),console.log("[PWA] Unsubscribed from push")}return!0}catch(e){return console.error("[PWA] Unsubscribe failed:",e),!1}},async sendSubscriptionToServer(n){try{const t=document.querySelector('meta[name="csrf-token"]'),s=t?t.getAttribute("content"):"",i={"Content-Type":"application/json"};s&&(i["X-CSRF-Token"]=s);const a=await fetch(e.pushApiEndpoint,{method:"POST",headers:i,body:JSON.stringify(n),credentials:"include"});if(!a.ok){const e=await a.text();throw console.error("[PWA] Server rejected subscription:",a.status,e),new Error("Server rejected subscription")}try{await fetch("/api/notifications/settings",{method:"POST",headers:i,credentials:"include",body:JSON.stringify({push_enabled:1})})}catch(e){console.warn("[PWA] Could not update notification preferences:",e)}return console.log("[PWA] Subscription sent to server"),!0}catch(e){return console.error("[PWA] Failed to send subscription to server:",e),!1}},getSubscription:async()=>(await n.getRegistration()).pushManager.getSubscription(),urlBase64ToUint8Array(e){const n=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),t=window.atob(n),s=new Uint8Array(t.length);for(let e=0;e<t.length;++e)s[e]=t.charCodeAt(e);return s},showPermissionPrompt(){if(!("Notification"in window)||"default"!==Notification.permission)return;const e=document.createElement("div");e.className="nexus-notification-prompt",e.innerHTML='\n                <div class="nexus-notification-prompt-content">\n                    <div class="nexus-notification-prompt-icon">\n                        <i class="fa-solid fa-bell"></i>\n                    </div>\n                    <div class="nexus-notification-prompt-text">\n                        <h4>Stay Updated</h4>\n                        <p>Get notified about new messages, transactions, and events</p>\n                    </div>\n                    <div class="nexus-notification-prompt-actions">\n                        <button class="nexus-prompt-btn-secondary" data-action="later">Later</button>\n                        <button class="nexus-prompt-btn-primary" data-action="enable">Enable</button>\n                    </div>\n                </div>\n            ',document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("visible")}),e.querySelector('[data-action="enable"]').addEventListener("click",async()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300),await this.requestPermission()}),e.querySelector('[data-action="later"]').addEventListener("click",()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300),sessionStorage.setItem("nexus-notification-prompt-dismissed","true")})}},s={deferredPrompt:null,isInstalled:!1,isNativeApp:!1,isAndroid:/Android/i.test(navigator.userAgent),isIOS:/iPad|iPhone|iPod/.test(navigator.userAgent),init(){return"undefined"!=typeof Capacitor&&Capacitor.isNativePlatform()?(this.isNativeApp=!0,document.body.classList.add("is-native-app"),void console.log("[PWA] Running in native app - install prompts disabled")):window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone?(this.isInstalled=!0,void document.body.classList.add("is-pwa-installed")):(window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),this.deferredPrompt=e,console.log("[PWA] Install prompt captured"),this.checkAndShowPrompt()}),void window.addEventListener("appinstalled",()=>{this.isInstalled=!0,this.deferredPrompt=null,document.body.classList.add("is-pwa-installed"),console.log("[PWA] App installed successfully"),window.gtag&&gtag("event","pwa_install")}))},checkAndShowPrompt(){},showPrompt(){if(this.isNativeApp||this.isInstalled)return;if(!this.isAndroid&&!this.isIOS&&!this.deferredPrompt)return;const e=document.createElement("div");e.className="nexus-install-prompt",this.isAndroid?e.innerHTML='\n                    <div class="nexus-install-prompt-card nexus-install-android">\n                        <button class="nexus-install-close" aria-label="Close">\n                            <i class="fa-solid fa-xmark"></i>\n                        </button>\n                        <div class="nexus-install-icon">\n                            <img src="/assets/images/pwa/icon-192x192.png" alt="NEXUS" width="64" height="64">\n                        </div>\n                        <h3 class="nexus-install-title">Install NEXUS</h3>\n                        <p class="nexus-install-description">Two ways to get the app on your device</p>\n\n                        \x3c!-- Option 1: Native APK --\x3e\n                        <div class="nexus-install-section nexus-install-section-apk">\n                            <div class="nexus-install-section-header">\n                                <i class="fa-brands fa-android"></i>\n                                <span>Android App (APK)</span>\n                                <span class="nexus-install-section-tag nexus-install-section-tag-green">Android Only</span>\n                            </div>\n                            <div class="nexus-install-section-body">\n                                <ul class="nexus-install-benefits">\n                                    <li><i class="fa-solid fa-check"></i> Native Android experience</li>\n                                    <li><i class="fa-solid fa-check"></i> Works offline</li>\n                                </ul>\n                                <div class="nexus-install-apk-note">\n                                    <i class="fa-solid fa-info-circle"></i>\n                                    <span>Not from Play Store - you\'ll need to allow installation from this source</span>\n                                </div>\n                                <a href="/mobile-download" class="nexus-install-section-btn nexus-install-section-btn-green">\n                                    <i class="fa-solid fa-download"></i> Download APK\n                                </a>\n                            </div>\n                        </div>\n\n                        \x3c!-- Divider --\x3e\n                        <div class="nexus-install-divider"><span>or</span></div>\n\n                        \x3c!-- Option 2: PWA --\x3e\n                        <div class="nexus-install-section">\n                            <div class="nexus-install-section-header">\n                                <i class="fa-solid fa-globe"></i>\n                                <span>Web App (PWA)</span>\n                            </div>\n                            <div class="nexus-install-section-body">\n                                <ul class="nexus-install-benefits">\n                                    <li><i class="fa-solid fa-check"></i> Works on Android, iPhone & Desktop</li>\n                                    <li><i class="fa-solid fa-check"></i> No download required</li>\n                                    <li><i class="fa-solid fa-check"></i> Always up to date</li>\n                                </ul>\n                                <button class="nexus-install-section-btn" data-action="install">\n                                    <i class="fa-solid fa-plus"></i> Add to Home Screen\n                                </button>\n                            </div>\n                        </div>\n\n                        <button class="nexus-install-btn-text" data-action="later">Maybe Later</button>\n                    </div>\n                ':this.isIOS?e.innerHTML='\n                    <div class="nexus-install-prompt-card">\n                        <button class="nexus-install-close" aria-label="Close">\n                            <i class="fa-solid fa-xmark"></i>\n                        </button>\n                        <div class="nexus-install-icon">\n                            <img src="/assets/images/pwa/icon-192x192.png" alt="NEXUS" width="64" height="64">\n                        </div>\n                        <h3 class="nexus-install-title">Install NEXUS on iPhone</h3>\n                        <p class="nexus-install-description">Add to your home screen for an app-like experience</p>\n\n                        <ul class="nexus-install-benefits" style="margin-bottom: 16px;">\n                            <li><i class="fa-solid fa-check"></i> Works just like a native app</li>\n                            <li><i class="fa-solid fa-check"></i> Full screen experience</li>\n                            <li><i class="fa-solid fa-check"></i> Quick access from home screen</li>\n                        </ul>\n\n                        <div class="nexus-install-ios-steps">\n                            <div class="nexus-install-ios-step">\n                                <span class="nexus-install-ios-step-num">1</span>\n                                <span>Tap <i class="fa-solid fa-arrow-up-from-bracket" style="color: #007AFF;"></i> at the bottom of Safari</span>\n                            </div>\n                            <div class="nexus-install-ios-step">\n                                <span class="nexus-install-ios-step-num">2</span>\n                                <span>Scroll down and tap <strong>Add to Home Screen</strong></span>\n                            </div>\n                            <div class="nexus-install-ios-step">\n                                <span class="nexus-install-ios-step-num">3</span>\n                                <span>Tap <strong>Add</strong> in the top right corner</span>\n                            </div>\n                        </div>\n\n                        <div class="nexus-install-actions">\n                            <button class="nexus-install-btn-secondary" data-action="later" style="flex: 1;">Got it</button>\n                        </div>\n                    </div>\n                ':e.innerHTML='\n                    <div class="nexus-install-prompt-card">\n                        <button class="nexus-install-close" aria-label="Close">\n                            <i class="fa-solid fa-xmark"></i>\n                        </button>\n                        <div class="nexus-install-icon">\n                            <img src="/assets/images/pwa/icon-192x192.png" alt="NEXUS" width="64" height="64">\n                        </div>\n                        <h3 class="nexus-install-title">Install NEXUS</h3>\n                        <p class="nexus-install-description">\n                            Add to your desktop for quick access\n                        </p>\n                        <div class="nexus-install-features">\n                            <div class="nexus-install-feature">\n                                <i class="fa-solid fa-bolt"></i>\n                                <span>Faster</span>\n                            </div>\n                            <div class="nexus-install-feature">\n                                <i class="fa-solid fa-bell"></i>\n                                <span>Notifications</span>\n                            </div>\n                            <div class="nexus-install-feature">\n                                <i class="fa-solid fa-cloud-arrow-down"></i>\n                                <span>Offline</span>\n                            </div>\n                        </div>\n                        <div class="nexus-install-actions">\n                            <button class="nexus-install-btn-secondary" data-action="later">Not Now</button>\n                            <button class="nexus-install-btn-primary" data-action="install">\n                                <i class="fa-solid fa-download"></i>\n                                Install\n                            </button>\n                        </div>\n                    </div>\n                ',document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("visible")});const n=()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300),localStorage.setItem("nexus-install-dismissed",Date.now().toString())},t=e.querySelector('[data-action="install"]');t&&t.addEventListener("click",async()=>{this.deferredPrompt&&await this.install(),e.classList.remove("visible"),setTimeout(()=>e.remove(),300)});const s=e.querySelector('[data-action="later"]');s&&s.addEventListener("click",n);const i=e.querySelector(".nexus-install-close");i&&i.addEventListener("click",n)},async install(){if(!this.deferredPrompt)return!1;this.deferredPrompt.prompt();const{outcome:e}=await this.deferredPrompt.userChoice;return console.log("[PWA] Install prompt outcome:",e),this.deferredPrompt=null,"accepted"===e},canInstall(){return!!this.deferredPrompt&&!this.isInstalled}},i={async isSupported(){if(!window.PublicKeyCredential)return!1;try{return await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()}catch(e){return!1}},async register(e,n,t){if(!await this.isSupported())throw new Error("Biometric authentication not supported");try{const n=await fetch("/api/webauthn/register-challenge",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e}),credentials:"include"});if(!n.ok)throw new Error("Failed to get registration challenge");const t=await n.json();t.challenge=this.base64ToArrayBuffer(t.challenge),t.user.id=this.base64ToArrayBuffer(t.user.id),t.excludeCredentials&&(t.excludeCredentials=t.excludeCredentials.map(e=>({...e,id:this.base64ToArrayBuffer(e.id)})));const s=await navigator.credentials.create({publicKey:t});if(!(await fetch("/api/webauthn/register-verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s.id,rawId:this.arrayBufferToBase64(s.rawId),type:s.type,response:{clientDataJSON:this.arrayBufferToBase64(s.response.clientDataJSON),attestationObject:this.arrayBufferToBase64(s.response.attestationObject)}}),credentials:"include"})).ok)throw new Error("Failed to verify registration");return console.log("[WebAuthn] Biometric registered successfully"),!0}catch(e){throw console.error("[WebAuthn] Registration failed:",e),e}},async authenticate(){if(!await this.isSupported())throw new Error("Biometric authentication not supported");try{const e=await fetch("/api/webauthn/auth-challenge",{method:"POST",credentials:"include"});if(!e.ok)throw new Error("Failed to get authentication challenge");const n=await e.json();n.challenge=this.base64ToArrayBuffer(n.challenge),n.allowCredentials&&(n.allowCredentials=n.allowCredentials.map(e=>({...e,id:this.base64ToArrayBuffer(e.id)})));const t=await navigator.credentials.get({publicKey:n}),s=await fetch("/api/webauthn/auth-verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t.id,rawId:this.arrayBufferToBase64(t.rawId),type:t.type,response:{clientDataJSON:this.arrayBufferToBase64(t.response.clientDataJSON),authenticatorData:this.arrayBufferToBase64(t.response.authenticatorData),signature:this.arrayBufferToBase64(t.response.signature),userHandle:t.response.userHandle?this.arrayBufferToBase64(t.response.userHandle):null}}),credentials:"include"});if(!s.ok)throw new Error("Authentication failed");const i=await s.json();return console.log("[WebAuthn] Biometric authentication successful"),i}catch(e){throw"NotAllowedError"===e.name?console.log("[WebAuthn] User cancelled authentication"):console.error("[WebAuthn] Authentication failed:",e),e}},base64ToArrayBuffer(e){const n=window.atob(e.replace(/-/g,"+").replace(/_/g,"/")),t=new Uint8Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e);return t.buffer},arrayBufferToBase64(e){const n=new Uint8Array(e);let t="";for(let e=0;e<n.length;e++)t+=String.fromCharCode(n[e]);return window.btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")},showSetupPrompt(){const e=document.createElement("div");return e.className="nexus-biometric-prompt",e.innerHTML='\n                <div class="nexus-biometric-card">\n                    <div class="nexus-biometric-icon">\n                        <i class="fa-solid fa-fingerprint"></i>\n                    </div>\n                    <h3>Enable Quick Login</h3>\n                    <p>Use Face ID, Touch ID, or fingerprint to sign in quickly and securely</p>\n                    <div class="nexus-biometric-actions">\n                        <button class="nexus-biometric-btn-secondary" data-action="later">Maybe Later</button>\n                        <button class="nexus-biometric-btn-primary" data-action="enable">Enable</button>\n                    </div>\n                </div>\n            ',document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("visible")}),new Promise(n=>{e.querySelector('[data-action="enable"]').addEventListener("click",async()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300),n(!0)}),e.querySelector('[data-action="later"]').addEventListener("click",()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300),localStorage.setItem("nexus-biometric-dismissed",Date.now().toString()),n(!1)})})}};async function a(){if(console.log("[PWA] Styles loaded from external CSS file"),await n.register(),s.init(),document.body.classList.contains("logged-in")&&"Notification"in window&&"granted"===Notification.permission&&e.vapidPublicKey)try{const e=await n.getRegistration();if(e){const n=await e.pushManager.getSubscription();n?(console.log("[PWA] Permission granted, ensuring subscription is saved..."),await t.sendSubscriptionToServer(n)):(console.log("[PWA] Permission granted but no subscription, subscribing..."),await t.subscribe())}}catch(e){console.warn("[PWA] Auto-subscribe check failed:",e)}document.body.classList.contains("logged-in")&&"Notification"in window&&"default"===Notification.permission&&!sessionStorage.getItem("nexus-notification-prompt-dismissed")&&setTimeout(()=>{t.showPermissionPrompt()},5e3),console.log("[PWA] Features initialized")}window.NexusPWA={ServiceWorker:n,Push:t,Install:s,Biometric:i,init:a},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",a):a()}();