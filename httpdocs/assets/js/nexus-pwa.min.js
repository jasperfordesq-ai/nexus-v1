(()=>{let o={vapidPublicKey:window.NEXUS_VAPID_PUBLIC_KEY||null,pushApiEndpoint:"/api/push/subscribe",pushUnsubscribeEndpoint:"/api/push/unsubscribe",installPromptDelay:3e4,installPromptMinVisits:0},a={registration:null,async register(){if(!("serviceWorker"in navigator))return console.log("[PWA] Service workers not supported"),null;try{return this.registration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("[PWA] Service worker registered:",this.registration.scope),this.registration.addEventListener("updatefound",()=>{let e=this.registration.installing;e.addEventListener("statechange",()=>{"installed"===e.state&&navigator.serviceWorker.controller&&this.showUpdatePrompt()})}),console.log("[PWA] Service worker controller change listener disabled - using update banner instead"),this.registration}catch(e){return console.error("[PWA] Service worker registration failed:",e),null}},showUpdatePrompt(){let e=document.createElement("div");e.className="nexus-pwa-update-banner",e.innerHTML=`
                <div class="nexus-pwa-update-content">
                    <i class="fa-solid fa-arrow-rotate-right"></i>
                    <span>A new version is available</span>
                    <button class="nexus-pwa-update-btn">Update Now</button>
                </div>
            `,document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("visible")}),e.querySelector(".nexus-pwa-update-btn").addEventListener("click",()=>{this.registration.waiting&&this.registration.waiting.postMessage({type:"SKIP_WAITING"}),e.remove(),setTimeout(()=>{window.location.reload()},500)})},async getRegistration(){return this.registration||navigator.serviceWorker.ready}},i={async isSupported(){return"PushManager"in window&&"Notification"in window},async getPermission(){return await this.isSupported()?Notification.permission:"unsupported"},async requestPermission(){var e;return await this.isSupported()?("granted"===(e=await Notification.requestPermission())&&await this.subscribe(),e):"unsupported"},async subscribe(){if(!o.vapidPublicKey)return console.warn("[PWA] VAPID public key not configured"),null;try{var i=await a.getRegistration();let e=await i.pushManager.getSubscription(),t=!1;return e?console.log("[PWA] Found existing push subscription, re-sending to server"):(e=await i.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(o.vapidPublicKey)}),t=!0,console.log("[PWA] Push subscription created")),await this.sendSubscriptionToServer(e)&&console.log("[PWA] Subscription "+(t?"created and ":"")+"sent to server successfully"),e}catch(e){return console.error("[PWA] Push subscription failed:",e),null}},async unsubscribe(){try{var e,t,i,s=await(await a.getRegistration()).pushManager.getSubscription();return s&&(t=(e=document.querySelector('meta[name="csrf-token"]'))?e.getAttribute("content"):"",i={"Content-Type":"application/json"},t&&(i["X-CSRF-Token"]=t),await fetch(o.pushUnsubscribeEndpoint,{method:"POST",headers:i,body:JSON.stringify({endpoint:s.endpoint}),credentials:"include"}),await s.unsubscribe(),console.log("[PWA] Unsubscribed from push")),!0}catch(e){return console.error("[PWA] Unsubscribe failed:",e),!1}},async sendSubscriptionToServer(e){try{var t,i=document.querySelector('meta[name="csrf-token"]'),s=i?i.getAttribute("content"):"",a={"Content-Type":"application/json"},n=(s&&(a["X-CSRF-Token"]=s),await fetch(o.pushApiEndpoint,{method:"POST",headers:a,body:JSON.stringify(e),credentials:"include"}));if(!n.ok)throw t=await n.text(),console.error("[PWA] Server rejected subscription:",n.status,t),new Error("Server rejected subscription");try{await fetch("/api/notifications/settings",{method:"POST",headers:a,credentials:"include",body:JSON.stringify({push_enabled:1})})}catch(e){console.warn("[PWA] Could not update notification preferences:",e)}return console.log("[PWA] Subscription sent to server"),!0}catch(e){return console.error("[PWA] Failed to send subscription to server:",e),!1}},async getSubscription(){return(await a.getRegistration()).pushManager.getSubscription()},urlBase64ToUint8Array(e){var e=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),t=window.atob(e),i=new Uint8Array(t.length);for(let e=0;e<t.length;++e)i[e]=t.charCodeAt(e);return i},showPermissionPrompt(){if("Notification"in window&&"default"===Notification.permission){let e=document.createElement("div");e.className="nexus-notification-prompt",e.innerHTML=`
                <div class="nexus-notification-prompt-content">
                    <div class="nexus-notification-prompt-icon">
                        <i class="fa-solid fa-bell"></i>
                    </div>
                    <div class="nexus-notification-prompt-text">
                        <h4>Stay Updated</h4>
                        <p>Get notified about new messages, transactions, and events</p>
                    </div>
                    <div class="nexus-notification-prompt-actions">
                        <button class="nexus-prompt-btn-secondary" data-action="later">Later</button>
                        <button class="nexus-prompt-btn-primary" data-action="enable">Enable</button>
                    </div>
                </div>
            `,document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("visible")}),e.querySelector('[data-action="enable"]').addEventListener("click",async()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300),await this.requestPermission()}),e.querySelector('[data-action="later"]').addEventListener("click",()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300),sessionStorage.setItem("nexus-notification-prompt-dismissed","true")})}}},s={deferredPrompt:null,isInstalled:!1,isNativeApp:!1,isAndroid:/Android/i.test(navigator.userAgent),isIOS:/iPad|iPhone|iPod/.test(navigator.userAgent),init(){"undefined"!=typeof Capacitor&&Capacitor.isNativePlatform()?(this.isNativeApp=!0,document.body.classList.add("is-native-app"),console.log("[PWA] Running in native app - install prompts disabled")):window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone?(this.isInstalled=!0,document.body.classList.add("is-pwa-installed")):(window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),this.deferredPrompt=e,console.log("[PWA] Install prompt captured"),this.checkAndShowPrompt()}),window.addEventListener("appinstalled",()=>{this.isInstalled=!0,this.deferredPrompt=null,document.body.classList.add("is-pwa-installed"),console.log("[PWA] App installed successfully"),window.gtag&&gtag("event","pwa_install")}))},checkAndShowPrompt(){var e=parseInt(localStorage.getItem("nexus-visit-count")||"0");if(localStorage.setItem("nexus-visit-count",(e+1).toString()),!(e<o.installPromptMinVisits)){e=localStorage.getItem("nexus-install-dismissed");if(e){e=parseInt(e);if((Date.now()-e)/864e5<7)return}setTimeout(()=>this.showPrompt(),o.installPromptDelay)}},showPrompt(){if(!this.isNativeApp&&!this.isInstalled&&(this.isAndroid||this.isIOS||this.deferredPrompt)){let e=document.createElement("div");e.className="nexus-install-prompt",this.isAndroid?e.innerHTML=`
                    <div class="nexus-install-prompt-card nexus-install-android">
                        <button class="nexus-install-close" aria-label="Close">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                        <div class="nexus-install-icon">
                            <img src="/assets/images/pwa/icon-192x192.png" alt="NEXUS" width="64" height="64">
                        </div>
                        <h3 class="nexus-install-title">Install NEXUS</h3>
                        <p class="nexus-install-description">Two ways to get the app on your device</p>

                        <!-- Option 1: Native APK -->
                        <div class="nexus-install-section nexus-install-section-apk">
                            <div class="nexus-install-section-header">
                                <i class="fa-brands fa-android"></i>
                                <span>Android App (APK)</span>
                                <span class="nexus-install-section-tag nexus-install-section-tag-green">Android Only</span>
                            </div>
                            <div class="nexus-install-section-body">
                                <ul class="nexus-install-benefits">
                                    <li><i class="fa-solid fa-check"></i> Native Android experience</li>
                                    <li><i class="fa-solid fa-check"></i> Works offline</li>
                                </ul>
                                <div class="nexus-install-apk-note">
                                    <i class="fa-solid fa-info-circle"></i>
                                    <span>Not from Play Store - you'll need to allow installation from this source</span>
                                </div>
                                <a href="/mobile-download" class="nexus-install-section-btn nexus-install-section-btn-green">
                                    <i class="fa-solid fa-download"></i> Download APK
                                </a>
                            </div>
                        </div>

                        <!-- Divider -->
                        <div class="nexus-install-divider"><span>or</span></div>

                        <!-- Option 2: PWA -->
                        <div class="nexus-install-section">
                            <div class="nexus-install-section-header">
                                <i class="fa-solid fa-globe"></i>
                                <span>Web App (PWA)</span>
                            </div>
                            <div class="nexus-install-section-body">
                                <ul class="nexus-install-benefits">
                                    <li><i class="fa-solid fa-check"></i> Works on Android, iPhone & Desktop</li>
                                    <li><i class="fa-solid fa-check"></i> No download required</li>
                                    <li><i class="fa-solid fa-check"></i> Always up to date</li>
                                </ul>
                                <button class="nexus-install-section-btn" data-action="install">
                                    <i class="fa-solid fa-plus"></i> Add to Home Screen
                                </button>
                            </div>
                        </div>

                        <button class="nexus-install-btn-text" data-action="later">Maybe Later</button>
                    </div>
                `:this.isIOS?e.innerHTML=`
                    <div class="nexus-install-prompt-card">
                        <button class="nexus-install-close" aria-label="Close">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                        <div class="nexus-install-icon">
                            <img src="/assets/images/pwa/icon-192x192.png" alt="NEXUS" width="64" height="64">
                        </div>
                        <h3 class="nexus-install-title">Install NEXUS on iPhone</h3>
                        <p class="nexus-install-description">Add to your home screen for an app-like experience</p>

                        <ul class="nexus-install-benefits" style="margin-bottom: 16px;">
                            <li><i class="fa-solid fa-check"></i> Works just like a native app</li>
                            <li><i class="fa-solid fa-check"></i> Full screen experience</li>
                            <li><i class="fa-solid fa-check"></i> Quick access from home screen</li>
                        </ul>

                        <div class="nexus-install-ios-steps">
                            <div class="nexus-install-ios-step">
                                <span class="nexus-install-ios-step-num">1</span>
                                <span>Tap <i class="fa-solid fa-arrow-up-from-bracket" style="color: #007AFF;"></i> at the bottom of Safari</span>
                            </div>
                            <div class="nexus-install-ios-step">
                                <span class="nexus-install-ios-step-num">2</span>
                                <span>Scroll down and tap <strong>Add to Home Screen</strong></span>
                            </div>
                            <div class="nexus-install-ios-step">
                                <span class="nexus-install-ios-step-num">3</span>
                                <span>Tap <strong>Add</strong> in the top right corner</span>
                            </div>
                        </div>

                        <div class="nexus-install-actions">
                            <button class="nexus-install-btn-secondary" data-action="later" style="flex: 1;">Got it</button>
                        </div>
                    </div>
                `:e.innerHTML=`
                    <div class="nexus-install-prompt-card">
                        <button class="nexus-install-close" aria-label="Close">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                        <div class="nexus-install-icon">
                            <img src="/assets/images/pwa/icon-192x192.png" alt="NEXUS" width="64" height="64">
                        </div>
                        <h3 class="nexus-install-title">Install NEXUS</h3>
                        <p class="nexus-install-description">
                            Add to your desktop for quick access
                        </p>
                        <div class="nexus-install-features">
                            <div class="nexus-install-feature">
                                <i class="fa-solid fa-bolt"></i>
                                <span>Faster</span>
                            </div>
                            <div class="nexus-install-feature">
                                <i class="fa-solid fa-bell"></i>
                                <span>Notifications</span>
                            </div>
                            <div class="nexus-install-feature">
                                <i class="fa-solid fa-wifi-slash"></i>
                                <span>Offline</span>
                            </div>
                        </div>
                        <div class="nexus-install-actions">
                            <button class="nexus-install-btn-secondary" data-action="later">Not Now</button>
                            <button class="nexus-install-btn-primary" data-action="install">
                                <i class="fa-solid fa-download"></i>
                                Install
                            </button>
                        </div>
                    </div>
                `,document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("visible")});var t=()=>{e.classList.remove("visible"),setTimeout(()=>e.remove(),300),localStorage.setItem("nexus-install-dismissed",Date.now().toString())},i=e.querySelector('[data-action="install"]'),i=(i&&i.addEventListener("click",async()=>{this.deferredPrompt&&await this.install(),e.classList.remove("visible"),setTimeout(()=>e.remove(),300)}),e.querySelector('[data-action="later"]')),i=(i&&i.addEventListener("click",t),e.querySelector(".nexus-install-close"));i&&i.addEventListener("click",t)}},async install(){if(!this.deferredPrompt)return!1;this.deferredPrompt.prompt();var e=(await this.deferredPrompt.userChoice).outcome;return console.log("[PWA] Install prompt outcome:",e),this.deferredPrompt=null,"accepted"===e},canInstall(){return!!this.deferredPrompt&&!this.isInstalled}};async function e(){if(console.log("[PWA] Styles loaded from external CSS file"),await a.register(),s.init(),document.body.classList.contains("logged-in")&&"Notification"in window&&"granted"===Notification.permission&&o.vapidPublicKey)try{var e,t=await a.getRegistration();t&&((e=await t.pushManager.getSubscription())?(console.log("[PWA] Permission granted, ensuring subscription is saved..."),await i.sendSubscriptionToServer(e)):(console.log("[PWA] Permission granted but no subscription, subscribing..."),await i.subscribe()))}catch(e){console.warn("[PWA] Auto-subscribe check failed:",e)}document.body.classList.contains("logged-in")&&"Notification"in window&&"default"===Notification.permission&&!sessionStorage.getItem("nexus-notification-prompt-dismissed")&&setTimeout(()=>{i.showPermissionPrompt()},5e3),console.log("[PWA] Features initialized")}window.NexusPWA={ServiceWorker:a,Push:i,Install:s,Biometric:{async isSupported(){if(!window.PublicKeyCredential)return!1;try{return await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()}catch(e){return!1}},async register(e,t,i){if(!await this.isSupported())throw new Error("Biometric authentication not supported");try{var s=await fetch("/api/webauthn/register-challenge",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e}),credentials:"include"});if(!s.ok)throw new Error("Failed to get registration challenge");var a=await s.json(),n=(a.challenge=this.base64ToArrayBuffer(a.challenge),a.user.id=this.base64ToArrayBuffer(a.user.id),a.excludeCredentials&&(a.excludeCredentials=a.excludeCredentials.map(e=>({...e,id:this.base64ToArrayBuffer(e.id)}))),await navigator.credentials.create({publicKey:a}));if((await fetch("/api/webauthn/register-verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:n.id,rawId:this.arrayBufferToBase64(n.rawId),type:n.type,response:{clientDataJSON:this.arrayBufferToBase64(n.response.clientDataJSON),attestationObject:this.arrayBufferToBase64(n.response.attestationObject)}}),credentials:"include"})).ok)return console.log("[WebAuthn] Biometric registered successfully"),!0;throw new Error("Failed to verify registration")}catch(e){throw console.error("[WebAuthn] Registration failed:",e),e}},async authenticate(){if(!await this.isSupported())throw new Error("Biometric authentication not supported");try{var e=await fetch("/api/webauthn/auth-challenge",{method:"POST",credentials:"include"});if(!e.ok)throw new Error("Failed to get authentication challenge");var t,i=await e.json(),s=(i.challenge=this.base64ToArrayBuffer(i.challenge),i.allowCredentials&&(i.allowCredentials=i.allowCredentials.map(e=>({...e,id:this.base64ToArrayBuffer(e.id)}))),await navigator.credentials.get({publicKey:i})),a=await fetch("/api/webauthn/auth-verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:s.id,rawId:this.arrayBufferToBase64(s.rawId),type:s.type,response:{clientDataJSON:this.arrayBufferToBase64(s.response.clientDataJSON),authenticatorData:this.arrayBufferToBase64(s.response.authenticatorData),signature:this.arrayBufferToBase64(s.response.signature),userHandle:s.response.userHandle?this.arrayBufferToBase64(s.response.userHandle):null}}),credentials:"include"});if(a.ok)return t=await a.json(),console.log("[WebAuthn] Biometric authentication successful"),t;throw new Error("Authentication failed")}catch(e){throw"NotAllowedError"===e.name?console.log("[WebAuthn] User cancelled authentication"):console.error("[WebAuthn] Authentication failed:",e),e}},base64ToArrayBuffer(e){var t=window.atob(e.replace(/-/g,"+").replace(/_/g,"/")),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i.buffer},arrayBufferToBase64(e){var t=new Uint8Array(e);let i="";for(let e=0;e<t.length;e++)i+=String.fromCharCode(t[e]);return window.btoa(i).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")},showSetupPrompt(){let t=document.createElement("div");return t.className="nexus-biometric-prompt",t.innerHTML=`
                <div class="nexus-biometric-card">
                    <div class="nexus-biometric-icon">
                        <i class="fa-solid fa-fingerprint"></i>
                    </div>
                    <h3>Enable Quick Login</h3>
                    <p>Use Face ID, Touch ID, or fingerprint to sign in quickly and securely</p>
                    <div class="nexus-biometric-actions">
                        <button class="nexus-biometric-btn-secondary" data-action="later">Maybe Later</button>
                        <button class="nexus-biometric-btn-primary" data-action="enable">Enable</button>
                    </div>
                </div>
            `,document.body.appendChild(t),requestAnimationFrame(()=>{t.classList.add("visible")}),new Promise(e=>{t.querySelector('[data-action="enable"]').addEventListener("click",async()=>{t.classList.remove("visible"),setTimeout(()=>t.remove(),300),e(!0)}),t.querySelector('[data-action="later"]').addEventListener("click",()=>{t.classList.remove("visible"),setTimeout(()=>t.remove(),300),localStorage.setItem("nexus-biometric-dismissed",Date.now().toString()),e(!1)})})}},init:e},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()})();