!function(){"use strict";if(!("undefined"!=typeof Capacitor&&Capacitor.isNativePlatform&&Capacitor.isNativePlatform()))return void console.log("[NativePush] Not in native app, skipping native push setup");console.log("[NativePush] Initializing native push notifications");const{PushNotifications:e}=Capacitor.Plugins;if(!e)return void console.error("[NativePush] PushNotifications plugin not available");const n={token:null,isRegistered:!1,async init(){try{const n=await e.checkPermissions();if(console.log("[NativePush] Permission status:",n.receive),"prompt"===n.receive){if("granted"!==(await e.requestPermissions()).receive)return void console.log("[NativePush] Permission denied")}else if("granted"!==n.receive)return void console.log("[NativePush] Permission not granted:",n.receive);await this.register()}catch(e){console.error("[NativePush] Init error:",e)}},async register(){this.setupListeners(),await e.register(),console.log("[NativePush] Registration initiated")},setupListeners(){e.addListener("registration",async e=>{console.log("[NativePush] FCM Token received:",e.value.substring(0,20)+"..."),this.token=e.value,this.isRegistered=!0,await this.sendTokenToServer(e.value)}),e.addListener("registrationError",e=>{console.error("[NativePush] Registration error:",e)}),e.addListener("pushNotificationReceived",e=>{console.log("[NativePush] Notification received in foreground:",e),this.showInAppNotification(e)}),e.addListener("pushNotificationActionPerformed",e=>{console.log("[NativePush] Notification action:",e);const n=e.notification.data;n&&n.url?window.location.href=n.url:n&&n.type&&this.handleNotificationType(n)})},async sendTokenToServer(e){try{const n=window.NEXUS?.userId||null,t=await fetch("/api/push/register-device",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({token:e,platform:"android",type:"fcm",user_id:n})}),i=await t.json();i.success?console.log("[NativePush] Token registered with server"):console.error("[NativePush] Server registration failed:",i.error)}catch(e){console.error("[NativePush] Failed to send token to server:",e)}},showInAppNotification(e){const n=document.createElement("div");n.className="nexus-native-toast",n.innerHTML=`\n                <div class="nexus-native-toast-content">\n                    <div class="nexus-native-toast-icon">\n                        <i class="fa-solid fa-bell"></i>\n                    </div>\n                    <div class="nexus-native-toast-text">\n                        <strong>${this.escapeHtml(e.title||"Notification")}</strong>\n                        <span>${this.escapeHtml(e.body||"")}</span>\n                    </div>\n                    <button class="nexus-native-toast-close">\n                        <i class="fa-solid fa-xmark"></i>\n                    </button>\n                </div>\n            `,document.body.appendChild(n),requestAnimationFrame(()=>{n.classList.add("visible")}),n.querySelector(".nexus-native-toast-content").addEventListener("click",t=>{t.target.closest(".nexus-native-toast-close")||(e.data&&e.data.url&&(window.location.href=e.data.url),this.dismissToast(n))}),n.querySelector(".nexus-native-toast-close").addEventListener("click",()=>{this.dismissToast(n)}),setTimeout(()=>{this.dismissToast(n)},5e3)},dismissToast(e){e.parentNode&&(e.classList.remove("visible"),setTimeout(()=>e.remove(),300))},handleNotificationType(e){switch(e.type){case"message":window.location.href="/messages";break;case"exchange":window.location.href=e.exchange_id?`/exchanges/${e.exchange_id}`:"/exchanges";break;case"request":window.location.href=e.request_id?`/requests/${e.request_id}`:"/requests";break;case"offer":window.location.href=e.offer_id?`/offers/${e.offer_id}`:"/offers";break;case"profile":window.location.href=e.user_id?`/profile/${e.user_id}`:"/profile";break;default:window.location.href="/notifications"}},escapeHtml(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML},getToken(){return this.token},isReady(){return this.isRegistered}},t=document.createElement("style");t.textContent='\n        .nexus-native-toast {\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            z-index: 100001;\n            padding: 12px;\n            transform: translateY(-100%);\n            transition: transform 0.3s ease;\n            pointer-events: none;\n        }\n\n        .nexus-native-toast.visible {\n            transform: translateY(0);\n        }\n\n        .nexus-native-toast-content {\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            background: var(--htb-card-bg, white);\n            border-radius: 12px;\n            padding: 12px 16px;\n            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\n            border: 1px solid var(--htb-border, #e5e7eb);\n            pointer-events: auto;\n            cursor: pointer;\n            max-width: 400px;\n            margin: 0 auto;\n        }\n\n        .nexus-native-toast-icon {\n            width: 40px;\n            height: 40px;\n            background: linear-gradient(135deg, #6366f1, #8b5cf6);\n            border-radius: 10px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            flex-shrink: 0;\n        }\n\n        .nexus-native-toast-text {\n            flex: 1;\n            min-width: 0;\n        }\n\n        .nexus-native-toast-text strong {\n            display: block;\n            font-size: 0.95rem;\n            color: var(--htb-text-main, #1f2937);\n            margin-bottom: 2px;\n        }\n\n        .nexus-native-toast-text span {\n            display: block;\n            font-size: 0.85rem;\n            color: var(--htb-text-muted, #6b7280);\n            overflow: hidden;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n        }\n\n        .nexus-native-toast-close {\n            width: 32px;\n            height: 32px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            background: none;\n            border: none;\n            color: var(--htb-text-muted, #9ca3af);\n            cursor: pointer;\n            border-radius: 8px;\n            flex-shrink: 0;\n        }\n\n        .nexus-native-toast-close:hover {\n            background: var(--htb-bg-secondary, #f3f4f6);\n            color: var(--htb-text-main, #374151);\n        }\n\n        /* Safe area padding for notched phones */\n        @supports (padding-top: env(safe-area-inset-top)) {\n            .nexus-native-toast {\n                padding-top: calc(12px + env(safe-area-inset-top));\n            }\n        }\n\n        /* Dark mode */\n        [data-theme="dark"] .nexus-native-toast-content {\n            background: var(--htb-card-bg, #1e293b);\n            border-color: var(--htb-border, #334155);\n        }\n    ',document.head.appendChild(t),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>n.init()):n.init(),window.NexusNativePush=n}();