class NexusPusher{constructor(e={}){this.pusher=null,this.userChannel=null,this.presenceChannel=null,this.chatChannels={},this.config=null,this.connected=!1,this.userId=null,this.onlineUsers=new Map,this.handlers={notification:[],message:[],"new-message":[],"unread-count":[],"notifications-read":[],typing:[],presence:[],connection:[]},this.debug=e.debug||!1,this.autoConnect=!1!==e.autoConnect,this.fallbackToPolling=!1!==e.fallbackToPolling,this.autoConnect&&this.init()}async init(){try{const e=await fetch("/api/pusher/config");if(!e.ok)throw new Error("Failed to fetch Pusher config");if(this.config=await e.json(),!this.config.enabled||!this.config.key)return this.log("Pusher not configured, falling back to polling"),void this.triggerFallback();if(this.userId=this.config.userId,"undefined"==typeof Pusher)return this.log("Pusher JS not loaded, falling back to polling"),void this.triggerFallback();this.pusher=new Pusher(this.config.key,{cluster:this.config.cluster,authEndpoint:this.config.authEndpoint,auth:{headers:{"X-CSRF-Token":this.getCsrfToken()}}}),this.pusher.connection.bind("connected",()=>{this.connected=!0,this.log("Connected to Pusher"),this.emit("connection",{status:"connected"})}),this.pusher.connection.bind("disconnected",()=>{this.connected=!1,this.log("Disconnected from Pusher"),this.emit("connection",{status:"disconnected"})}),this.pusher.connection.bind("error",e=>{this.log("Pusher error:",e),this.emit("connection",{status:"error",error:e}),this.fallbackToPolling&&this.triggerFallback()}),this.subscribeToUserChannel(),this.subscribeToPresenceChannel()}catch(e){this.log("Pusher init error:",e),this.fallbackToPolling&&this.triggerFallback()}}subscribeToUserChannel(){this.config?.channels?.user&&(this.userChannel=this.pusher.subscribe(this.config.channels.user),this.userChannel.bind("pusher:subscription_succeeded",()=>{this.log("Subscribed to user channel")}),this.userChannel.bind("pusher:subscription_error",e=>{this.log("User channel subscription error:",e)}),this.userChannel.bind("notification",e=>{this.log("Received notification:",e),this.emit("notification",e)}),this.userChannel.bind("new-message",e=>{this.log("Received new message notification:",e),this.emit("new-message",e)}),this.userChannel.bind("unread-count",e=>{this.log("Received unread count:",e),this.emit("unread-count",e)}),this.userChannel.bind("notifications-read",e=>{this.log("Notifications marked as read:",e),this.emit("notifications-read",e)}))}subscribeToPresenceChannel(){this.config?.channels?.presence&&(this.presenceChannel=this.pusher.subscribe(this.config.channels.presence),this.presenceChannel.bind("pusher:subscription_succeeded",e=>{this.log("Subscribed to presence channel"),this.onlineUsers.clear(),e.each(e=>{this.onlineUsers.set(e.id,e.info)}),this.emit("presence",{type:"init",users:Array.from(this.onlineUsers.entries())})}),this.presenceChannel.bind("pusher:member_added",e=>{this.log("User came online:",e),this.onlineUsers.set(e.id,e.info),this.emit("presence",{type:"added",userId:e.id,userInfo:e.info})}),this.presenceChannel.bind("pusher:member_removed",e=>{this.log("User went offline:",e),this.onlineUsers.delete(e.id),this.emit("presence",{type:"removed",userId:e.id})}))}subscribeToChatChannel(e){if(!this.pusher||!this.userId)return null;const n=Math.min(this.userId,e)+"-"+Math.max(this.userId,e),s=`private-tenant.${this.getTenantId()}.chat.${n}`;if(this.chatChannels[n])return this.chatChannels[n];const t=this.pusher.subscribe(s);return t.bind("pusher:subscription_succeeded",()=>{this.log("Subscribed to chat channel:",n)}),t.bind("message",e=>{this.log("Received chat message:",e),this.emit("message",e)}),t.bind("typing",e=>{this.log("Typing indicator:",e),this.emit("typing",e)}),this.chatChannels[n]=t,t}unsubscribeFromChatChannel(e){const n=Math.min(this.userId,e)+"-"+Math.max(this.userId,e);this.chatChannels[n]&&(this.pusher.unsubscribe(`private-tenant.${this.getTenantId()}.chat.${n}`),delete this.chatChannels[n])}sendTyping(e,n=!0){const s=Math.min(this.userId,e)+"-"+Math.max(this.userId,e),t=this.chatChannels[s];t&&t.trigger("client-typing",{user_id:this.userId,is_typing:n})}isUserOnline(e){return this.onlineUsers.has(e)}getOnlineUsers(){return Array.from(this.onlineUsers.entries()).map(([e,n])=>({id:e,...n}))}on(e,n){return this.handlers[e]&&this.handlers[e].push(n),this}off(e,n){if(this.handlers[e]){const s=this.handlers[e].indexOf(n);s>-1&&this.handlers[e].splice(s,1)}return this}emit(e,n){this.handlers[e]&&this.handlers[e].forEach(e=>{try{e(n)}catch(e){console.error("Event handler error:",e)}})}triggerFallback(){this.emit("connection",{status:"fallback"}),void 0!==window.NexusNotifications&&window.nexusNotifications&&window.nexusNotifications.startPolling()}getCsrfToken(){const e=document.querySelector('meta[name="csrf-token"]');return e?e.getAttribute("content"):""}getTenantId(){if(window.NEXUS_CONFIG?.tenantId)return window.NEXUS_CONFIG.tenantId;const e=document.querySelector('meta[name="tenant-id"]');return e?e.getAttribute("content"):"1"}log(...e){this.debug&&console.log("[NexusPusher]",...e)}disconnect(){this.pusher&&(this.pusher.disconnect(),this.connected=!1,this.userChannel=null,this.presenceChannel=null,this.chatChannels={})}reconnect(){this.disconnect(),this.init()}isConnected(){return this.connected}}window.NEXUS_CONFIG?.userId?(console.log("[NexusPusher] Initializing for user:",window.NEXUS_CONFIG.userId),window.nexusPusher=new NexusPusher({debug:"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname})):console.log("[NexusPusher] No userId in NEXUS_CONFIG, skipping init"),"undefined"!=typeof module&&module.exports&&(module.exports=NexusPusher);