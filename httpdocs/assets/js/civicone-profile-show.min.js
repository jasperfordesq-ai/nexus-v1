!function(){"use strict";let e=!1,n=[],t="",i=0;function o(e){const n=document.getElementById("civic-toast");n&&(n.textContent=e,n.classList.add("show"),setTimeout(()=>n.classList.remove("show"),3e3))}function c(e,o){const c=document.getElementById(`comments-section-${e}-${o}`).querySelector(".comments-list");c.innerHTML='<div class="civicone-body-s civic-loading-message">Loading...</div>',t=e,i=o;const a=new FormData;a.append("action","fetch_comments"),a.append("target_type",e),a.append("target_id",o),fetch(window.location.href,{method:"POST",body:a}).then(e=>e.json()).then(e=>{e.available_reactions&&(n=e.available_reactions),"success"===e.status&&e.comments&&e.comments.length>0?c.innerHTML=e.comments.map(e=>s(e,0)).join(""):c.innerHTML='<div class="civicone-body-s civic-empty-message">No comments yet. Be the first!</div>'}).catch(e=>{console.error("Fetch error:",e),c.innerHTML='<div class="civicone-body-s civic-error-message">Error loading comments</div>'})}function a(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}function s(t,i){const o=t.is_edited?'<span class="civic-comment-edited"> (edited)</span>':"",c=t.is_owner?`\n            <span onclick="window.CivicProfile.editComment(${t.id}, '${a(t.content).replace(/'/g,"\\'").replace(/\n/g,"\\n")}')"\n                  class="civic-comment-action"\n                  title="Edit"\n                  tabindex="0"\n                  role="button"\n                  aria-label="Edit comment">‚úèÔ∏è</span>\n            <span onclick="window.CivicProfile.deleteComment(${t.id})"\n                  class="civic-comment-action"\n                  title="Delete"\n                  tabindex="0"\n                  role="button"\n                  aria-label="Delete comment">üóëÔ∏è</span>\n        `:"",r=Object.entries(t.reactions||{}).map(([e,n])=>`<span class="civic-reaction ${(t.user_reactions||[]).includes(e)?"active":""}"\n                          onclick="window.CivicProfile.toggleReaction(${t.id}, '${e}')"\n                          role="button"\n                          tabindex="0">${e} ${n}</span>`).join(""),l=e?`\n            <div class="civic-reaction-picker">\n                <span class="civic-reaction"\n                      onclick="window.CivicProfile.toggleReactionPicker(${t.id})"\n                      role="button"\n                      tabindex="0"\n                      aria-label="Add reaction">+</span>\n                <div class="civic-reaction-picker-menu" id="picker-${t.id}">\n                    ${n.map(e=>`<span onclick="window.CivicProfile.toggleReaction(${t.id}, '${e}')" role="button" tabindex="0">${e}</span>`).join("")}\n                </div>\n            </div>\n        `:"",d=e?`<span onclick="window.CivicProfile.showReplyForm(${t.id})" role="button" tabindex="0">Reply</span>`:"",m=(t.replies||[]).map(e=>s(e,i+1)).join(""),p=a(t.content).replace(/@(\w+)/g,'<span class="civic-mention">@$1</span>');return`\n            <div class="civic-comment civic-comment--depth-${i}" id="comment-${t.id}">\n                <img src="${t.author_avatar}" class="civic-comment-avatar" alt="">\n                <div class="civic-comment-bubble">\n                    <div class="civic-comment-author">${a(t.author_name)}${o} ${c}</div>\n                    <div class="civic-comment-text">${p}</div>\n                    <div class="civic-comment-meta">\n                        ${d}\n                    </div>\n                    <div class="civic-reactions">\n                        ${r}\n                        ${l}\n                    </div>\n                    <div class="civic-reply-form" id="reply-form-${t.id}">\n                        <div class="civic-reply-form-wrapper">\n                            <input type="text"\n                                   class="civic-reply-input civicone-input"\n                                   placeholder="Write a reply..."\n                                   onkeydown="if(event.key === 'Enter') window.CivicProfile.submitReply(${t.id}, this)">\n                            <button class="civicone-button civic-comment-submit"\n                                    onclick="window.CivicProfile.submitReply(${t.id}, this.previousElementSibling)">Reply</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            ${m}\n        `}window.CivicProfile={init:function(n){e=n,console.log("CivicOne Profile Show initialized (GOV.UK compliant)")},toggleLike:function(n,t,i){if(!e)return void alert("Please log in to like posts.");const o=new FormData;o.append("action","toggle_like"),o.append("target_type",n),o.append("target_id",t),fetch(window.location.href,{method:"POST",body:o}).then(e=>e.json()).then(e=>{if(e.error)return void alert(e.error);const n=i.querySelector(".like-count"),t=i.querySelector("i");n.textContent=e.likes_count,"liked"===e.status?(i.classList.add("liked"),t.className="fa-solid fa-heart"):(i.classList.remove("liked"),t.className="fa-regular fa-heart")})},toggleComments:function(e,n){const t=document.getElementById(`comments-section-${e}-${n}`);t&&("none"!==t.style.display&&t.style.display?t.style.display="none":(t.style.display="block",c(e,n)))},submitComment:function(e,n,a){const s=e.value.trim();if(!s)return;e.disabled=!0,t=n,i=a;const r=new FormData;r.append("action","submit_comment"),r.append("target_type",n),r.append("target_id",a),r.append("content",s),fetch(window.location.href,{method:"POST",body:r}).then(e=>e.json()).then(t=>{if(e.disabled=!1,"success"===t.status){e.value="",c(n,a),o("Comment posted!");const t=document.querySelector(`#post-${a} .comment-count`);t&&(t.textContent=parseInt(t.textContent)+1)}})},editComment:function(e,n){const a=prompt("Edit your comment:",n.replace(/\\n/g,"\n"));if(null===a||""===a.trim()||a===n)return;const s=new FormData;s.append("action","edit_comment"),s.append("comment_id",e),s.append("content",a.trim()),fetch(window.location.href,{method:"POST",body:s}).then(e=>e.json()).then(e=>{"success"===e.status?(c(t,i),o("Comment updated!")):e.error&&alert(e.error)})},deleteComment:function(e){if(!confirm("Delete this comment?"))return;const n=new FormData;n.append("action","delete_comment"),n.append("comment_id",e),fetch(window.location.href,{method:"POST",body:n}).then(e=>e.json()).then(e=>{"success"===e.status?(c(t,i),o("Comment deleted!")):e.error&&alert(e.error)})},submitReply:function(e,n){const a=n.value.trim();if(!a)return;n.disabled=!0;const s=new FormData;s.append("action","reply_comment"),s.append("target_type",t),s.append("target_id",i),s.append("parent_id",e),s.append("content",a),fetch(window.location.href,{method:"POST",body:s}).then(e=>e.json()).then(e=>{n.disabled=!1,n.value="","success"===e.status?(c(t,i),o("Reply posted!")):e.error&&alert(e.error)})},showReplyForm:function(e){const n=document.getElementById(`reply-form-${e}`);if(n){n.style.display="none"===n.style.display?"block":"none";const e=n.querySelector("input");e&&e.focus()}},toggleReaction:function(n,o){if(!e)return void alert("Please log in to react.");const a=document.getElementById(`picker-${n}`);a&&(a.style.display="none");const s=new FormData;s.append("action","toggle_reaction"),s.append("comment_id",n),s.append("emoji",o),fetch(window.location.href,{method:"POST",body:s}).then(e=>e.json()).then(e=>{"success"===e.status&&c(t,i)})},toggleReactionPicker:function(e){const n=document.getElementById(`picker-${e}`);n&&(n.style.display="none"===n.style.display?"block":"none")}}}();