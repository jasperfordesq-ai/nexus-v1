/**
 * Nexus Performance Patch
 * Optimizes animations to prevent jank and glitches
 * Migrated to use design tokens from design-tokens.css
 */

/* ============================================
   1. REMOVE GLOBAL TRANSITIONS (TOO EXPENSIVE)
   ============================================ */

/* Override the global transition - it causes jank */
* {
    transition-timing-function: var(--ease-in-out);
    /* Remove transition property entirely - too expensive */
}

/* Only add transitions to specific elements that need them */
button,
.btn,
.btn--glass,
.nav-link,
a,
.nexus-card,
.glass-card {
    transition: transform var(--transition-fast) var(--ease-in-out),
                box-shadow var(--transition-fast) var(--ease-in-out),
                opacity var(--transition-fast) var(--ease-in-out),
                background-color var(--transition-fast) var(--ease-in-out);
}

/* ============================================
   2. OPTIMIZE WILL-CHANGE
   ============================================ */

/* Remove will-change when not hovering/interacting */
button:not(:hover):not(:active),
.btn:not(:hover):not(:active),
.nexus-card:not(:hover),
.glass-card:not(:hover) {
    will-change: auto;
}

/* Only add will-change during interaction */
button:hover,
.btn:hover,
.nexus-card:hover,
.glass-card:hover {
    will-change: transform;
}

/* ============================================
   3. DISABLE EXPENSIVE ANIMATIONS ON LOW-END DEVICES
   ============================================ */

/* Detect lower-end devices and reduce animations */
@media (max-width: 768px) {
    /* Reduce card tilt on mobile */
    .nexus-card:hover,
    .glass-card:hover {
        transform: translateY(-2px) !important;
        /* Disable 3D tilt - too expensive on mobile */
    }

    /* Disable parallax on mobile */
    [data-parallax] {
        transform: none !important;
    }

    /* Simplify ripple effect */
    button::after,
    .btn::after {
        display: none;
    }
}

/* ============================================
   4. PREVENT LAYOUT THRASHING
   ============================================ */

/* Use transform instead of top/left for animations */
.modal {
    transform: translateZ(0);
}

.modal.active {
    transform: scale(1) translateZ(0);
}

/* Toast should use transform, not positioning */
#nexus-toast {
    transform: translateZ(0);
}

/* ============================================
   5. OPTIMIZE SKELETON SCREENS
   ============================================ */

/* Reduce skeleton shimmer animation complexity */
@keyframes shimmer {
    0%, 100% {
        background-position: -200% 0;
    }
    50% {
        background-position: 200% 0;
    }
}

.skeleton {
    background-size: 200% 100%;
    animation: shimmer 2s ease-in-out infinite;
    /* Slower animation = less CPU usage */
}

/* ============================================
   6. LIMIT CONCURRENT ANIMATIONS
   ============================================ */

/* Pause animations when page is hidden */
.page-hidden * {
    animation-play-state: paused !important;
}

/* ============================================
   7. OPTIMIZE DROPDOWN ANIMATIONS
   ============================================ */

.dropdown-menu {
    /* Use GPU-accelerated properties only */
    transition: opacity var(--transition-fast), transform var(--transition-fast);
    /* Remove complex transitions */
}

.dropdown.active .dropdown-menu {
    transform: translateY(0) scale(1) translateZ(0);
}

/* ============================================
   8. PREVENT PAINT STORMS
   ============================================ */

/* Contain paint to prevent full page repaints */
.nexus-card,
.glass-card,
.post-card,
.modal,
.dropdown-menu {
    contain: layout style paint;
}

/* ============================================
   9. OPTIMIZE IMAGE TRANSITIONS
   ============================================ */

img {
    /* Prevent image decode jank */
    image-rendering: auto;
    image-rendering: crisp-edges;
    image-rendering: -webkit-optimize-contrast;
}

/* img[loading="lazy"] transition consolidated in bundles/core.css */

/* ============================================
   10. REDUCE MOTION ENHANCEMENTS
   ============================================ */

@media (prefers-reduced-motion: reduce) {
    /* Completely disable problematic animations */
    .skeleton {
        animation: none !important;
        background: rgba(255, 255, 255, 0.05);
    }

    .feed-item,
    .post-card {
        animation: none !important;
        opacity: 1 !important;
    }

    button::after,
    .btn::after {
        display: none !important;
    }

    /* Instant transitions only */
    * {
        transition-duration: 0.01ms !important;
    }
}

/* ============================================
   11. SCROLL PERFORMANCE
   ============================================ */

/* Use passive event listeners (set in JS) */
/* Smooth scroll without jank */
html {
    scroll-behavior: smooth;
}

/* Disable smooth scroll during rapid scrolling */
html.scrolling {
    scroll-behavior: auto;
}

/* ============================================
   12. FIX CARD SCALE JANK
   ============================================ */

.nexus-card:hover,
.glass-card:hover {
    /* Use scale instead of width/height changes */
    transform: translateY(-4px) scale(1.01) translateZ(0);
    /* Add translateZ(0) to force GPU rendering */
}

/* ============================================
   13. OPTIMIZE HEADER SCROLL
   ============================================ */

.nexus-navbar {
    /* Use transform for scroll animations */
    transform: translateY(0) translateZ(0);
    transition: transform var(--transition-base) var(--ease-in-out),
                box-shadow var(--transition-base) var(--ease-in-out);
}

.nexus-navbar.hide-on-scroll {
    transform: translateY(-100%) translateZ(0);
}

/* ============================================
   14. PREVENT FONT LOADING JANK
   ============================================ */

/* Use font-display: swap to prevent invisible text */
@font-face {
    font-display: swap;
}

/* ============================================
   15. CRITICAL PATH OPTIMIZATION
   ============================================ */

/* Ensure above-the-fold content is always visible */
.nexus-navbar,
.main-content {
    opacity: 1 !important;
}

/* Below-the-fold can fade in */
.feed-container,
.sidebar {
    animation: fadeIn var(--transition-base) ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* ============================================
   16. DISABLE TRANSITIONS DURING PAGE LOAD
   ============================================ */

html.loading * {
    transition: none !important;
    animation: none !important;
}

html.loaded * {
    /* Re-enable transitions after load */
}

/* ============================================
   17. THROTTLE HOVER EFFECTS
   ============================================ */

/* Add small delay to prevent hover jank */
.nexus-card,
.glass-card {
    transition-delay: 0.05s;
}

.nexus-card:hover,
.glass-card:hover {
    transition-delay: 0s;
}
