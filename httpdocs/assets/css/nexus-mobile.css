/**
 * Project NEXUS - Mobile Native App Experience
 * Includes: Bottom nav, page transitions, skeleton loaders, swipe gestures
  * Fully Migrated to Design Tokens: 2026-01-21 âœ“
 */

/* ============================================
   MOBILE VIEWPORT FIX - Prevent content overflow
   ============================================ */
@media (max-width: 768px) {
    html {
        overflow-x: hidden !important;
        overflow-y: scroll !important;
        max-width: 100vw !important;
    }

    body {
        overflow-x: hidden !important;
        /* FIX 2026-02-01: Changed from visible to auto
           overflow-y: visible is non-standard and fragile (relies on scroll-fix-emergency.css)
           auto is correct - allows scrolling when content overflows */
        overflow-y: auto !important;
        max-width: 100vw !important;
        min-height: 100vh !important;
        position: relative !important;
        /* Allow normal overscroll behavior for smooth scrolling */
        overscroll-behavior-y: auto;
    }

    img,
    video,
    iframe,
    table,
    pre {
        max-width: 100% !important;
    }

    /* Hide site footer on mobile - content moved to Legal/More page */
    .nexus-site-footer,
    .nexus-modern-footer,
    footer.nexus-site-footer,
    footer[class*="nexus-site-footer"],
    .nexus-desktop-only {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        max-height: 0 !important;
        overflow: hidden !important;
        padding: 0 !important;
        margin: 0 !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }
}

/* Explicit desktop-only utility class */
@media (max-width: 768px) {
    .nexus-desktop-only {
        display: none !important;
    }
}

/* ============================================
   1. PERSISTENT BOTTOM TAB NAVIGATION
   ============================================ */

.nexus-bottom-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: var(--z-fixed, 1200);
    background: var(--color-white-alpha-95);
    -webkit-backdrop-filter: blur(20px);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--border-subtle);
    padding: var(--space-2) 0;
    padding-bottom: max(var(--space-2), env(safe-area-inset-bottom));
    box-shadow: 0 -4px 20px var(--color-black-alpha-8);
}

[data-theme="dark"] .nexus-bottom-nav {
    background: var(--color-slate-900-alpha-95);
    border-top-color: var(--color-white-alpha-10);
}

.nexus-bottom-nav-inner {
    display: flex;
    justify-content: space-around;
    align-items: center;
    max-width: 500px;
    margin: 0 auto;
}

.nexus-bottom-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-4);
    text-decoration: none;
    color: var(--color-slate-500);
    font-size: var(--font-size-xs);
    font-weight: 600;
    transition: all var(--transition-fast);
    position: relative;
    -webkit-tap-highlight-color: transparent;
}

.nexus-bottom-nav-item i {
    font-size: var(--font-size-xl);
    transition: all var(--transition-fast);
}

.nexus-bottom-nav-item.active {
    color: var(--color-primary-500);
}

.nexus-bottom-nav-item.active i {
    transform: scale(1.1);
}

[data-theme="dark"] .nexus-bottom-nav-item {
    color: var(--color-slate-400);
}

[data-theme="dark"] .nexus-bottom-nav-item.active {
    color: var(--color-primary-400);
}

/* Badge for notifications */
.nexus-bottom-nav-badge {
    position: absolute;
    top: 2px;
    right: var(--space-2);
    min-width: 18px;
    height: 18px;
    background: var(--color-danger);
    color: white;
    font-size: var(--font-size-xs);
    font-weight: 700;
    border-radius: var(--radius-base);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 var(--space-1);
}

/* Ripple effect */
.nexus-bottom-nav-item::after {
    content: '';
    position: absolute;
    inset: 0;
    background: currentColor;
    opacity: 0;
    border-radius: var(--radius-md);
    transition: opacity var(--transition-fast);
}

.nexus-bottom-nav-item:active::after {
    opacity: 0.1;
}

/* Unified mobile breakpoint at 900px */
@media (max-width: 900px) {

    /* DISABLED: Using nexus-native-nav-v2 instead */
    /* .nexus-bottom-nav is now hidden by nexus-native-nav-v2.css */
    .nexus-bottom-nav {
        display: none !important;
    }

    /* Add padding to body to prevent content from being hidden */
    body.has-bottom-nav,
    body.nexus-native-nav-enabled {
        padding-bottom: calc(90px + env(safe-area-inset-bottom));
    }

    /* Hide desktop footer on mobile when bottom nav is present */
    body.has-bottom-nav .site-footer {
        display: none;
    }
}


/* ============================================
   2. PAGE TRANSITION ANIMATIONS - REMOVED
   ============================================ */
/* View Transitions caused glitches and have been removed for stability. */


/* ============================================
   3. SKELETON LOADERS
   ============================================ */

.skeleton {
    background: linear-gradient(90deg,
            var(--color-gray-300-alpha-20) 0%,
            var(--color-gray-300-alpha-40) 50%,
            var(--color-gray-300-alpha-20) 100%);
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s ease-in-out infinite;
    border-radius: var(--radius-base);
}

[data-theme="dark"] .skeleton {
    background: linear-gradient(90deg,
            var(--color-gray-500-alpha-20) 0%,
            var(--color-gray-500-alpha-40) 50%,
            var(--color-gray-500-alpha-20) 100%);
    background-size: 200% 100%;
}

@keyframes skeleton-shimmer {
    0% {
        background-position: 200% 0;
    }

    100% {
        background-position: -200% 0;
    }
}

/* Skeleton shapes */
.skeleton-text {
    height: 1em;
    margin-bottom: var(--space-2);
}

.skeleton-text:last-child {
    width: 70%;
}

.skeleton-title {
    height: 1.5em;
    width: 60%;
    margin-bottom: var(--space-4);
}

.skeleton-avatar {
    width: var(--space-12);
    height: var(--space-12);
    border-radius: var(--radius-full);
}

.skeleton-card {
    height: 120px;
    border-radius: var(--radius-lg);
}

.skeleton-image {
    width: 100%;
    aspect-ratio: 16/9;
    border-radius: var(--radius-md);
}

.skeleton-button {
    height: 44px;
    width: 120px;
    border-radius: var(--radius-md);
}

/* Skeleton card component */
.skeleton-card-full {
    padding: var(--space-5);
    background: var(--color-white-alpha-80);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-black-alpha-5);
}

[data-theme="dark"] .skeleton-card-full {
    background: var(--color-slate-800-alpha-80);
    border-color: var(--color-white-alpha-10);
}

.skeleton-card-full .skeleton-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
}

.skeleton-card-full .skeleton-body {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}


/* ============================================
   4. PULL-TO-REFRESH - REMOVED
   ============================================ */
/* Pull-to-refresh feature has been permanently removed due to conflicts with scrolling */


/* ============================================
   5. SWIPE GESTURES
   ============================================ */

.nexus-swipe-container {
    touch-action: pan-y;
    overflow-x: hidden;
}

/* Swipe-to-go-back indicator */
.nexus-swipe-back-indicator {
    position: fixed;
    left: 0;
    top: 50%;
    transform: translateY(-50%) translateX(-60px) scale(0.8);
    width: 44px;
    height: 44px;
    background: white;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    box-shadow:
        0 4px 20px var(--color-black-alpha-15),
        0 0 0 1px var(--color-black-alpha-5);
    z-index: var(--z-modal, 1400);
    pointer-events: none;
    transition: opacity var(--transition-fast) var(--ease-in-out), transform var(--transition-fast) var(--ease-in-out);
    will-change: transform, opacity;
}

[data-theme="dark"] .nexus-swipe-back-indicator {
    background: var(--color-slate-800);
    box-shadow:
        0 4px 20px var(--color-black-alpha-30),
        0 0 0 1px var(--color-white-alpha-10);
}

.nexus-swipe-back-indicator.visible {
    opacity: 1;
}

.nexus-swipe-back-indicator.ready {
    background: linear-gradient(135deg, var(--color-primary-500), var(--color-purple-500));
    box-shadow:
        0 4px 24px var(--color-indigo-alpha-40),
        0 0 0 4px var(--color-indigo-alpha-10);
}

.nexus-swipe-back-indicator.ready i {
    color: white;
}

.nexus-swipe-back-indicator.navigating {
    background: linear-gradient(135deg, var(--color-primary-500), var(--color-purple-500));
    transition: transform var(--transition-fast) var(--ease-out);
}

.nexus-swipe-back-indicator i {
    color: var(--color-primary-500);
    font-size: var(--font-size-lg);
    transition: color var(--transition-fast) var(--ease-in-out);
}

[data-theme="dark"] .nexus-swipe-back-indicator i {
    color: var(--color-primary-400);
}

/* Swipe-back page overlay */
.nexus-swipe-back-overlay {
    position: fixed;
    inset: 0;
    background: black;
    opacity: 0;
    z-index: var(--z-modal-backdrop, 1300);
    pointer-events: none;
    transition: opacity var(--transition-fast) var(--ease-in-out);
}

.nexus-swipe-back-overlay.visible {
    /* Opacity controlled by JS */
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
    .nexus-swipe-back-indicator {
        transition: opacity var(--transition-fast);
    }

    .nexus-swipe-back-overlay {
        transition: none;
    }
}

/* Swipeable list items */
.nexus-swipe-item {
    position: relative;
    overflow: hidden;
    touch-action: pan-x;
}

.nexus-swipe-item-content {
    position: relative;
    background: white;
    transition: transform var(--transition-fast);
    z-index: 2;
}

[data-theme="dark"] .nexus-swipe-item-content {
    background: var(--color-slate-800);
}

.nexus-swipe-item-actions {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: stretch;
    z-index: 1;
}

.nexus-swipe-action {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 var(--space-5);
    color: white;
    font-weight: 600;
    font-size: var(--font-size-sm);
}

.nexus-swipe-action.delete {
    background: var(--color-danger);
}

.nexus-swipe-action.archive {
    background: var(--color-warning);
}

.nexus-swipe-action.edit {
    background: var(--color-primary-500);
}


/* ============================================
   6. ENHANCED TOUCH FEEDBACK
   ============================================ */

/* Disable tap highlight */
* {
    -webkit-tap-highlight-color: transparent;
}

/* Touch-friendly hover states */
@media (hover: none) and (pointer: coarse) {

    .htb-btn:hover,
    .htb-card:hover {
        transform: none;
        box-shadow: inherit;
    }
}

/* Active states for touch */
.nexus-touch-active {
    transform: scale(0.98);
    opacity: 0.9;
}

/* Pressable items */
.nexus-pressable {
    cursor: pointer;
    transition: transform 0.1s, opacity var(--transition-fast);
    -webkit-user-select: none;
    user-select: none;
}

.nexus-pressable:active {
    transform: scale(0.97);
    opacity: 0.85;
}


/* ============================================
   7. NATIVE SCROLL BEHAVIOR
   ============================================ */

/* Momentum scrolling */
.nexus-scroll {
    overflow-y: auto;
    overscroll-behavior-y: contain;
}

/* Hide scrollbars on mobile but keep functionality */
.nexus-scroll-hidden::-webkit-scrollbar {
    display: none;
}

.nexus-scroll-hidden {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

/* Smooth scroll for anchor links */
html {
    scroll-behavior: smooth;
}

@media (prefers-reduced-motion: reduce) {
    html {
        scroll-behavior: auto;
    }

    .skeleton {
        animation: none;
    }
}


/* ============================================
   8. FLOATING ACTION BUTTON ENHANCEMENTS
   ============================================ */

/* Move FAB above bottom nav on mobile */
@media (max-width: 768px) {

    .home-fab,
    .wallet-fab,
    .groups-fab,
    .profile-fab,
    .messages-fab,
    .dash-fab {
        bottom: calc(80px + env(safe-area-inset-bottom)) !important;
    }
}


/* ============================================
   9. TOAST NOTIFICATIONS
   ============================================ */

.nexus-toast-container {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    z-index: var(--z-dropdown, 1000);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    pointer-events: none;
}

@media (max-width: 768px) {
    .nexus-toast-container {
        bottom: calc(90px + env(safe-area-inset-bottom));
    }
}

.nexus-toast {
    background: var(--color-slate-900-alpha-95);
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    color: white;
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    font-weight: 500;
    box-shadow: 0 10px 40px var(--color-black-alpha-30);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    animation: toast-in var(--transition-base) var(--ease-out);
    pointer-events: auto;
}

.nexus-toast.success {
    background: var(--color-emerald-alpha-95);
}

.nexus-toast.error {
    background: var(--color-red-alpha-95);
}

.nexus-toast.warning {
    background: var(--color-amber-500-alpha-95);
}

.nexus-toast.exit {
    animation: toast-out var(--transition-fast) ease-out forwards;
}

@keyframes toast-in {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.9);
    }

    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes toast-out {
    from {
        opacity: 1;
        transform: translateY(0) scale(1);
    }

    to {
        opacity: 0;
        transform: translateY(-10px) scale(0.9);
    }
}


/* ============================================
   10. LOADING OVERLAY
   ============================================ */

.nexus-loading-overlay {
    position: fixed;
    inset: 0;
    background: var(--color-white-alpha-90);
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-fast);
}

[data-theme="dark"] .nexus-loading-overlay {
    background: var(--color-slate-900-alpha-90);
}

.nexus-loading-overlay.visible {
    opacity: 1;
    visibility: visible;
}

.nexus-loading-spinner {
    width: var(--space-12);
    height: var(--space-12);
    border: 4px solid var(--color-indigo-alpha-20);
    border-top-color: var(--color-primary-500);
    border-radius: var(--radius-full);
    animation: loading-spin var(--transition-slow) linear infinite;
}

.nexus-loading-text {
    margin-top: var(--space-4);
    color: var(--color-slate-500);
    font-weight: 500;
}

@keyframes loading-spin {
    to {
        transform: rotate(360deg);
    }
}


/* ============================================
   11. NATIVE SHARE SHEET
   ============================================ */

.nexus-share-sheet {
    position: fixed;
    inset: 0;
    z-index: var(--z-modal-backdrop, 1300);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-base) var(--ease-in-out);
}

.nexus-share-sheet.active {
    opacity: 1;
    visibility: visible;
}

.nexus-share-sheet-backdrop {
    position: absolute;
    inset: 0;
    background: var(--color-black-alpha-50);
    -webkit-backdrop-filter: blur(4px);
    backdrop-filter: blur(4px);
}

.nexus-share-sheet-content {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    transform: translateY(100%);
    transition: transform var(--transition-base) var(--ease-in-out);
    padding-bottom: env(safe-area-inset-bottom);
}

.nexus-share-sheet.active .nexus-share-sheet-content {
    transform: translateY(0);
}

[data-theme="dark"] .nexus-share-sheet-content {
    background: var(--color-slate-800);
}

.nexus-share-sheet-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--color-black-alpha-10);
}

.nexus-share-sheet-header h3 {
    margin: 0;
    font-size: var(--font-size-lg);
    font-weight: 700;
}

.nexus-share-close {
    width: var(--space-8);
    height: var(--space-8);
    border-radius: var(--radius-full);
    background: var(--color-black-alpha-5);
    border: none;
    font-size: var(--font-size-xl);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

[data-theme="dark"] .nexus-share-close {
    background: var(--color-white-alpha-10);
    color: white;
}

.nexus-share-sheet-body {
    padding: var(--space-5);
}

.nexus-share-options {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
}

.nexus-share-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-4) var(--space-2);
    border: none;
    background: var(--color-black-alpha-3);
    border-radius: var(--radius-lg);
    text-decoration: none;
    color: inherit;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.nexus-share-option:active {
    transform: scale(0.95);
    background: var(--color-indigo-alpha-10);
}

.nexus-share-option i {
    font-size: var(--font-size-2xl);
    width: var(--space-12);
    height: var(--space-12);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, var(--color-primary-500), var(--color-purple-500));
    color: white;
}

.nexus-share-option:nth-child(2) i {
    background: #1877f2;
}

.nexus-share-option:nth-child(3) i {
    background: var(--color-black);
}

.nexus-share-option:nth-child(4) i {
    background: #25d366;
}

.nexus-share-option:nth-child(5) i {
    background: linear-gradient(135deg, var(--color-danger), var(--color-orange-500));
}

.nexus-share-option span {
    font-size: var(--font-size-xs);
    font-weight: 600;
    text-align: center;
}

[data-theme="dark"] .nexus-share-option {
    background: var(--color-white-alpha-5);
    color: white;
}


/* ============================================
   12. CAMERA CAPTURE UI
   ============================================ */

.nexus-camera-ui {
    position: fixed;
    inset: 0;
    z-index: var(--z-modal, 1400);
    background: var(--color-black);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-base) var(--ease-in-out);
}

.nexus-camera-ui.active {
    opacity: 1;
    visibility: visible;
}

.nexus-camera-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.nexus-camera-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.nexus-camera-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: var(--space-8) var(--space-10);
    padding-bottom: calc(30px + env(safe-area-inset-bottom));
    background: linear-gradient(transparent, var(--color-black-alpha-70));
}

.nexus-camera-btn {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-full);
    border: none;
    background: var(--color-white-alpha-20);
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    color: white;
    font-size: var(--font-size-xl);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
}

.nexus-camera-btn:active {
    transform: scale(0.9);
}

.nexus-camera-capture {
    width: 72px;
    height: 72px;
    background: white;
    color: var(--color-gray-800);
    font-size: var(--font-size-2xl);
    box-shadow: 0 4px 20px var(--color-black-alpha-30);
}

.nexus-camera-capture:active {
    background: var(--color-gray-200);
}

.nexus-camera-preview {
    position: absolute;
    inset: 0;
    background: var(--color-black);
    display: none;
    flex-direction: column;
}

.nexus-camera-preview-img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.nexus-camera-preview-actions {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    gap: var(--space-5);
    padding: var(--space-8);
    padding-bottom: calc(30px + env(safe-area-inset-bottom));
    background: linear-gradient(transparent, var(--color-black-alpha-80));
}

.nexus-camera-preview-actions .nexus-camera-btn {
    width: auto;
    padding: var(--space-3) 28px;
    border-radius: var(--radius-md);
    gap: var(--space-2);
    font-size: var(--font-size-base);
    font-weight: 600;
}

.nexus-camera-preview-actions .nexus-camera-btn.primary {
    background: linear-gradient(135deg, var(--color-primary-500), var(--color-purple-500));
}


/* ============================================
   13. TURBO PROGRESS BAR
   ============================================ */

#nexus-turbo-progress {
    position: fixed;
    top: 0;
    left: 0;
    width: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--color-primary-500), var(--color-purple-500), var(--color-pink-500));
    z-index: var(--z-notification, 1700);
    transition: width var(--transition-fast) var(--ease-out);
    box-shadow: 0 0 10px var(--color-indigo-alpha-50);
    pointer-events: none;
}

#nexus-turbo-progress.active {
    animation: turboProgress 2s ease-in-out infinite;
}

@keyframes turboProgress {
    0% {
        width: 0;
    }

    50% {
        width: 70%;
    }

    100% {
        width: 90%;
    }
}


/* ============================================
   14. ENHANCED TAP FEEDBACK
   ============================================ */

.nexus-ripple {
    position: relative;
    overflow: hidden;
}

.nexus-ripple::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: var(--color-white-alpha-30);
    border-radius: var(--radius-full);
    transform: translate(-50%, -50%);
    opacity: 0;
}

.nexus-ripple:active::after {
    width: 200%;
    padding-bottom: 200%;
    opacity: 1;
    transition: all var(--transition-slow) var(--ease-out);
}


/* ============================================
   INFINITE SCROLL
   ============================================ */

.nexus-infinite-loader {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    padding: var(--space-6);
    color: var(--color-slate-500);
    font-size: var(--font-size-sm);
}

[data-theme="dark"] .nexus-infinite-loader {
    color: var(--color-slate-400);
}

.nexus-infinite-spinner {
    width: var(--space-6);
    height: var(--space-6);
    border: 3px solid var(--color-indigo-alpha-20);
    border-top-color: var(--color-primary-500);
    border-radius: var(--radius-full);
    animation: infinite-spin var(--transition-slow) linear infinite;
}

@keyframes infinite-spin {
    to {
        transform: rotate(360deg);
    }
}

.nexus-infinite-end {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-8) var(--space-6);
    color: var(--color-slate-400);
    font-size: var(--font-size-sm);
    text-align: center;
}

[data-theme="dark"] .nexus-infinite-end {
    color: var(--color-slate-500);
}

.nexus-infinite-end::before,
.nexus-infinite-end::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--color-slate-400-alpha-30), transparent);
    margin: 0 var(--space-4);
}


/* ============================================
   LONG-PRESS CONTEXT MENU
   ============================================ */

.nexus-context-backdrop {
    position: fixed;
    inset: 0;
    background: var(--color-black-alpha-40);
    opacity: 0;
    visibility: hidden;
    z-index: 99998;
    transition: opacity var(--transition-fast) var(--ease-in-out), visibility var(--transition-fast) var(--ease-in-out);
    -webkit-backdrop-filter: blur(2px);
    backdrop-filter: blur(2px);
}

.nexus-context-backdrop.visible {
    opacity: 1;
    visibility: visible;
}

.nexus-context-menu {
    position: fixed;
    min-width: 200px;
    max-width: 280px;
    background: white;
    border-radius: var(--radius-md);
    box-shadow:
        0 10px 40px var(--color-black-alpha-20),
        0 0 0 1px var(--color-black-alpha-5);
    z-index: var(--z-notification, 1700);
    opacity: 0;
    visibility: hidden;
    transform: scale(0.9);
    transform-origin: center center;
    transition: opacity var(--transition-fast) var(--ease-in-out), transform var(--transition-fast) cubic-bezier(0.34, 1.56, 0.64, 1), visibility var(--transition-fast) var(--ease-in-out);
    overflow: hidden;
}

[data-theme="dark"] .nexus-context-menu {
    background: var(--color-slate-800);
    box-shadow:
        0 10px 40px var(--color-black-alpha-40),
        0 0 0 1px var(--color-white-alpha-10);
}

.nexus-context-menu.visible {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
}

.nexus-context-item {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    width: 100%;
    padding: var(--space-3) var(--space-4);
    border: none;
    background: transparent;
    color: var(--color-slate-800);
    font-size: var(--font-size-base);
    font-weight: 500;
    text-align: left;
    cursor: pointer;
    transition: background var(--transition-fast) var(--ease-in-out);
}

[data-theme="dark"] .nexus-context-item {
    color: var(--color-slate-100);
}

.nexus-context-item:not(:last-child) {
    border-bottom: 1px solid var(--color-black-alpha-6);
}

[data-theme="dark"] .nexus-context-item:not(:last-child) {
    border-bottom-color: var(--color-white-alpha-6);
}

.nexus-context-item:active {
    background: var(--color-indigo-alpha-10);
}

[data-theme="dark"] .nexus-context-item:active {
    background: var(--color-indigo-alpha-20);
}

.nexus-context-item i {
    width: var(--space-5);
    text-align: center;
    color: var(--color-primary-500);
    font-size: var(--font-size-base);
}

[data-theme="dark"] .nexus-context-item i {
    color: var(--color-primary-400);
}

.nexus-context-item.danger {
    color: var(--color-danger);
}

.nexus-context-item.danger i {
    color: var(--color-danger);
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
    .nexus-context-menu {
        transition: opacity var(--transition-fast) var(--ease-in-out), visibility var(--transition-fast) var(--ease-in-out);
        transform: scale(1);
    }

    .nexus-context-backdrop {
        transition: opacity var(--transition-fast) var(--ease-in-out), visibility var(--transition-fast) var(--ease-in-out);
    }

    .nexus-infinite-spinner {
        animation-duration: 1.5s;
    }
}

/* Material-style ripple for buttons */
.htb-btn,
.nexus-bottom-nav-item,
.nexus-fab-item,
.nexus-share-option {
    position: relative;
    overflow: hidden;
}

@media (hover: none) and (pointer: coarse) {

    .htb-btn:active,
    .nexus-bottom-nav-item:active {
        transform: scale(0.97);
    }
}


/* ============================================
   15. OFFLINE/ONLINE INDICATORS
   ============================================ */

.nexus-offline-indicator {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, var(--color-warning) 0%, var(--color-amber-600) 100%);
    color: white;
    text-align: center;
    padding: var(--space-3) var(--space-4);
    font-size: 13px;
    font-weight: 600;
    z-index: var(--z-popover, 1500);
    transform: translateY(-100%);
    transition: transform var(--transition-base) cubic-bezier(0.68, -0.55, 0.265, 1.55);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding-top: max(var(--space-3), env(safe-area-inset-top));
}

.nexus-offline-indicator.visible {
    transform: translateY(0);
}

.nexus-offline-indicator svg {
    width: var(--space-4);
    height: var(--space-4);
    flex-shrink: 0;
}

/* Adjust content when offline banner is visible */
body.is-offline .nexus-utility-bar,
body.is-offline .htb-header,
body.is-offline header {
    margin-top: var(--space-10);
}

.nexus-online-indicator {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, var(--color-success) 0%, var(--color-green-600) 100%);
    color: white;
    text-align: center;
    padding: var(--space-3) var(--space-4);
    font-size: 13px;
    font-weight: 600;
    z-index: var(--z-popover, 1500);
    transform: translateY(-100%);
    transition: transform var(--transition-base) cubic-bezier(0.68, -0.55, 0.265, 1.55);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding-top: max(var(--space-3), env(safe-area-inset-top));
}

.nexus-online-indicator.visible {
    transform: translateY(0);
}

.nexus-online-indicator svg {
    width: var(--space-4);
    height: var(--space-4);
    flex-shrink: 0;
}

@media (prefers-reduced-motion: reduce) {

    .nexus-offline-indicator,
    .nexus-online-indicator {
        transition: none;
    }
}


/* ============================================
   16. COLLAPSING HEADER ON SCROLL
   ============================================ */

/* Base collapsing header styles */
.nexus-collapsing-header {
    position: sticky;
    top: 0;
    z-index: 1000;
    transition: transform var(--transition-base) var(--ease-in-out),
        height var(--transition-base) var(--ease-in-out),
        padding var(--transition-base) var(--ease-in-out),
        box-shadow var(--transition-base) var(--ease-in-out);
    will-change: transform;
}

/* Hidden state - slides up */
.nexus-collapsing-header.nexus-header-hidden {
    transform: translateY(-100%);
    pointer-events: none;
}

/* Visible state after being hidden - smooth slide down */
.nexus-collapsing-header.nexus-header-visible {
    transform: translateY(0);
    pointer-events: auto;
    box-shadow: 0 2px 20px var(--color-black-alpha-10);
}

[data-theme="dark"] .nexus-collapsing-header.nexus-header-visible {
    box-shadow: 0 2px 20px var(--color-black-alpha-30);
}

/* Compact mode - smaller, more minimal */
.nexus-collapsing-header.nexus-header-compact {
    padding-top: var(--space-2);
    padding-bottom: var(--space-2);
}

/* Compact mode for common header elements */
.nexus-collapsing-header.nexus-header-compact .htb-header-title,
.nexus-collapsing-header.nexus-header-compact .header-title,
.nexus-collapsing-header.nexus-header-compact h1 {
    font-size: var(--font-size-lg);
    margin: 0 !important;
}

.nexus-collapsing-header.nexus-header-compact .htb-header-subtitle,
.nexus-collapsing-header.nexus-header-compact .header-subtitle {
    display: none !important;
}

/* Hide secondary elements in compact mode */
.nexus-collapsing-header.nexus-header-compact .header-description,
.nexus-collapsing-header.nexus-header-compact .header-meta,
.nexus-collapsing-header.nexus-header-compact .htb-breadcrumb {
    display: none !important;
}

/* Shrink avatars/logos in compact mode */
.nexus-collapsing-header.nexus-header-compact .header-avatar,
.nexus-collapsing-header.nexus-header-compact .header-logo,
.nexus-collapsing-header.nexus-header-compact .htb-avatar {
    width: 32px !important;
    height: 32px !important;
    transition: all var(--transition-base) var(--ease-in-out);
}

/* Reduce button sizes in compact mode */
.nexus-collapsing-header.nexus-header-compact .htb-btn {
    padding: var(--space-1) var(--space-3) !important;
    font-size: var(--font-size-sm);
}

/* Add shadow in compact mode for visual separation */
.nexus-collapsing-header.nexus-header-compact {
    box-shadow: 0 2px 12px var(--color-black-alpha-8);
}

[data-theme="dark"] .nexus-collapsing-header.nexus-header-compact {
    box-shadow: 0 2px 12px var(--color-black-alpha-25);
}

/* Body adjustments when header is hidden */
body.nexus-header-is-hidden {
    /* Content can flow naturally when header is hidden */
}

/* Body adjustments when header is compact */
body.nexus-header-is-compact {
    /* Content area gains more space */
}

/* Mobile-specific optimizations */
@media (max-width: 768px) {
    .nexus-collapsing-header {
        /* Faster transitions on mobile for snappier feel */
        transition: transform var(--transition-base) var(--ease-in-out),
            height var(--transition-base) var(--ease-in-out),
            padding var(--transition-base) var(--ease-in-out),
            box-shadow var(--transition-base) var(--ease-in-out);
    }

    .nexus-collapsing-header.nexus-header-compact {
        padding-top: 6px !important;
        padding-bottom: 6px !important;
    }

    .nexus-collapsing-header.nexus-header-compact .htb-header-title,
    .nexus-collapsing-header.nexus-header-compact h1 {
        font-size: var(--font-size-base);
    }

    /* Reduce icon sizes in compact mode on mobile */
    .nexus-collapsing-header.nexus-header-compact .htb-btn i,
    .nexus-collapsing-header.nexus-header-compact .header-icon {
        font-size: var(--font-size-base);
    }
}

/* Reduced motion preference */
@media (prefers-reduced-motion: reduce) {
    .nexus-collapsing-header {
        transition: none;
    }

    .nexus-collapsing-header.nexus-header-hidden {
        opacity: 0;
        transform: none;
    }

    .nexus-collapsing-header.nexus-header-visible {
        opacity: 1;
        transform: none;
    }

    .nexus-collapsing-header.nexus-header-compact .header-avatar,
    .nexus-collapsing-header.nexus-header-compact .header-logo,
    .nexus-collapsing-header.nexus-header-compact .htb-avatar {
        transition: none;
    }
}

/* Utility class - add to any header to enable collapsing */
[data-collapsing-header="true"] {
    /* Marker for JS initialization */
}

/* ============================================
   MOBILE SUB-PAGE TOP SPACING FIX
   Uniform spacing across all about sub-pages
   ============================================ */
@media (max-width: 900px) {

    /* All glass wrappers - consistent top spacing (56px clears mobile header) */
    #strategy-glass-wrapper,
    #faq-glass-wrapper,
    #sp-glass-wrapper,
    #guide-glass-wrapper,
    #story-glass-wrapper,
    #partner-glass-wrapper,
    #impact-glass-wrapper,
    #report-glass-wrapper,
    #privacy-glass-wrapper,
    #terms-glass-wrapper,
    [id$="-glass-wrapper"],
    [id*="glass-wrapper"] {
        margin-top: var(--layout-header-height) !important;
        padding-top: var(--space-4);
    }

    /* Container full - uniform spacing */
    .htb-container-full {
        padding-top: var(--space-4);
        margin-top: var(--layout-header-height) !important;
    }

    /* Welcome hero sections - uniform top margin */
    .nexus-welcome-hero {
        margin-top: 0 !important;
    }

    /* Inner wrappers - no extra padding */
    .faq-inner,
    .sp-inner,
    .impact-inner,
    [class$="-inner"] {
        padding-top: 0 !important;
    }

    /* Page headers - consistent spacing */
    .page-header,
    .faq-page-header,
    .sp-page-header,
    .strategy-page-header,
    [class$="-page-header"],
    [id$="-glass-wrapper"] .page-header,
    .htb-container .page-header,
    .htb-container-full .page-header {
        margin-top: 0 !important;
        margin-bottom: var(--space-4);
        padding-top: 0 !important;
    }

    /* Compact hero sections on mobile sub-pages */
    .htb-hero-header {
        height: auto !important;
        min-height: 120px !important;
        padding: var(--space-5) var(--space-4) !important;
    }

    .htb-hero-content {
        padding: var(--space-3) var(--space-4) !important;
    }

    .htb-main-title {
        font-size: var(--font-size-3xl);
    }

    .htb-sub-title {
        font-size: var(--font-size-base);
    }

    /* Cards that pull up into hero area */
    .htb-container[style*="margin-top: -80px"],
    .htb-container-full[style*="margin-top: -80px"] {
        margin-top: var(--space-4);
    }

    /* Generic first-child content spacing */
    .htb-container>*:first-child,
    .htb-container-full>*:first-child {
        margin-top: 0;
    }
}