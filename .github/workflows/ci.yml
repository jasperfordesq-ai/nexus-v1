name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'

jobs:
  # ─────────────────────────────────────────────────────────────────
  # Stage 1: PHP Checks (syntax + unit tests + service tests)
  # ─────────────────────────────────────────────────────────────────
  php-checks:
    name: PHP Checks
    runs-on: ubuntu-latest

    services:
      mariadb:
        image: mariadb:10.11
        env:
          MYSQL_ROOT_PASSWORD: testing
          MYSQL_DATABASE: nexus_test
          MYSQL_USER: nexus
          MYSQL_PASSWORD: nexus_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="healthcheck.sh --connect --innodb_initialized"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo_mysql, mbstring, xml, zip, redis, gd, intl, bcmath, opcache, curl, fileinfo
          coverage: none

      - name: Cache Composer Dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: composer-

      - name: Install Dependencies
        run: composer install --no-interaction --prefer-dist

      - name: PHP Syntax Check
        run: |
          echo "Checking PHP syntax in src/ ..."
          ERRORS=$(find src -name "*.php" -print0 | xargs -0 -n1 php -l 2>&1 | grep -c "Parse error" || true)
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Found $ERRORS PHP syntax error(s):"
            find src -name "*.php" -print0 | xargs -0 -n1 php -l 2>&1 | grep "Parse error"
            exit 1
          fi
          echo "All PHP files passed syntax check."

      - name: PHPUnit Unit Tests (BLOCKING)
        run: vendor/bin/phpunit --testsuite=Unit
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: nexus_test
          DB_USER: nexus
          DB_PASS: nexus_test
          REDIS_HOST: 127.0.0.1
          APP_ENV: testing

      - name: PHPUnit Service Tests (BLOCKING)
        run: vendor/bin/phpunit --testsuite=Services
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: nexus_test
          DB_USER: nexus
          DB_PASS: nexus_test
          REDIS_HOST: 127.0.0.1
          APP_ENV: testing

  # ─────────────────────────────────────────────────────────────────
  # Stage 2: React Frontend (TypeScript + Vitest + Build)
  # ─────────────────────────────────────────────────────────────────
  react-build:
    name: React Build & Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: react-frontend/package-lock.json

      - name: Install Dependencies
        working-directory: react-frontend
        run: npm ci

      - name: TypeScript Check (BLOCKING)
        working-directory: react-frontend
        run: npx tsc --noEmit

      - name: Vitest Unit Tests (BLOCKING)
        working-directory: react-frontend
        run: npm test -- --run

      - name: Build Production Bundle (BLOCKING)
        working-directory: react-frontend
        run: npm run build
        env:
          VITE_API_BASE: /api

  # ─────────────────────────────────────────────────────────────────
  # Stage 3: Docker Build Verification
  # ─────────────────────────────────────────────────────────────────
  docker-verify:
    name: Docker Build Verify
    runs-on: ubuntu-latest
    needs: [php-checks, react-build]

    steps:
      - uses: actions/checkout@v4

      - name: Build PHP Container
        run: docker build --no-cache -f Dockerfile -t nexus-php-test:ci .

      - name: Build Production PHP Container
        run: docker build --no-cache -f Dockerfile.prod -t nexus-php-prod-test:ci .

      - name: Build React Frontend Container
        working-directory: react-frontend
        run: |
          if [ -f Dockerfile.prod ]; then
            docker build --no-cache -f Dockerfile.prod --build-arg VITE_API_BASE=/api -t nexus-react-test:ci .
          elif [ -f Dockerfile ]; then
            docker build --no-cache -f Dockerfile -t nexus-react-test:ci .
          fi

      - name: Verify PHP Container Starts
        run: |
          docker run -d --name php-test nexus-php-prod-test:ci
          sleep 5
          docker exec php-test curl -sf http://localhost/health.php || echo "::warning::Health check failed"
          docker stop php-test

  # ─────────────────────────────────────────────────────────────────
  # Stage 4: Dockerfile Drift Detection
  # ─────────────────────────────────────────────────────────────────
  dockerfile-drift:
    name: Dockerfile Drift Detection
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Compare PHP settings between Dockerfile and Dockerfile.prod
        run: |
          echo "========================================="
          echo "Dockerfile Drift Detection"
          echo "========================================="
          echo ""

          SETTINGS="upload_max_filesize post_max_size max_execution_time max_input_time max_input_vars memory_limit"
          DRIFT_FOUND=0

          for SETTING in $SETTINGS; do
            # Extract value from Dockerfile (dev)
            DEV_VALUE=$(grep -oP "${SETTING}\s*=\s*\K[^\s\\\\]+" Dockerfile || echo "NOT_SET")
            # Extract value from Dockerfile.prod
            PROD_VALUE=$(grep -oP "${SETTING}\s*=\s*\K[^\s\\\\]+" Dockerfile.prod || echo "NOT_SET")

            if [ "$DEV_VALUE" != "$PROD_VALUE" ]; then
              echo "::error::DRIFT DETECTED: ${SETTING} differs between Dockerfile (${DEV_VALUE}) and Dockerfile.prod (${PROD_VALUE})"
              DRIFT_FOUND=1
            else
              echo "OK: ${SETTING} = ${DEV_VALUE} (both files match)"
            fi
          done

          echo ""
          if [ "$DRIFT_FOUND" -eq 1 ]; then
            echo "========================================="
            echo "FAILURE: Dockerfile settings have drifted!"
            echo "Update both Dockerfile and Dockerfile.prod to keep PHP settings in sync."
            echo "========================================="
            exit 1
          else
            echo "========================================="
            echo "SUCCESS: All tracked PHP settings match."
            echo "========================================="
          fi

  # ─────────────────────────────────────────────────────────────────
  # Stage 5: Regression Pattern Detection
  # ─────────────────────────────────────────────────────────────────
  regression-patterns:
    name: Regression Pattern Detection
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: "BLOCKING: Check for incorrect API response unwrapping (data.data ??)"
        run: |
          echo "Checking for 'data.data ??' pattern in React source..."
          echo "(This pattern causes ErrorBoundary crashes — must use 'data' in data ? data.data : data)"
          echo ""

          MATCHES=$(grep -rn "data\.data ??" react-frontend/src/ || true)

          if [ -n "$MATCHES" ]; then
            echo "::error::REGRESSION DETECTED: Found 'data.data ??' pattern (incorrect API response unwrapping)."
            echo ""
            echo "Offending files:"
            echo "$MATCHES"
            echo ""
            echo "Fix: Use \"'data' in data ? data.data : data\" instead of \"data.data ?? data\""
            exit 1
          fi

          echo "PASS: No incorrect 'data.data ??' patterns found."

      - name: "WARNING: Count 'as any' type assertions"
        run: |
          echo "Counting 'as any' type assertions in React source..."
          echo ""

          COUNT=$(grep -rn "as any" react-frontend/src/ | wc -l || echo "0")
          COUNT=$(echo "$COUNT" | tr -d ' ')

          echo "Found ${COUNT} 'as any' assertion(s)."

          if [ "$COUNT" -gt 20 ]; then
            echo "::warning::TypeScript safety: Found ${COUNT} 'as any' assertions (threshold: 20). Consider reducing type assertion usage."
          else
            echo "PASS: 'as any' count (${COUNT}) is within acceptable threshold (<=20)."
          fi

      - name: "WARNING: Check for DELETE without tenant_id scoping"
        run: |
          echo "Checking for DELETE FROM statements without tenant_id in PHP source..."
          echo ""

          # Find DELETE FROM statements, then check if they lack tenant_id
          # We look for DELETE FROM in PHP files, excluding migrations and test files
          UNSCOPED=$(grep -rn "DELETE FROM" src/ \
            --include="*.php" \
            | grep -iv "tenant_id" \
            | grep -iv "migration" \
            | grep -iv "// " \
            | grep -iv "sessions" \
            | grep -iv "password_resets" \
            | grep -iv "cache" \
            | grep -iv "jobs" \
            | grep -iv "failed_jobs" \
            || true)

          if [ -n "$UNSCOPED" ]; then
            echo "::warning::Potential unscoped DELETE statements found (missing tenant_id). Review these carefully:"
            echo ""
            echo "$UNSCOPED"
            echo ""
            echo "If these tables are intentionally not tenant-scoped (e.g., sessions, cache), this warning can be ignored."
          else
            echo "PASS: All DELETE FROM statements appear to include tenant_id scoping."
          fi
