#!/bin/bash
# ===========================================
# Pre-Commit Hook: CSS File Tracking Check
# ===========================================
# Checks if new CSS files are tracked in purgecss.config.js
# Usage: Copy to .git/hooks/pre-commit or use git config core.hooksPath .githooks
# ===========================================

# Only run if CSS files are being committed
CSS_FILES=$(git diff --cached --name-only --diff-filter=A | grep '\.css$' | grep -v '\.min\.css$' | grep -v 'purged/' || true)

if [ -z "$CSS_FILES" ]; then
    # No new CSS files, skip check
    exit 0
fi

echo ""
echo "üîç Checking CSS file tracking..."
echo ""

# Run discovery check
REPORT=$(node scripts/discover-css.js 2>/dev/null)
MISSING=$(echo "$REPORT" | grep "Missing from config:" | grep -oE '[0-9]+')

if [ -n "$MISSING" ] && [ "$MISSING" -gt 0 ]; then
    echo "‚ö†Ô∏è  Warning: $MISSING CSS file(s) not tracked in purgecss.config.js"
    echo ""
    echo "$REPORT" | grep -A 20 "Files NOT in purgecss.config.js:" || true
    echo ""
    echo "These files won't be included in production builds!"
    echo ""
    echo "Options:"
    echo "  1. Run: npm run css:auto-config (auto-add all files)"
    echo "  2. Manually add to purgecss.config.js"
    echo "  3. Continue anyway (not recommended)"
    echo ""
    read -p "Continue commit? (y/n) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Commit cancelled."
        exit 1
    fi
fi

echo "‚úì CSS tracking check passed"
echo ""
exit 0
