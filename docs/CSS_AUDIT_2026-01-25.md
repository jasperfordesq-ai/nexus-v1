# CSS Architecture Audit - Project NEXUS
**Generated: 2026-01-25**

## Executive Summary

| Metric | Value |
|--------|-------|
| **Total CSS files** | 404 (.css) + 455 (.min.css) = 911 total |
| **Total size** | ~8.3 MB (unminified) |
| **CivicOne theme files** | 169 |
| **Modern theme files** | 18 |
| **Largest file** | `federation.css` (370 KB) |
| **Files < 2 KB** | 14 (consolidation candidates) |

---

## Critical Issues Requiring Attention

### 1. Deleted Files Still Referenced (BROKEN BUILD)

**purgecss.config.js references deleted files:**
- Line 122: `civicone-header.css` - FILE DELETED (replaced by v2)
- Line 175: `civicone-service-navigation.css` - FILE DELETED (integrated into header-v2)

**Impact:** PurgeCSS will fail or warn when run.

### 2. Double CSS Loading

**Problem:** CSS loaded in BOTH `<head>` AND `<body>`:
- `assets-css.php` loads CSS in `<head>`
- `body-open.php` loads SAME CSS files again in `<body>`

**Files loaded twice:**
- civicone-events.css
- civicone-profile.css
- civicone-groups.css
- civicone-utilities.css
- civicone-footer.css
- (and more)

**Impact:** Bandwidth waste, potential specificity conflicts.

### 3. PurgeCSS Over-Purging

**Many purged files are nearly empty (0-100 bytes):**
- `purged/auth.min.css` (7 bytes)
- `purged/biometric-modal.min.css` (0 bytes)
- `purged/blog-index.min.css` (0 bytes)
- `terms-page.min.css` (26 bytes from 21 KB source)

**Impact:** Missing styles in production.

---

## CSS Loading Architecture

### CivicOne Theme

**Entry Point:** `views/layouts/civicone/header.php`

**CSS Loaders:**
1. `views/layouts/civicone/partials/assets-css.php` (88 lines) - Main CSS loading
2. `views/layouts/civicone/partials/page-css-loader.php` (456 lines) - Conditional page CSS
3. `views/layouts/civicone/critical-css.php` (228 lines) - Inline critical CSS

**Load Order:**
1. Inline critical CSS (scroll fix)
2. design-tokens.css
3. layout-isolation.css
4. nexus-phoenix.css (core framework)
5. branding.css
6. nexus-civicone.css (theme override)
7. Mobile/native CSS
8. Page-specific CSS (via page-css-loader.php)
9. GOV.UK Frontend v5.14.0
10. Header v2, footer
11. scroll-fix-emergency.css (MUST BE LAST)

### Modern Theme

**Entry Point:** `views/layouts/modern/header.php`

**CSS Loaders:**
1. `views/layouts/modern/partials/css-loader.php` (217 lines) - Categorized CSS
2. `views/layouts/modern/partials/page-css-loader.php` (292 lines) - Conditional page CSS
3. `views/layouts/modern/critical-css.php` (100+ lines) - Inline critical CSS

**12 CSS Categories:**
1. CRITICAL CSS (sync, render-blocking)
2. HEADER & NAVIGATION (sync)
3. PAGE-SPECIFIC (conditional, loads last)
4. COMPONENTS (async)
5. UTILITIES (async)
6. MOBILE CSS (media query conditional)
7. DESKTOP CSS (media query conditional)
8. SHARED COMPONENTS (async)
9. UTILITIES & POLISH (async)
10. MODALS & OVERLAYS (async)
11. NATIVE APP CSS (async)
12. EMERGENCY OVERRIDES (must be last)

---

## File Inventory by Category

### Core/Framework (12 files)
| File | Size | Status |
|------|------|--------|
| design-tokens.css | 50 KB | PROTECTED from PurgeCSS |
| desktop-design-tokens.css | 13 KB | PROTECTED from PurgeCSS |
| mobile-design-tokens.css | 7.8 KB | PROTECTED from PurgeCSS |
| nexus-phoenix.css | 48 KB | Core framework |
| branding.css | 1.8 KB | Branding base |
| layout-isolation.css | 3.4 KB | CSS isolation |
| breakpoints.css | 4.5 KB | Responsive breakpoints |
| focus-rings.css | 10.7 KB | WCAG focus indicators |
| noscript-fallbacks.css | 3.9 KB | No-JS fallbacks |
| scroll-fix-emergency.css | 3.9 KB | MUST load last |
| theme-transitions.css | 13 KB | Theme switching |
| page-transitions.css | 10.5 KB | Page navigation |

### CivicOne Header/Navigation (14 files)
| File | Size | Status |
|------|------|--------|
| civicone-header-v2.css | 12 KB | **CURRENT** (replaces deleted header.css) |
| civicone-footer.css | 5.2 KB | Active |
| civicone-mobile-nav-v2.css | 20.7 KB | Active |
| civicone-mobile-nav-v2-inline.css | 4.1 KB | Active |
| civicone-account-nav.css | 4.6 KB | Active |
| civicone-breadcrumb.css | 1.7 KB | Active |
| civicone-layout-overrides.css | 2.5 KB | Active |
| civicone-govuk-navigation.css | 15.8 KB | Active |
| civicone-dev-banner.css | 10.1 KB | Active |
| civicone-impersonation-banner.css | 4.2 KB | Active |
| civicone-mobile.css | 37 KB | Active |
| civicone-native.css | 9.7 KB | Active |
| civicone-mobile-about.css | 22 KB | Active |
| nexus-civicone.css | 40 KB | Theme override |

### Large Files (> 50 KB) - Review Candidates
| File | Size | Notes |
|------|------|-------|
| federation.css | 370 KB | **LARGEST** - should split |
| modern-bundle-compiled.css | 280 KB | Compiled bundle |
| bundles/modern-pages.css | 230 KB | Page bundle |
| scattered-singles.css | 207 KB | **TRASH FILE** - needs audit |
| volunteering.css | 177 KB | Should split |
| bundles/civicone-govuk-all.css | 175 KB | GOV.UK bundle |
| bundles/civicone-modules.css | 170 KB | Module bundle |
| nexus-home.css | 141 KB | Home page |
| bundles/admin-core.css | 138 KB | Admin bundle |
| bundles/components-navigation.css | 126 KB | Nav components |
| modern/components-library.css | 113 KB | Component library |
| bundles/core.css | 113 KB | Core bundle |
| bundles/civicone-core.css | 110 KB | CivicOne core |
| static-pages.css | 104 KB | Static content |
| groups.css | 98 KB | Groups feature |
| achievements.css | 86 KB | Gamification |
| bundles/utilities-polish.css | 85 KB | Polish utilities |
| bundles/core-framework.css | 85.7 KB | Framework core |
| groups-show.css | 81.6 KB | Group detail |
| polls.css | 78.2 KB | Polls feature |
| listings-index.css | 73.9 KB | Listings |
| bundles/polish.css | 73.8 KB | Polish bundle |
| admin-gold-standard.css | 72.1 KB | Admin gold |
| civicone-govuk-components.css | 68.8 KB | GOV.UK components |
| civicone-federation.css | 67 KB | Federation |
| bundles/mobile.css | 64.2 KB | Mobile bundle |
| profile-holographic.css | 62.5 KB | Premium profile |
| goals.css | 61.8 KB | Goals feature |
| messages-index.css | 61.5 KB | Messages |
| organizations.css | 60.9 KB | Organizations |
| bundles/enhancements.css | 59 KB | Enhancements |
| resources.css | 56 KB | Resources |
| civicone-matches.css | 52.3 KB | Matches |
| bundles/civicone-profile-all.css | 51.8 KB | Profile bundle |

### Tiny Files (< 2 KB) - Consolidation Candidates
| File | Size | Notes |
|------|------|-------|
| civicone-skeleton-card.css | 329 B | 1 line only |
| civicone-blog-utilities.css | 403 B | ~2 lines |
| civicone-profile-edit.css | 902 B | Tiny |
| admin-menu-builder.css | 1.14 KB | Tiny |
| admin-menu-index.css | 1.49 KB | Tiny |
| civicone-skeleton-feed.css | 1.4 KB | Tiny |
| civicone-shared-accessibility-helpers.css | 1.6 KB | Tiny |
| civicone-breadcrumb.css | 1.7 KB | Tiny |
| branding.css | 1.8 KB | Core (keep) |
| civicone-groups-utilities.css | 1.8 KB | Tiny |
| civicone-faq.css | 1.9 KB | Tiny |
| civicone-volunteering-create-opp.css | 2 KB | Tiny |

### Duplicate/Experimental Files - Cleanup Needed
| File | Issue |
|------|-------|
| modern-experimental-banner.css | 3 versions exist (v1, v2, v3) |
| modern-experimental-banner-v2.css | Pick one, delete others |
| modern-experimental-banner-v3.css | Pick one, delete others |
| blog-show-temp.css | Temp file alongside blog-show.css |
| nexus-polish-temp.css | Temp file alongside nexus-polish.css |

### Legacy/Backup Files - Should Remove
| File | Notes |
|------|-------|
| civicone-members-directory-legacy-backup-2026-01-22.css | Dated backup |
| civicone-header.css.legacy-2026-01-25 | Old header backup |
| civicone-service-navigation.css.legacy-2026-01-25 | Old nav backup |
| *.legacy-* | Check if still needed |

---

## Page-Specific CSS Mapping

### CivicOne Routes → CSS Files

| Route Pattern | CSS Files Loaded |
|---------------|------------------|
| Home (`$isHome`) | feed-filter.css, civicone-home.css |
| `/dashboard` | dashboard.css, civicone-dashboard.css |
| `/members` | moj-filter.css, members-directory-v1.6.css, civicone-members-directory.css |
| `/login`, `/register`, `/password` | auth.css, civicone-auth.css |
| `/feed`, `/post` | civicone-feed.css, civicone-feed-item.css, civicone-feed-show.css |
| `/profile` | civicone-profile.css, civicone-profile-show.css, civicone-profile-edit.css |
| `/messages` | civicone-messages.css, civicone-messages-index.css |
| `/groups/*` | civicone-groups.css, civicone-groups-show.css, civicone-groups-discussions.css |
| `/events*` | civicone-events.css, civicone-events-calendar.css, civicone-events-show.css |
| `/listings*` | civicone-listings-directory.css |
| `/volunteering*` | civicone-volunteering.css, civicone-volunteering-create-opp.css |
| `/news`, `/blog` | civicone-blog.css |
| `/federation` | civicone-federation.css, civicone-federation-shell.css |
| `/goals/*`, `/polls/*` | civicone-goals-*.css, civicone-polls-edit.css |
| `/achievements` | civicone-achievements.css |
| `/master/*` | civicone-master-*.css |

### Modern Routes → CSS Files

| Route Pattern | CSS Files Loaded |
|---------------|------------------|
| Home (`$isHome`) | nexus-home.css, post-box-home.css, feed-filter.css, feed-empty-state.css, sidebar.css |
| `/dashboard` | dashboard.css, modern-dashboard.css |
| `/login`, `/register`, `/password` | auth.css |
| `/feed`, `/post`, `/profile` | post-card.css, feed-item.css, feed-page.css, feed-show.css |
| `/profile*` | profile-holographic.css, modern-profile-show.css, profile-edit.css |
| `/messages*` | messages-index.css, messages-thread.css |
| `/groups*` | groups-show.css, modern-groups-show.css, nexus-groups.css |
| `/events*` | events-index.css, events-calendar.css, events-show.css, modern-events-show.css |
| `/listings*` | listings-index.css, listings-show.css, listings-create.css |
| `/achievements*` | achievements.css |
| `/news`, `/blog` | blog-index.css, blog-show.css |
| `/search` | modern-search-results.css, search-results.css |
| `/settings` | modern-settings.css |
| `/volunteering*` | volunteering.css, modern-volunteering-show.css |

---

## Protected Files (DO NOT PURGE)

These files are excluded from PurgeCSS in `purgecss.config.js`:
- `design-tokens.css` / `design-tokens.min.css`
- `desktop-design-tokens.css` / `desktop-design-tokens.min.css`
- `mobile-design-tokens.css` / `mobile-design-tokens.min.css`

**Why:** PurgeCSS removes CSS variables (thinks they're unused classes). Never add these back to purgecss.config.js.

---

## Recommended Actions

### Immediate (Fix Broken Things)

1. **Remove deleted file references from purgecss.config.js**
   - Remove line 122: `civicone-header.css`
   - Remove line 175: `civicone-service-navigation.css`

2. **Fix body-open.php double-loading**
   - Remove duplicate CSS `<link>` tags that are already in assets-css.php
   - Or remove them from assets-css.php if body-open.php is the intended location

3. **Review PurgeCSS safelist**
   - Add classes that are dynamically generated or added via JS
   - Check why auth.css, blog files purge to near-zero

### Short-term (Reduce Chaos)

4. **Consolidate experimental files**
   - Pick one modern-experimental-banner version
   - Delete blog-show-temp.css and nexus-polish-temp.css (or merge into main)

5. **Delete legacy backups**
   - Remove dated backup files (civicone-members-directory-legacy-backup-2026-01-22.css)
   - Decide fate of .legacy-* files

6. **Audit scattered-singles.css (207 KB)**
   - This is a catch-all "trash" file
   - Extract needed styles to proper modules
   - Delete unused code

### Medium-term (Architecture Improvement)

7. **Split large files**
   - `federation.css` (370 KB) → by feature area
   - `volunteering.css` (177 KB) → by page
   - `nexus-home.css` (141 KB) → extract components

8. **Consolidate tiny files**
   - Merge 14 files < 2 KB into related components

9. **Balance theme coverage**
   - CivicOne has 169 files, Modern has 18
   - Audit which Modern pages lack styling

### Long-term (Sustainable Architecture)

10. **Establish naming convention**
    - `{theme}-{feature}-{page}.css`
    - Document what goes where

11. **Create CSS dependency documentation**
    - Which files depend on which
    - Load order requirements

12. **Implement CSS linting**
    - Prevent inline styles
    - Enforce design token usage

---

## Key File Locations

| Purpose | Path |
|---------|------|
| CSS Source Files | `/httpdocs/assets/css/` |
| CivicOne Theme CSS | `/httpdocs/assets/css/civicone-*.css` |
| Modern Theme CSS | `/httpdocs/assets/css/modern-*.css` |
| Compiled Bundles | `/httpdocs/assets/css/bundles/` |
| Purged Output | `/httpdocs/assets/css/purged/` |
| PurgeCSS Config | `/purgecss.config.js` |
| Minify Script | `/scripts/minify-css.js` |
| CivicOne CSS Loader | `/views/layouts/civicone/partials/assets-css.php` |
| CivicOne Page Loader | `/views/layouts/civicone/partials/page-css-loader.php` |
| Modern CSS Loader | `/views/layouts/modern/partials/css-loader.php` |
| Modern Page Loader | `/views/layouts/modern/partials/page-css-loader.php` |

---

## Build Commands

```bash
npm run build:css        # Build all CSS (includes validation)
npm run build:css:purge  # Run PurgeCSS
npm run minify:css       # Minify CSS files
npm run lint:css         # Lint CSS
npm run css:discover     # Find untracked CSS files
npm run css:auto-config  # Auto-add CSS to purgecss config
npm run validate:design-tokens  # Check design tokens aren't corrupted
```

---

*This audit should be updated whenever significant CSS changes are made.*
